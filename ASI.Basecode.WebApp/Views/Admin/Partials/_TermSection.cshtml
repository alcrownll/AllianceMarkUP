@using System

@{
    int yearLevel;
    if (ViewData["Year"] is int yi) yearLevel = yi;
    else if (ViewData["Year"] is long yl) yearLevel = (int)yl;
    else if (ViewData["Year"] is string ys && int.TryParse(ys, out var yp)) yearLevel = yp;
    else yearLevel = 1;

    var k1 = $"Y{yearLevel}T1";
    var k2 = $"Y{yearLevel}T2";
}

<div class="prospectus-term row g-3 align-items-stretch">
    <!-- 1st Semester -->
    <div class="col-12 col-xl-6 d-flex">
        <div class="card flex-fill">
            <div class="card-header d-flex justify-content-between align-items-center">
                <div class="fw-semibold">1st Semester</div>
                <div class="d-flex align-items-center gap-3 flex-nowrap">
                    <div class="small">Total Units: <span id="units-@k1">0</span></div>
                    <button type="button"
                            class="btn btn-sm btn-addcourse px-3"
                            data-action="open-course-picker"
                            data-year="@yearLevel" data-term="1" data-key="@k1">
                        Add Course
                    </button>
                </div>
            </div>

            <div class="card-body p-0">
                <div class="table-responsive prospectus-table">
                    <table class="table mb-0 align-middle">
                        <thead>
                            <tr>
                                <th style="width:18%">Course Code</th>
                                <th>Descriptive Title</th>
                                <th style="width:8%" class="text-center">Lec</th>
                                <th style="width:8%" class="text-center">Lab</th>
                                <th style="width:10%" class="text-center">Units</th>
                                <th style="width:18%">Pre-req</th>
                                <th style="width:10%"></th>
                            </tr>
                        </thead>
                        <tbody id="tbl-@k1" data-term-table data-year="@yearLevel" data-term="1">
                            <tr><td colspan="7" class="text-center text-muted py-4">No subjects yet.</td></tr>
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>

    <!-- 2nd Semester -->
    <div class="col-12 col-xl-6 d-flex">
        <div class="card flex-fill">
            <div class="card-header d-flex justify-content-between align-items-center">
                <div class="fw-semibold">2nd Semester</div>
                <div class="d-flex align-items-center gap-3 flex-nowrap">
                    <div class="small">Total Units: <span id="units-@k2">0</span></div>
                    <button type="button"
                            class="btn btn-sm btn-addcourse px-3"
                            data-action="open-course-picker"
                            data-year="@yearLevel" data-term="2" data-key="@k2">
                        Add Course
                    </button>
                </div>
            </div>

            <div class="card-body p-0">
                <div class="table-responsive prospectus-table">
                    <table class="table mb-0 align-middle">
                        <thead>
                            <tr>
                                <th style="width:18%">Course Code</th>
                                <th>Descriptive Title</th>
                                <th style="width:8%" class="text-center">Lec</th>
                                <th style="width:8%" class="text-center">Lab</th>
                                <th style="width:10%" class="text-center">Units</th>
                                <th style="width:18%">Pre-req</th>
                                <th style="width:10%"></th>
                            </tr>
                        </thead>
                        <tbody id="tbl-@k2" data-term-table data-year="@yearLevel" data-term="2">
                            <tr><td colspan="7" class="text-center text-muted py-4">No subjects yet.</td></tr>
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
    (function () {
      if (window.__termSectionBoundOnce) {
        try { window.recalcUnits?.('@k1'); window.recalcUnits?.('@k2'); } catch {}
        return;
      }
      window.__termSectionBoundOnce = true;

      try { window.recalcUnits?.('@k1'); window.recalcUnits?.('@k2'); } catch {}

      // Remove-row handler
      document.addEventListener('click', async (e) => {
        const btn = e.target.closest('button[data-remove]');
        if (!btn) return;
        if (btn.disabled) return;
        btn.disabled = true;

        const tr = btn.closest('tr[data-row="course"]');
        const tbody = btn.closest('tbody[data-term-table]');
        if (!tr || !tbody) { btn.disabled = false; return; }

        const id = tr.dataset.id;
        const year = Number(tbody.dataset.year || 0);
        const term = Number(tbody.dataset.term || 0);
        const key = `Y${year}T${term}`;
        const pid = (typeof getCurrentProgramId === 'function') ? getCurrentProgramId() : '';

        if (!id || !pid) {
          tr.remove(); window.recalcUnits?.(key); btn.disabled = false; return;
        }

        const token = document.querySelector('input[name="__RequestVerificationToken"]')?.value;
        const form = new URLSearchParams();
        if (token) form.set('__RequestVerificationToken', token);

        try {
          const res = await fetch(`/admin/programs/${pid}/term/item/${id}/remove`, {
            method: 'POST',
            headers: { 'Content-Type': 'application/x-www-form-urlencoded' },
            credentials: 'same-origin',
            body: form.toString()
          });
          if (!res.ok) {
            const msg = (await res.text()) || `Failed to remove (HTTP ${res.status}).`;
            alert(msg);
            if (res.status === 404) { tr.remove(); window.recalcUnits?.(key); }
            return;
          }
          tr.remove(); window.recalcUnits?.(key);
        } catch (err) {
          alert(err?.message || 'Network error while removing item.');
        } finally {
          btn.disabled = false;
        }
      });

      // Programmatic open for the Course Picker (prevents parent from closing)
      document.addEventListener('click', (e) => {
        const trigger = e.target.closest('[data-action="open-course-picker"]');
        if (!trigger) return;

        e.preventDefault();
        e.stopPropagation();

        const pickerEl = document.getElementById('coursePickerModal');
        if (!pickerEl) return;

        const yr = Number(trigger.getAttribute('data-year') || 1);
        const tm = Number(trigger.getAttribute('data-term') || 1);

        window.COURSE_PICK_TARGET = { year: yr, term: tm };

        const tgt = document.getElementById('stackTermTarget');
        if (tgt) tgt.textContent = `Year ${yr} — ${tm === 2 ? '2nd Sem' : '1st Sem'}`;

        const modal = bootstrap.Modal.getOrCreateInstance(pickerEl, { backdrop: 'static', keyboard: false });
        modal.show();
      });

    })();
</script>