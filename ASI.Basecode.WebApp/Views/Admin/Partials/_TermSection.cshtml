@using System

@{
    int y = 0;
    if (ViewData["Year"] is int yi) y = yi;
    else if (ViewData["Year"] is long yl) y = (int)yl;
    else if (ViewData["Year"] is string ys && int.TryParse(ys, out var yp)) y = yp;
    else y = DateTime.Now.Year;

    var k1 = $"Y{y}T1";
    var k2 = $"Y{y}T2";
}

<style>
    /* Stacked child modal */
    .modal-backdrop.stacked {
        z-index: 1060 !important;
    }

    #coursePickerModal {
        z-index: 1065 !important;
    }
</style>

<div class="row g-3 align-items-stretch">
    <!-- 1st Semester -->
    <div class="col-12 col-xl-6 d-flex">
        <div class="card flex-fill shadow-sm">
            <div class="card-header d-flex justify-content-between align-items-center">
                <div><strong>1st Semester</strong></div>
                <div class="d-flex align-items-center gap-3 flex-nowrap">
                    <div class="small text-muted">Total Units: <span id="units-@k1">0</span></div>
                    <button type="button"
                            class="btn btn-sm btn-primary"
                            data-bs-toggle="modal"
                            data-bs-target="#coursePickerModal"
                            data-year="@y" data-term="1" data-key="@k1">
                        Add Course
                    </button>
                </div>
            </div>

            <div class="card-body p-0">
                <div class="table-responsive prospectus-table">
                    <table class="table mb-0 align-middle">
                        <thead class="table-light">
                            <tr>
                                <th style="width:18%">Course Code</th>
                                <th>Descriptive Title</th>
                                <th style="width:8%" class="text-center">Lec</th>
                                <th style="width:8%" class="text-center">Lab</th>
                                <th style="width:10%" class="text-center">Units</th>
                                <th style="width:18%">Pre-req</th>
                                <th style="width:10%"></th>
                            </tr>
                        </thead>
                        <tbody id="tbl-@k1" data-term-table data-year="@y" data-term="1">
                            <tr><td colspan="7" class="text-center text-muted py-4">No subjects yet.</td></tr>
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>

    <!-- 2nd Semester -->
    <div class="col-12 col-xl-6 d-flex">
        <div class="card flex-fill shadow-sm">
            <div class="card-header d-flex justify-content-between align-items-center">
                <div><strong>2nd Semester</strong></div>
                <div class="d-flex align-items-center gap-3 flex-nowrap">
                    <div class="small text-muted">Total Units: <span id="units-@k2">0</span></div>
                    <button type="button"
                            class="btn btn-sm btn-primary"
                            data-bs-toggle="modal"
                            data-bs-target="#coursePickerModal"
                            data-year="@y" data-term="2" data-key="@k2">
                        Add Course
                    </button>
                </div>
            </div>

            <div class="card-body p-0">
                <div class="table-responsive prospectus-table">
                    <table class="table mb-0 align-middle">
                        <thead class="table-light">
                            <tr>
                                <th style="width:18%">Course Code</th>
                                <th>Descriptive Title</th>
                                <th style="width:8%" class="text-center">Lec</th>
                                <th style="width:8%" class="text-center">Lab</th>
                                <th style="width:10%" class="text-center">Units</th>
                                <th style="width:18%">Pre-req</th>
                                <th style="width:10%"></th>
                            </tr>
                        </thead>
                        <tbody id="tbl-@k2" data-term-table data-year="@y" data-term="2">
                            <tr><td colspan="7" class="text-center text-muted py-4">No subjects yet.</td></tr>
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
    (function () {
      // Prevent duplicate binding if this partial re-renders
      if (window.__termSectionBoundOnce) {
        try { window.recalcUnits?.('@k1'); window.recalcUnits?.('@k2'); } catch {}
        return;
      }
      window.__termSectionBoundOnce = true;

      try { window.recalcUnits?.('@k1'); window.recalcUnits?.('@k2'); } catch {}

      // Remove-row handler (server POST + UI update)
      document.addEventListener('click', async (e) => {
        const btn = e.target.closest('button[data-remove]');
        if (!btn) return;

        if (btn.disabled) return;
        btn.disabled = true;

        const tr = btn.closest('tr[data-row="course"]');
        const tbody = btn.closest('tbody[data-term-table]');
        if (!tr || !tbody) { btn.disabled = false; return; }

        const id = tr.dataset.id;
        const year = Number(tbody.dataset.year || 0);
        const term = Number(tbody.dataset.term || 0);
        const key = `Y${year}T${term}`;
        const pid = (typeof getCurrentProgramId === 'function') ? getCurrentProgramId() : '';

        if (!id || !pid) {
          tr.remove();
          window.recalcUnits?.(key);
          btn.disabled = false;
          return;
        }

        const token = document.querySelector('input[name="__RequestVerificationToken"]')?.value;
        const form = new URLSearchParams();
        if (token) form.set('__RequestVerificationToken', token);

        try {
          const res = await fetch(`/admin/programs/${pid}/term/item/${id}/remove`, {
            method: 'POST',
            headers: { 'Content-Type': 'application/x-www-form-urlencoded' },
            credentials: 'same-origin',
            body: form.toString()
          });

          if (!res.ok) {
            const msg = (await res.text()) || `Failed to remove (HTTP ${res.status}).`;
            alert(msg);
            if (res.status === 404) {
              tr.remove();
              window.recalcUnits?.(key);
            }
            return;
          }

          tr.remove();
          window.recalcUnits?.(key);
        } catch (err) {
          alert(err?.message || 'Network error while removing item.');
        } finally {
          btn.disabled = false;
        }
      });

      // Keep only target-setting + stacking tweaks here.
      const pickerEl = document.getElementById('coursePickerModal');
      if (pickerEl) {
        pickerEl.addEventListener('show.bs.modal', (e) => {
          const btn = e.relatedTarget; // the Add Course button
          window.COURSE_PICK_TARGET = {
            year: Number(btn?.getAttribute('data-year') || 1),
            term: Number(btn?.getAttribute('data-term') || 1)
          };

          const tgt = document.getElementById('stackTermTarget');
          if (tgt) {
            tgt.textContent = `Year ${window.COURSE_PICK_TARGET.year} — ` +
              (window.COURSE_PICK_TARGET.term === 2 ? '2nd Sem' : '1st Sem');
          }
        });

        pickerEl.addEventListener('shown.bs.modal', () => {
          const bds = document.querySelectorAll('.modal-backdrop');
          bds[bds.length - 1]?.classList.add('stacked');
          document.body.classList.add('modal-open');
        });

        pickerEl.addEventListener('hidden.bs.modal', () => {
          if (document.querySelector('.modal.show')) document.body.classList.add('modal-open');
        });
      }
    })();
</script>
