@* Views/Admin/Partials/_CourseFormModal.cshtml *@
<div class="modal fade" id="courseFormModal" tabindex="-1" aria-labelledby="courseFormLabel" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered modal-md">
        <div class="modal-content shadow-sm border-0 rounded-4">
            <div class="modal-header course-modal-header text-white">
                <h5 class="modal-title fw-semibold" id="courseFormLabel">
                    <i class="bi bi-journal-text me-2"></i> <span id="cfTitle">Add Course</span>
                </h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>

            <form id="courseForm" novalidate>
                <div class="modal-body p-4">
                    <p class="text-muted small mb-4" id="cfHelp">
                        Fill in the course details. Units will be automatically calculated.
                    </p>

                    <input type="hidden" id="cfCourseId" />

                    <!-- Code and Description -->
                    <div class="row g-3 mb-3">
                        <div class="col-sm-4">
                            <label class="form-label fw-medium">Course Code <span class="text-danger">*</span></label>
                            <input type="text" class="form-control" id="cfCode" placeholder="CS101" maxlength="20" required>
                            <div class="invalid-feedback">Course code is required.</div>
                        </div>
                        <div class="col-sm-8">
                            <label class="form-label fw-medium">Description <span class="text-danger">*</span></label>
                            <input type="text" class="form-control" id="cfDescription"
                                   placeholder="Introduction to Programming" maxlength="200" required>
                            <div class="invalid-feedback">Description is required.</div>
                        </div>
                    </div>

                    <!-- Lecture and Lab Units -->
                    <div class="row g-3 mb-2">
                        <div class="col-6">
                            <label class="form-label fw-medium">Lecture Units</label>
                            <input type="number" class="form-control" id="cfLecUnits" placeholder="0" min="0" max="10" step="1" value="0">
                        </div>
                        <div class="col-6">
                            <label class="form-label fw-medium">Lab Units</label>
                            <input type="number" class="form-control" id="cfLabUnits" placeholder="0" min="0" max="10" step="1" value="0">
                        </div>
                    </div>
                    <div class="form-text mb-3">Total units will be computed automatically (Lec + Lab).</div>

                    <!-- Inline error message -->
                    <div id="courseFormError" class="text-danger small mt-3" style="display:none;"></div>
                </div>

                <div class="modal-footer border-0 pt-0">
                    <button type="button" class="btn btn-outline-secondary rounded-pill px-4" data-bs-dismiss="modal">
                        Cancel
                    </button>
                    <button type="submit" class="btn btn-brand rounded-pill px-4" id="cfPrimaryBtn">
                        Add Course
                    </button>
                </div>
            </form>
        </div>
    </div>
</div>

<script>
    (function () {
        const modalEl       = document.getElementById('courseFormModal');
        const form          = document.getElementById('courseForm');
        const errEl         = document.getElementById('courseFormError');
        const titleEl       = document.getElementById('cfTitle');
        const helpEl        = document.getElementById('cfHelp');
        const idEl          = document.getElementById('cfCourseId');
        const codeEl        = document.getElementById('cfCode');
        const descEl        = document.getElementById('cfDescription');
        const lecUnitsEl    = document.getElementById('cfLecUnits');
        const labUnitsEl    = document.getElementById('cfLabUnits');
        const primary       = document.getElementById('cfPrimaryBtn');

        let MODE = 'add';
        const showErr = msg => { errEl.textContent = msg || ''; errEl.style.display = msg ? 'block' : 'none'; };

        // Open "Add"
        window.openAddCourseModal = function () {
            MODE = 'add';
            idEl.value = '';
            titleEl.textContent = 'Add Course';
            helpEl.textContent = 'Fill in the course details. Units will be automatically calculated.';
            primary.textContent = 'Add Course';

            codeEl.value = '';
            descEl.value = '';
            lecUnitsEl.value = '0';
            labUnitsEl.value = '0';
            codeEl.readOnly = false;
            descEl.readOnly = false;

            showErr('');
            form.classList.remove('was-validated');
            bootstrap.Modal.getOrCreateInstance(modalEl).show();
        };

        // Open "Edit"
        window.openEditCourseModal = function (course) {
            MODE = 'edit';
            idEl.value = course.id;
            titleEl.textContent = 'Edit Course';
            helpEl.textContent = 'You can update course details.';
            primary.textContent = 'Save Changes';

            codeEl.value = course.code || '';
            descEl.value = course.description || '';
            lecUnitsEl.value = course.lecUnits || '0';
            labUnitsEl.value = course.labUnits || '0';
            codeEl.readOnly = false;
            descEl.readOnly = false;

            showErr('');
            form.classList.remove('was-validated');
            bootstrap.Modal.getOrCreateInstance(modalEl).show();
        };

        // Button openers
        document.addEventListener('click', (e) => {
            const addBtn = e.target.closest('[data-action="course-add"]');
            if (addBtn) { e.preventDefault(); window.openAddCourseModal(); return; }

            const editBtn = e.target.closest('[data-action="course-edit"]');
            if (editBtn) {
                e.preventDefault();
                window.openEditCourseModal({
                    id: editBtn.getAttribute('data-course-id'),
                    code: editBtn.getAttribute('data-course-code'),
                    description: editBtn.getAttribute('data-course-description'),
                    lecUnits: editBtn.getAttribute('data-course-lec-units'),
                    labUnits: editBtn.getAttribute('data-course-lab-units')
                });
            }
        });

        // Submit handler
        form.addEventListener('submit', async (ev) => {
            ev.preventDefault();
            showErr('');
            form.classList.remove('was-validated');

            if (!codeEl.value.trim() || !descEl.value.trim()) {
                form.classList.add('was-validated');
                return;
            }

            primary.disabled = true;
            const origText = primary.textContent;
            primary.textContent = 'Saving...';

            try {
                const token = document.querySelector('input[name="__RequestVerificationToken"]')?.value || "";

                if (MODE === 'add') {
                    // CREATE
                    const fd = new FormData();
                    if (token) fd.append('__RequestVerificationToken', token);
                    fd.append('CourseCode', codeEl.value.trim());
                    fd.append('Description', descEl.value.trim());
                    fd.append('LecUnits', lecUnitsEl.value || '0');
                    fd.append('LabUnits', labUnitsEl.value || '0');

                    const res = await fetch('/admin/courses/create', {
                        method: 'POST',
                        headers: { 'X-Requested-With': 'XMLHttpRequest' },
                        body: fd
                    });
                    const data = await res.json().catch(() => ({}));
                    if (!res.ok || data.ok !== true) throw new Error(data.message || 'Create failed.');
                } else {
                    // UPDATE
                    const id = idEl.value;
                    const fd = new FormData();
                    if (token) fd.append('__RequestVerificationToken', token);
                    fd.append('CourseId', id);
                    fd.append('CourseCode', codeEl.value.trim());
                    fd.append('Description', descEl.value.trim());
                    fd.append('LecUnits', lecUnitsEl.value || '0');
                    fd.append('LabUnits', labUnitsEl.value || '0');

                    const res = await fetch('/admin/courses/edit', {
                        method: 'POST',
                        headers: { 'X-Requested-With': 'XMLHttpRequest' },
                        body: fd
                    });

                    if (!res.ok) {
                        const c = await res.json().catch(() => ({}));
                        throw new Error(c.message || 'Update failed.');
                    }
                    const data = await res.json().catch(() => ({}));
                    if (data.ok !== true && !res.redirected) {
                        throw new Error(data.message || 'Update failed.');
                    }
                }

                if (typeof window.loadCourseTable === 'function') await window.loadCourseTable();
                bootstrap.Modal.getOrCreateInstance(modalEl).hide();
                if (window.showToast) showToast(MODE === 'add' ? 'Course created.' : 'Course updated.');
            } catch (err) {
                console.error(err);
                showErr(err.message || 'An unexpected error occurred. Please try again.');
            } finally {
                primary.disabled = false;
                primary.textContent = origText;
            }
        });
    })();
</script>