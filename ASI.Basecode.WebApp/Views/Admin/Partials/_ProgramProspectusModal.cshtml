@* Step 2: Prospectus / Curriculum Builder (UI-only) *@
<div class="modal fade" id="programProspectusModal" tabindex="-1" aria-labelledby="prospectusLabel" aria-hidden="true" data-bs-backdrop="static" data-bs-keyboard="false">
    <div class="modal-dialog modal-dialog-centered modal-xxl">
        <div class="modal-content shadow">
            <div class="modal-header">
                <div>
                    <h5 class="modal-title" id="prospectusLabel">Build Prospectus</h5>
                    <div class="text-muted small">
                        Program: <strong id="sumCode">—</strong> — <span id="sumName">—</span>
                    </div>
                </div>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>

            <div class="modal-body">
                <ul class="nav nav-tabs" role="tablist">
                    <li class="nav-item"><a class="nav-link active" data-bs-toggle="tab" data-bs-target="#year1" role="tab">I — First Year</a></li>
                    <li class="nav-item"><a class="nav-link" data-bs-toggle="tab" data-bs-target="#year2" role="tab">II — Second Year</a></li>
                    <li class="nav-item"><a class="nav-link" data-bs-toggle="tab" data-bs-target="#year3" role="tab">III — Third Year</a></li>
                    <li class="nav-item"><a class="nav-link" data-bs-toggle="tab" data-bs-target="#year4" role="tab">IV — Fourth Year</a></li>
                </ul>

                <div class="tab-content pt-3">
                    @* ---------- YEAR 1 ---------- *@
                    <div class="tab-pane fade show active" id="year1" role="tabpanel">
                        <partial name="~/Views/Admin/Partials/_TermSection.cshtml"
                                 view-data='new ViewDataDictionary(ViewData) { { "Year", 1 } }' />
                    </div>

                    @* ---------- YEAR 2 ---------- *@
                    <div class="tab-pane fade" id="year2" role="tabpanel">
                        <partial name="~/Views/Admin/Partials/_TermSection.cshtml"
                                 view-data='new ViewDataDictionary(ViewData) { { "Year", 2 } }' />
                    </div>

                    @* ---------- YEAR 3 ---------- *@
                    <div class="tab-pane fade" id="year3" role="tabpanel">
                        <partial name="~/Views/Admin/Partials/_TermSection.cshtml"
                                 view-data='new ViewDataDictionary(ViewData) { { "Year", 3 } }' />
                    </div>

                    @* ---------- YEAR 4 ---------- *@
                    <div class="tab-pane fade" id="year4" role="tabpanel">
                        <partial name="~/Views/Admin/Partials/_TermSection.cshtml"
                                 view-data='new ViewDataDictionary(ViewData) { { "Year", 4 } }' />
                    </div>
                </div> <!-- /tab-content -->
            </div>

            <div class="modal-footer">
                <button type="button" class="btn btn-outline-secondary" id="btnBackToProgram">Back</button>
                <button type="button" class="btn btn-primary" id="btnFinishProspectus">Finish</button>
            </div>
        </div>
    </div>
</div>

<script>
    // back to Step 1
    document.getElementById('btnBackToProgram')?.addEventListener('click', function () {
      const m2 = bootstrap.Modal.getOrCreateInstance(document.getElementById('programProspectusModal'));
      const m1 = bootstrap.Modal.getOrCreateInstance(document.getElementById('addProgramModal'));
      m2.hide(); setTimeout(() => m1.show(), 150);
    });
</script>

<style>
    /* Prospectus modal: wider + keep headers on one line */
    #programProspectusModal .modal-dialog {
        max-width: 80vw;
    }

    #programProspectusModal table th,
    #programProspectusModal table td {
        white-space: nowrap;
    }
    /* 1) Prevent “editable-looking” caret on the nav tabs */
    #programProspectusModal .nav-tabs .nav-link {
        user-select: none;
        -webkit-user-select: none;
        caret-color: transparent;
    }

    /* 2) Make the two term cards always the same height and keep tables neat */
    #programProspectusModal .tab-pane > .col-12.d-xl-flex {
        align-items: stretch; /* ensure both cards line up in height */
    }

    #programProspectusModal .card {
        display: flex;
        flex-direction: column;
    }

    #programProspectusModal .card-body {
        flex: 1 1 auto; /* fill the available height */
        min-height: 0; /* allow inner scrolling */
    }

    #programProspectusModal .table-responsive {
        max-height: 48vh; /* keep big tables from pushing modal off-screen */
        overflow: auto; /* scroll inside the table area */
    }

    /* 3) Keep the units + Add Course header tight on one line */
    #programProspectusModal .card-header .d-flex {
        gap: .75rem;
        flex-wrap: nowrap;
    }

    #programProspectusModal .card-header .small.text-muted {
        white-space: nowrap;
    }

    /* 4) Optional: avoid wrapping in the tabs row */
    #programProspectusModal .nav-tabs {
        flex-wrap: nowrap;
        overflow-x: auto;
        -webkit-overflow-scrolling: touch;
    }

</style>

<script>
    (function () {
      const parent = document.getElementById('programProspectusModal');
      const child  = document.getElementById('coursePickerModal');
      if (!parent || !child) return;

      let childIsClosing = false;

      // Fires right before Bootstrap starts the hide transition on the child
      child.addEventListener('hide.bs.modal', () => {
        childIsClosing = true;
      });

      // Block parent hide if child is open OR in the process of closing
      parent.addEventListener('hide.bs.modal', (e) => {
        if (childIsClosing || child.classList.contains('show')) {
          e.preventDefault();
        }
      });

      // Keep body scroll lock while child is visible
      child.addEventListener('shown.bs.modal', () => {
        document.body.classList.add('modal-open');
      });

      // Once child fully hidden, restore body lock and focus, clear the flag
      child.addEventListener('hidden.bs.modal', () => {
        childIsClosing = false;
        if (parent.classList.contains('show')) {
          document.body.classList.add('modal-open');
          const lastTrigger = document.querySelector('[data-bs-target="#coursePickerModal"]');
          (lastTrigger || parent).focus();
        }
      });
    })();
</script>


@await Html.PartialAsync("~/Views/Admin/Partials/_CoursePickerModal.cshtml")
