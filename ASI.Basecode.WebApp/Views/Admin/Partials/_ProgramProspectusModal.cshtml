@* Views/Admin/Partials/_ProgramProspectusModal.cshtml *@
<div class="modal fade" id="programProspectusModal" tabindex="-1" aria-labelledby="prospectusLabel" aria-hidden="true"
     data-bs-backdrop="static" data-bs-keyboard="false">
    <div class="modal-dialog modal-dialog-centered modal-xxl">
        <div class="modal-content shadow">
            <div class="modal-header">
                <div>
                    <h5 class="modal-title" id="prospectusLabel">Build Prospectus</h5>
                    <div class="text-muted small">
                        Program: <strong id="sumCode">—</strong> — <span id="sumName">—</span>
                    </div>
                </div>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>

            <div class="modal-body">
                <ul class="nav nav-tabs" role="tablist">
                    <li class="nav-item"><a class="nav-link active" data-bs-toggle="tab" data-bs-target="#year1" role="tab">I — First Year</a></li>
                    <li class="nav-item"><a class="nav-link" data-bs-toggle="tab" data-bs-target="#year2" role="tab">II — Second Year</a></li>
                    <li class="nav-item"><a class="nav-link" data-bs-toggle="tab" data-bs-target="#year3" role="tab">III — Third Year</a></li>
                    <li class="nav-item"><a class="nav-link" data-bs-toggle="tab" data-bs-target="#year4" role="tab">IV — Fourth Year</a></li>
                </ul>

                <div class="tab-content pt-3">
                    <div class="tab-pane fade show active" id="year1" role="tabpanel">
                        <partial name="~/Views/Admin/Partials/_TermSection.cshtml"
                                 view-data='new ViewDataDictionary(ViewData) { { "Year", 1 } }' />
                    </div>
                    <div class="tab-pane fade" id="year2" role="tabpanel">
                        <partial name="~/Views/Admin/Partials/_TermSection.cshtml"
                                 view-data='new ViewDataDictionary(ViewData) { { "Year", 2 } }' />
                    </div>
                    <div class="tab-pane fade" id="year3" role="tabpanel">
                        <partial name="~/Views/Admin/Partials/_TermSection.cshtml"
                                 view-data='new ViewDataDictionary(ViewData) { { "Year", 3 } }' />
                    </div>
                    <div class="tab-pane fade" id="year4" role="tabpanel">
                        <partial name="~/Views/Admin/Partials/_TermSection.cshtml"
                                 view-data='new ViewDataDictionary(ViewData) { { "Year", 4 } }' />
                    </div>
                </div>
            </div>

            <div class="modal-footer justify-content-between">
                <small class="text-muted">All changes are saved automatically.</small>
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
            </div>
        </div>
    </div>
</div>

<style>
    #programProspectusModal .modal-dialog {
        max-width: 80vw;
    }

    #programProspectusModal table th, #programProspectusModal table td {
        white-space: nowrap;
    }

    #programProspectusModal .nav-tabs .nav-link {
        user-select: none;
        caret-color: transparent;
    }

    #programProspectusModal .tab-pane > .col-12.d-xl-flex {
        align-items: stretch;
    }

    #programProspectusModal .card {
        display: flex;
        flex-direction: column;
    }

    #programProspectusModal .card-body {
        flex: 1 1 auto;
        min-height: 0;
    }

    /* Stacked modal z-indexes for nested Course Picker */
    .modal-backdrop.stacked {
        z-index: 1060 !important;
    }

    #coursePickerModal {
        z-index: 1065 !important;
    }
    /* child above that backdrop */
</style>

<script>
    (function () {
      if (window.__prospectusInitBound) return;
      window.__prospectusInitBound = true;

      const parent = document.getElementById('programProspectusModal');
      const child  = document.getElementById('coursePickerModal');

      // expose for child
      window.getCurrentProgramId = function () { return parent?.dataset.programId || ''; };

      // ensure child is a <body> sibling (never nested inside parent)
      if (child && child.parentElement !== document.body) {
        document.body.appendChild(child);
      }

      async function loadOneTerm(programId, y, t) {
        const host = document.querySelector(`tbody[data-term-table][data-year="${y}"][data-term="${t}"]`);
        if (!host) return;
        host.innerHTML = '<tr><td colspan="7" class="text-center text-muted py-4">Loading…</td></tr>';

        try {
          const r = await fetch(`/admin/programs/${programId}/term?year=${y}&term=${t}`);
          const d = await r.json();
          host.innerHTML = '';
          (d.items || []).forEach(it => {
            const tr = document.createElement('tr');
            tr.dataset.id = it.id;
            tr.dataset.courseCode = it.code || '';
            tr.setAttribute('data-row', 'course');
            tr.innerHTML = `
              <td>${it.code ?? ''}</td>
              <td>${it.title ?? ''}</td>
              <td class="text-center">${it.lec ?? 0}</td>
              <td class="text-center">${it.lab ?? 0}</td>
              <td class="text-center" data-col="units">${(it.units ?? 0)}</td>
              <td>${it.prereq ?? '—'}</td>
              <td class="text-end">
                <button class="btn btn-sm btn-outline-danger" data-remove>Remove</button>
              </td>`;
            host.appendChild(tr);
          });
          if (!host.children.length) {
            host.innerHTML = '<tr><td colspan="7" class="text-center text-muted py-4">No subjects yet.</td></tr>';
          }
          if (window.recalcUnits) window.recalcUnits(`Y${y}T${t}`);
        } catch {
          host.innerHTML = '<tr><td colspan="7" class="text-center text-danger py-4">Failed to load.</td></tr>';
        }
      }

      async function loadAllTerms(programId) {
        document.querySelectorAll('tbody[data-term-table]').forEach(tbody => {
          tbody.innerHTML = '<tr><td colspan="7" class="text-center text-muted py-4">Loading…</td></tr>';
        });
        const jobs = [];
        for (let y = 1; y <= 4; y++) for (let t = 1; t <= 2; t++) jobs.push(loadOneTerm(programId, y, t));
        await Promise.all(jobs);
      }

      // When Prospectus opens, set Program metadata and load terms
      parent.addEventListener('show.bs.modal', async (e) => {
        const btn  = e.relatedTarget;
        const pid  = btn?.getAttribute('data-program-id')   ?? '';
        const code = btn?.getAttribute('data-program-code') ?? '—';
        const name = btn?.getAttribute('data-program-name') ?? '—';

        parent.dataset.programId = pid;
        const sumCode = document.getElementById('sumCode');
        const sumName = document.getElementById('sumName');
        if (sumCode) sumCode.textContent = code;
        if (sumName) sumName.textContent = name;

        if (pid) await loadAllTerms(pid);
      });

      // Keep parent open while child is open
      parent.addEventListener('hide.bs.modal', (e) => {
        if (child?.classList.contains('show')) e.preventDefault();
      });

      parent.addEventListener('hidden.bs.modal', () => {
        if (!document.querySelector('.modal.show')) document.body.classList.remove('modal-open');
      });

      // Child stacking glue
      if (child) {
        child.addEventListener('shown.bs.modal', () => {
          const bds = document.querySelectorAll('.modal-backdrop');
          bds[bds.length - 1]?.classList.add('stacked');
          document.body.classList.add('modal-open');
        });
        child.addEventListener('hidden.bs.modal', () => {
          // re-add scroll lock if parent still visible
          if (parent.classList.contains('show')) document.body.classList.add('modal-open');
        });
      }
    })();
</script>
