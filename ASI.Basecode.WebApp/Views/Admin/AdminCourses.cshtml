@using ASI.Basecode.Data.Models
@model List<ASI.Basecode.Data.Models.Course>

@{
    ViewData["Title"] = "Program & Courses";
    Layout = "~/Views/Shared/Layouts/_MainLayout.cshtml";
    ViewData["PageHeader"] = "Program & Courses";
}

<style>
    /* ===== Match TermSections tab style exactly ===== */
    .nav-tabs.folder-tabs {
        border-bottom: 1px solid #dee2e6;
        gap: .25rem;
        font-weight: 500;
    }

        .nav-tabs.folder-tabs .nav-link {
            border: 1px solid transparent;
            border-top-left-radius: .375rem;
            border-top-right-radius: .375rem;
            color: #0d6efd;
            background-color: transparent;
            padding: .5rem .9rem;
            transition: all .15s ease-in-out;
        }

            .nav-tabs.folder-tabs .nav-link:hover {
                color: #0a58ca;
                background-color: #f8f9fa;
                border-color: #dee2e6 #dee2e6 #fff;
            }

            .nav-tabs.folder-tabs .nav-link.active,
            .nav-tabs.folder-tabs .nav-item.show .nav-link {
                color: #212529;
                background-color: #f8f9fa;
                border-color: #dee2e6 #dee2e6 #fff;
                font-weight: 600;
            }

    /* Tiny helper for “no matches” on Courses */
    .no-matches {
        padding: 2rem 0;
        color: #6c757d;
        text-align: center;
    }
</style>

@Html.AntiForgeryToken()

<div class="admin-courses-container">
    <div class="card admin-courses-card">
        <div class="card-header bg-white border-0 pt-3 pb-0">
            <div class="d-flex justify-content-between align-items-end gap-3 flex-wrap">
                <!-- Tabs -->
                <ul class="nav nav-tabs folder-tabs" role="tablist">
                    <li class="nav-item">
                        <a class="nav-link active" data-bs-toggle="tab" data-bs-target="#programs" role="tab">Programs</a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" data-bs-toggle="tab" data-bs-target="#courses" role="tab">Courses</a>
                    </li>
                </ul>

                <!-- Actions: unified search (Filter button removed) -->
                <div class="ms-auto">
                    <div class="input-group input-group-sm" style="width: 280px;">
                        <span class="input-group-text bg-white"><i class="bi bi-search"></i></span>
                        <input id="globalSearch"
                               class="form-control"
                               type="search"
                               name="q"
                               placeholder="Search by code or title…"
                               value="@(Context?.Request?.Query["q"])"
                               autocomplete="off"
                               aria-label="Search programs or courses" />
                        <button id="clearSearch" class="btn btn-outline-secondary" type="button" title="Clear" aria-label="Clear search">&times;</button>
                    </div>
                </div>
            </div>
        </div>

        <div class="card-body">
            <div class="tab-content" id="catalogTabsContent">
                <!-- PROGRAMS TAB (AJAX-loaded list) -->
                <div class="tab-pane fade show active" id="programs" role="tabpanel">
                    <div class="mt-3 d-flex justify-content-end">
                        <button class="btn btn-primary rounded-pill px-4" type="button" data-action="program-add">
                            <span class="me-2">+</span> Add Program
                        </button>
                    </div>

                    <!-- Host div -->
                    <div id="programsTableHost" class="mt-3">
                        <div class="text-muted text-center py-4">Loading programs…</div>
                    </div>
                </div>

                <!-- COURSES TAB -->
                <div class="tab-pane fade" id="courses" role="tabpanel">
                    <div class="table-responsive">
                        <div class="mt-3 d-flex justify-content-end">
                            <button class="btn btn-primary rounded-pill px-4" data-bs-toggle="modal" data-bs-target="#addCourseModal">
                                <span class="me-2">+</span> Add Course
                            </button>
                        </div>

                        @if (Model == null || !Model.Any())
                        {
                            <div class="text-center text-muted py-5">No courses found.</div>
                        }
                        else
                        {
                            @await Html.PartialAsync("~/Views/Admin/Partials/_CoursesTable.cshtml", Model)
                        }

                        <!-- Client-side “no matches” indicator (hidden by default) -->
                        <div id="coursesNoMatches" class="no-matches d-none">No matching courses.</div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

@* Include these ONCE only *@
@await Html.PartialAsync("~/Views/Admin/Partials/_CourseFormModal.cshtml")
@await Html.PartialAsync("~/Views/Admin/Partials/_ProgramFormModal.cshtml")
@await Html.PartialAsync("~/Views/Admin/Partials/_ProgramProspectusModal.cshtml")
@await Html.PartialAsync("~/Views/Admin/Partials/_CoursePickerModal.cshtml")

@* === Delete confirmation modal === *@
<div class="modal fade" id="confirmProgramDeleteModal" tabindex="-1" aria-hidden="true"
     data-bs-backdrop="static" data-bs-keyboard="false">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content shadow-lg border-0 rounded-3">
            <div class="modal-header text-white border-0 rounded-top-3">
                <div class="d-flex align-items-center gap-2">
                    <i class="bi bi-exclamation-octagon-fill fs-4"></i>
                    <h5 class="modal-title fw-semibold">Delete Program</h5>
                </div>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>

            <div class="modal-body">
                <div class="mb-3">
                    <div class="small text-muted mb-1">Program</div>
                    <div class="d-flex align-items-center gap-2">
                        <span class="badge bg-dark-subtle text-uppercase" id="pdProgramCode">CODE</span>
                        <span class="fw-semibold" id="pdProgramName">Program Name</span>
                    </div>
                </div>

                <div class="alert alert-warning d-flex align-items-start gap-2" role="alert">
                    <i class="bi bi-exclamation-triangle-fill mt-1"></i>
                    <div class="small">
                        Deleting this program will also remove its <strong>Program Courses</strong>. Any related
                        <strong>Assigned Courses</strong> (including their <strong>Schedules</strong> and <strong>Grades</strong>)
                        will be deleted. <strong>This action cannot be undone.</strong>
                    </div>
                </div>

                <div class="form-check">
                    <input class="form-check-input" type="checkbox" id="pdForce" />
                    <label class="form-check-label" for="pdForce">Also delete attached items (force delete)</label>
                </div>
            </div>

            <div class="modal-footer border-0">
                <button type="button" class="btn btn-light" data-bs-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-danger" id="pdConfirmBtn">
                    <span class="btn-label">Delete</span>
                    <span class="spinner-border spinner-border-sm align-text-top ms-2 d-none" id="pdSpinner" role="status" aria-hidden="true"></span>
                </button>
            </div>
        </div>
    </div>
</div>

<!-- Global Toast Container -->
<div class="toast-container position-fixed top-0 end-0 p-3" style="z-index: 1100;">
    <div id="appToast" class="toast align-items-center border-0" role="alert" aria-live="assertive" aria-atomic="true"
         data-bs-delay="2000" data-bs-autohide="true">
        <div class="d-flex bg-success text-white rounded shadow-sm">
            <div class="toast-body fw-semibold" id="appToastBody">Saved successfully.</div>
            <button type="button" class="btn-close btn-close-white me-2 m-auto" data-bs-dismiss="toast" aria-label="Close"></button>
        </div>
    </div>
</div>

@section Scripts {
    <script>
        // ===== Toast helper =====
        window.showToast = function (msg, type = 'success') {
          const toastEl = document.getElementById('appToast');
          const toastBody = document.getElementById('appToastBody');
          if (!toastEl || !toastBody) return;

          toastBody.textContent = msg || 'Saved successfully.';
          const wrapper = toastEl.querySelector('.d-flex');
          wrapper.className = 'd-flex text-white rounded shadow-sm ' +
            (type === 'error' ? 'bg-danger' : type === 'info' ? 'bg-primary' : 'bg-success');

          bootstrap.Toast.getOrCreateInstance(toastEl).show();
        };

        // ===== Programs table AJAX loader =====
        async function loadProgramTable(q) {
          const host = document.getElementById('programsTableHost');
          const url = '/admin/programs/list' + (q ? ('?q=' + encodeURIComponent(q)) : '');
          try {
            const res = await fetch(url, { headers: { 'X-Requested-With': 'XMLHttpRequest' } });
            host.innerHTML = await res.text();
          } catch {
            host.innerHTML = '<div class="text-danger text-center py-4">Failed to load programs.</div>';
          }
        }

        // ===== Client-side filter for Courses tab =====
        function filterCoursesTable(query) {
          const tab = document.getElementById('courses');
          const table = tab?.querySelector('table');
          const noMatches = document.getElementById('coursesNoMatches');

          if (!table) {
            if (noMatches) noMatches.classList.toggle('d-none', true);
            return;
          }

          const q = (query || '').trim().toLowerCase();
          let visible = 0;

          // assumes table body rows contain columns: Code, Title, Lec, Lab, Units, etc.
          table.querySelectorAll('tbody tr').forEach(tr => {
            // skip placeholder rows (e.g., “No courses found.” spanning row)
            const tds = tr.querySelectorAll('td');
            if (!tds.length) return;

            const code = (tds[0]?.textContent || '').toLowerCase();
            const title = (tds[1]?.textContent || '').toLowerCase();

            const match = !q || code.includes(q) || title.includes(q);
            tr.classList.toggle('d-none', !match);
            if (match) visible++;
          });

          if (noMatches) noMatches.classList.toggle('d-none', visible !== 0);
        }

        // ===== Unified search wiring =====
        const $search = document.getElementById('globalSearch');
        const $clear = document.getElementById('clearSearch');

        let debounceT = null;
        function activeTabTarget() {
          return document.querySelector('.nav-tabs .nav-link.active')?.getAttribute('data-bs-target') || '#programs';
        }

        function performSearch(immediate = false) {
          const q = $search.value || '';

          const run = () => {
            const target = activeTabTarget();
            if (target === '#programs') {
              loadProgramTable(q);
            } else if (target === '#courses') {
              filterCoursesTable(q);
            }
          };

          if (immediate) {
            clearTimeout(debounceT);
            run();
          } else {
            clearTimeout(debounceT);
            debounceT = setTimeout(run, 220);
          }
        }

        // Initial loads
        document.addEventListener('DOMContentLoaded', () => {
          // Load programs on page load with initial query (if any)
          performSearch(true);
        });

        // When switching tabs, re-apply current query to the new tab
        document.addEventListener('shown.bs.tab', (e) => {
          const target = e.target?.getAttribute('data-bs-target');
          if (target === '#programs') {
            performSearch(true);
          } else if (target === '#courses') {
            // Ensure courses are filtered client-side using current query
            filterCoursesTable($search.value || '');
          }
        });

        // Typing in search box
        $search?.addEventListener('input', () => performSearch(false));

        // Enter = immediate search, Esc = clear
        $search?.addEventListener('keydown', (e) => {
          if (e.key === 'Enter') {
            e.preventDefault();
            performSearch(true);
          } else if (e.key === 'Escape') {
            $search.value = '';
            performSearch(true);
          }
        });

        // Clear button (×)
        $clear?.addEventListener('click', () => {
          $search.value = '';
          $search.focus();
          performSearch(true);
        });

        // ===== Existing delete modal & prospectus logic (unchanged) =====

        // Load Programs immediately if Programs tab is active (safe-guard)
        document.addEventListener('DOMContentLoaded', () => {
          const target = activeTabTarget();
          if (target === '#programs') loadProgramTable($search.value || '');
        });

        // DELETE Modal flow
        (function () {
          const modalEl = document.getElementById('confirmProgramDeleteModal');
          const bsModal = modalEl ? bootstrap.Modal.getOrCreateInstance(modalEl) : null;
          const pdCode = document.getElementById('pdProgramCode');
          const pdName = document.getElementById('pdProgramName');
          const pdForce = document.getElementById('pdForce');
          const pdBtn = document.getElementById('pdConfirmBtn');
          const pdSpin = document.getElementById('pdSpinner');

          let pendingDelete = { id: null, row: null };

          document.addEventListener('click', (e) => {
            const btn = e.target.closest('.btn-program-delete');
            if (!btn) return;

            const id = btn.dataset.programId;
            const code = (btn.dataset.programCode || '').toUpperCase();
            const name = btn.dataset.programName || '';

            pendingDelete.id = id;
            pendingDelete.row = btn.closest('tr');

            pdCode.textContent = code || 'CODE';
            pdName.textContent = name || 'Program';
            pdForce.checked = false;

            bsModal?.show();
          });

          pdBtn?.addEventListener('click', async () => {
            if (!pendingDelete.id) return;
            pdBtn.disabled = true;
            pdSpin.classList.remove('d-none');

            const token = document.querySelector('input[name="__RequestVerificationToken"]')?.value || "";
            const fd = new FormData();
            fd.append('__RequestVerificationToken', token);
            fd.append('force', pdForce.checked ? 'true' : 'false');

            try {
              let res = await fetch(`/admin/programs/${pendingDelete.id}/delete`, {
                method: 'POST',
                headers: { 'X-Requested-With': 'XMLHttpRequest' },
                body: fd
              });

              if (res.ok) {
                pendingDelete.row?.remove();
                bsModal?.hide();
                showToast('Program deleted.');
              } else if (res.status === 409) {
                const data = await res.json().catch(() => ({}));
                pdForce.checked = true;
                showToast(data.message || 'Program still has attached courses. Enable force delete to proceed.', 'info');
              } else {
                showToast('Delete failed.', 'error');
              }
            } catch (err) {
              console.error(err);
              showToast('Network error while deleting.', 'error');
            } finally {
              pdBtn.disabled = false;
              pdSpin.classList.add('d-none');
            }
          });
        })();

        // Prospectus preloading (unchanged)
        document.addEventListener('click', async (e) => {
          const btn = e.target.closest('[data-action="manage-courses"]');
          if (!btn) return;
          const programId = btn.dataset.programId;
          const programCode = btn.dataset.programCode || '—';
          const programName = btn.dataset.programName || '—';
          const modal = document.getElementById('programProspectusModal');
          modal.dataset.programId = programId;
          modal.querySelector('#sumCode').textContent = programCode;
          modal.querySelector('#sumName').textContent = programName;

          document.querySelectorAll('tbody[data-term-table]').forEach(tbody => {
            tbody.innerHTML = '<tr><td colspan="7" class="text-center text-muted py-4">Loading…</td></tr>';
          });

          const jobs = [];
          for (let y = 1; y <= 4; y++) for (let t = 1; t <= 2; t++) {
            jobs.push(
              fetch(`/admin/programs/${programId}/term?year=${y}&term=${t}`)
                .then(r => r.json())
                .then(d => {
                  const host = document.querySelector(`tbody[data-term-table][data-year="${y}"][data-term="${t}"]`);
                  if (!host) return;
                  host.innerHTML = '';
                  (d.items || []).forEach(it => {
                    const tr = document.createElement('tr');
                    tr.dataset.id = it.id;
                    tr.dataset.courseCode = it.code || '';
                    tr.setAttribute('data-row', 'course');
                    tr.innerHTML = `
                      <td>${it.code ?? ''}</td>
                      <td>${it.title ?? ''}</td>
                      <td class="text-center">${it.lec ?? 0}</td>
                      <td class="text-center">${it.lab ?? 0}</td>
                      <td class="text-center" data-col="units">${(it.units ?? 0)}</td>
                      <td>${it.prereq ?? '—'}</td>
                      <td class="text-end"><button class="btn btn-sm btn-outline-danger" data-remove>Remove</button></td>`;
                    host.appendChild(tr);
                  });
                  if (!host.children.length) {
                    host.innerHTML = '<tr><td colspan="7" class="text-center text-muted py-4">No subjects yet.</td></tr>';
                  }
                  if (window.recalcUnits) {
                    const key = `Y${y}T${t}`;
                    window.recalcUnits(key);
                  }
                })
                .catch(() => {
                  const host = document.querySelector(`tbody[data-term-table][data-year="${y}"][data-term="${t}"]`);
                  if (host) host.innerHTML = '<tr><td colspan="7" class="text-center text-danger py-4">Failed to load.</td></tr>';
                })
            );
          }
          await Promise.all(jobs);
          bootstrap.Modal.getOrCreateInstance(modal).show();
        });

        // Nested modal behavior (unchanged)
        (function () {
          const parentEl = document.getElementById('programProspectusModal');
          const childEl  = document.getElementById('coursePickerModal');
          if (!parentEl || !childEl) return;
          parentEl.addEventListener('hide.bs.modal', (e) => {
            if (childEl.classList.contains('show')) e.preventDefault();
          });
          childEl.addEventListener('shown.bs.modal', () => {
            const bds = document.querySelectorAll('.modal-backdrop');
            bds[bds.length - 1]?.classList.add('stacked');
            document.body.classList.add('modal-open');
          });
          childEl.addEventListener('hidden.bs.modal', () => {
            if (parentEl.classList.contains('show')) {
              document.body.classList.add('modal-open');
              const lastTrigger = parentEl.querySelector('[data-bs-target="#coursePickerModal"]');
              (lastTrigger || parentEl).focus();
            }
          });
          childEl.querySelector('.btn-close')?.addEventListener('click', (e) => {
            e.preventDefault();
            bootstrap.Modal.getOrCreateInstance(childEl).hide();
          });
        })();
    </script>
}
