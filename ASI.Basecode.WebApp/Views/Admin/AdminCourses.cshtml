@using ASI.Basecode.Data.Models
@model List<ASI.Basecode.Data.Models.Course>

@{
    ViewData["Title"] = "Program & Courses";
    Layout = "~/Views/Shared/Layouts/_MainLayout.cshtml";
    ViewData["PageHeader"] = "Program & Courses";
}

<!-- Page-specific stylesheet -->
<link rel="stylesheet" href="~/css/admin-courses.css" asp-append-version="true" />

@Html.AntiForgeryToken()

<div class="admin-courses-container">
    <div class="card admin-courses-card">
        <div class="card-header bg-white border-0 pt-3 pb-0">
            <div class="d-flex justify-content-between align-items-end gap-3 flex-wrap">
                <!-- Tabs -->
                <ul class="nav nav-tabs folder-tabs" role="tablist">
                    <li class="nav-item">
                        <a class="nav-link active" data-bs-toggle="tab" data-bs-target="#programs" role="tab">Programs</a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" data-bs-toggle="tab" data-bs-target="#courses" role="tab">Courses</a>
                    </li>
                </ul>

                <!-- Actions: unified search -->
                <div class="ms-auto">
                    <div class="input-group input-group-sm" style="width: 280px;">
                        <span class="input-group-text bg-white"><i class="bi bi-search"></i></span>
                        <input id="globalSearch"
                               class="form-control"
                               type="search"
                               name="q"
                               placeholder="Search by code or title…"
                               value="@(Context?.Request?.Query["q"])"
                               autocomplete="off"
                               aria-label="Search programs or courses" />
                        <button id="clearSearch" class="btn btn-outline-secondary" type="button" title="Clear" aria-label="Clear search">&times;</button>
                    </div>
                </div>
            </div>
        </div>

        <div class="card-body">
            <div class="tab-content" id="catalogTabsContent">
                <!-- PROGRAMS TAB (AJAX-loaded list) -->
                <div class="tab-pane fade show active" id="programs" role="tabpanel">
                    <div class="mt-3 d-flex justify-content-end">
                        <button class="btn btn-primary rounded-pill px-4" type="button" data-action="program-add">
                            <span class="me-2">+</span> Add Program
                        </button>
                    </div>

                    <!-- Host div -->
                    <div id="programsTableHost" class="mt-3">
                        <div class="text-muted text-center py-4">Loading programs…</div>
                    </div>
                </div>

                <!-- COURSES TAB -->
                <div class="tab-pane fade" id="courses" role="tabpanel">
                    <div class="mt-3 d-flex justify-content-end">
                        <button class="btn btn-primary rounded-pill px-4" data-action="course-add">
                            <span class="me-2">+</span> Add Course
                        </button>
                    </div>

                    <div class="table-responsive mt-3">
                        <div id="coursesTableHost">
                            <div class="text-center text-muted py-5">Loading courses...</div>
                        </div>

                        <!-- Client-side "no matches" indicator (hidden by default) -->
                        <div id="coursesNoMatches" class="no-matches d-none">No matching courses.</div>
                    </div>
                </div>

            </div>
        </div>
    </div>
</div>

@* Include these ONCE only *@
@await Html.PartialAsync("~/Views/Admin/Partials/_CourseFormModal.cshtml")
@await Html.PartialAsync("~/Views/Admin/Partials/_ProgramFormModal.cshtml")
@await Html.PartialAsync("~/Views/Admin/Partials/_ProgramProspectusModal.cshtml")
@await Html.PartialAsync("~/Views/Admin/Partials/_CoursePickerModal.cshtml")

@* === Delete confirmation modal === *@
<div class="modal fade" id="confirmProgramDeleteModal" tabindex="-1" aria-hidden="true"
     data-bs-backdrop="static" data-bs-keyboard="false">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content shadow-lg border-0 rounded-3">
            <div class="modal-header text-white border-0 rounded-top-3">
                <div class="d-flex align-items-center gap-2">
                    <i class="bi bi-exclamation-octagon-fill fs-4"></i>
                    <h5 class="modal-title fw-semibold">Delete Program</h5>
                </div>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>

            <div class="modal-body">
                <div class="mb-3">
                    <div class="small text-muted mb-1">Program</div>
                    <div class="d-flex align-items-center gap-2">
                        <span class="badge bg-dark-subtle text-uppercase" id="pdProgramCode">CODE</span>
                        <span class="fw-semibold" id="pdProgramName">Program Name</span>
                    </div>
                </div>

                <div class="alert alert-warning d-flex align-items-start gap-2" role="alert">
                    <i class="bi bi-exclamation-triangle-fill mt-1"></i>
                    <div class="small">
                        Deleting this program will also remove its <strong>Program Courses</strong>. Any related
                        <strong>Assigned Courses</strong> (including their <strong>Schedules</strong> and <strong>Grades</strong>)
                        will be deleted. <strong>This action cannot be undone.</strong>
                    </div>
                </div>

                <div class="form-check">
                    <input class="form-check-input" type="checkbox" id="pdForce" />
                    <label class="form-check-label" for="pdForce">Also delete attached items (force delete)</label>
                </div>
            </div>

            <div class="modal-footer border-0">
                <button type="button" class="btn btn-light" data-bs-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-danger" id="pdConfirmBtn">
                    <span class="btn-label">Delete</span>
                    <span class="spinner-border spinner-border-sm align-text-top ms-2 d-none" id="pdSpinner" role="status" aria-hidden="true"></span>
                </button>
            </div>
        </div>
    </div>
</div>

@* === Course Delete Modal === *@
<div class="modal fade" id="deleteCourseModal" tabindex="-1" aria-labelledby="deleteCourseModalLabel" aria-hidden="true"
     data-bs-backdrop="static" data-bs-keyboard="false">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content shadow-lg border-0 rounded-3">
            <div class="modal-header bg-danger text-white border-0 rounded-top-3">
                <div class="d-flex align-items-center gap-2">
                    <i class="bi bi-exclamation-octagon-fill fs-4"></i>
                    <h5 class="modal-title fw-semibold" id="deleteCourseModalLabel">Delete Course</h5>
                </div>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <div class="mb-3">
                    <div class="small text-muted mb-1">Course</div>
                    <div class="d-flex align-items-center gap-2">
                        <span class="badge bg-dark-subtle text-uppercase" id="courseCode">CODE</span>
                        <span class="fw-semibold" id="courseName">Course Name</span>
                    </div>
                </div>
                <div id="modalMessage" class="alert alert-warning d-flex align-items-start gap-2" role="alert">
                    <i class="bi bi-exclamation-triangle-fill mt-1"></i>
                    <div class="small">
                        Deleting this course will remove it permanently. <strong>This action cannot be undone.</strong>
                    </div>
                </div>
            </div>
            <div class="modal-footer border-0">
                <button type="button" class="btn btn-light" data-bs-dismiss="modal">Cancel</button>
                <button id="deleteButton" type="button" class="btn btn-danger">
                    <span class="btn-label">Delete</span>
                    <span class="spinner-border spinner-border-sm align-text-top ms-2 d-none" id="deleteSpinner" role="status" aria-hidden="true"></span>
                </button>
            </div>
        </div>
    </div>
</div>

<!-- Global Toast Container -->
<div class="toast-container position-fixed top-0 end-0 p-3" style="z-index: 1100;">
    <div id="appToast" class="toast align-items-center border-0" role="alert" aria-live="assertive" aria-atomic="true"
         data-bs-delay="2000" data-bs-autohide="true">
        <div class="d-flex bg-success text-white rounded shadow-sm">
            <div class="toast-body fw-semibold" id="appToastBody">Saved successfully.</div>
            <button type="button" class="btn-close btn-close-white me-2 m-auto" data-bs-dismiss="toast" aria-label="Close"></button>
        </div>
    </div>
</div>

@section Scripts {
    <script src="~/js/admin-courses.js" asp-append-version="true"></script>
}