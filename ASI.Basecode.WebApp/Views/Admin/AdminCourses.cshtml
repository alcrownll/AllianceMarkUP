@using ASI.Basecode.Data.Models
@model List<ASI.Basecode.Data.Models.Course>

@{
    ViewData["Title"] = "Program & Courses";
    Layout = "~/Views/Shared/Layouts/_MainLayout.cshtml";
    ViewData["PageHeader"] = "Program & Courses";
}

@section Styles {
    <link rel="stylesheet" href="~/css/admin-courses.css" />
}

<div class="admin-courses-container">
    <div class="card admin-courses-card">
        <div class="card-header bg-white border-0 pt-3 pb-0">
            <div class="d-flex justify-content-between align-items-end gap-3 flex-wrap">
                <!-- Tabs -->
                <ul class="nav nav-tabs" role="tablist">
                    <li class="nav-item">
                        <a class="nav-link" data-bs-toggle="tab" data-bs-target="#programs" role="tab">Programs</a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link active" data-bs-toggle="tab" data-bs-target="#courses" role="tab">Courses</a>
                    </li>
                </ul>

                <!-- Actions -->
                <div class="d-flex ms-auto" style="gap:.5rem;">
                    <div class="input-group input-group-sm" style="width:260px;">
                        <button class="btn btn-outline-secondary" type="button">Filter</button>
                        <input class="form-control" type="search" name="q" placeholder="Search..." value="@(Context?.Request?.Query["q"])" />
                    </div>
                </div>
            </div>
        </div>

        <div class="card-body">
            <div class="tab-content" id="catalogTabsContent">

                <!-- PROGRAMS TAB (AJAX-loaded list) -->
                <div class="tab-pane fade" id="programs" role="tabpanel">
                    <div class="mt-3 d-flex justify-content-end">
                        <button class="btn btn-primary rounded-pill px-4"
                                data-bs-toggle="modal" data-bs-target="#addProgramModal">
                            <span class="me-2">+</span> Add Program
                        </button>
                        @* Add Program modal *@
                        @await Html.PartialAsync("~/Views/Admin/Partials/_ProgramFormModal.cshtml")
                    </div>

                    <!-- Host div (no server-side partial render here) -->
                    <div id="programsTableHost" class="mt-3">
                        <div class="text-muted text-center py-4">Loading programs…</div>
                    </div>
                </div>

                <!-- COURSES TAB (unchanged) -->
                <div class="tab-pane fade show active" id="courses" role="tabpanel">
                    <div class="table-responsive">
                        <div class="mt-3 d-flex justify-content-end">
                            <button class="btn btn-primary rounded-pill px-4"
                                    data-bs-toggle="modal" data-bs-target="#addCourseModal">
                                <span class="me-2">+</span> Add Course
                            </button>
                            @await Html.PartialAsync("~/Views/Admin/Partials/_CourseFormModal.cshtml")
                        </div>

                        @if (Model == null || !Model.Any())
                        {
                            <div class="text-center text-muted py-5">No courses found.</div>
                        }
                        else
                        {
                            @await Html.PartialAsync("~/Views/Admin/Partials/_CoursesTable.cshtml", Model)
                        }
                    </div>
                </div>

            </div>
        </div>
    </div>
</div>

@section Scripts {
    <script>
        // Load Programs table (READ-ONLY) from /admin/programs/list
        async function loadProgramTable(q) {
          const host = document.getElementById('programsTableHost');
          const url = '/admin/programs/list' + (q ? ('?q=' + encodeURIComponent(q)) : '');
          try {
            const res = await fetch(url, { headers: { 'X-Requested-With': 'XMLHttpRequest' } });
            host.innerHTML = await res.text();
          } catch {
            host.innerHTML = '<div class="text-danger text-center py-4">Failed to load programs.</div>';
          }
        }

        // Load when the Programs tab becomes active
        document.addEventListener('shown.bs.tab', (e) => {
          if (e.target?.getAttribute('data-bs-target') === '#programs') {
            loadProgramTable();
          }
        });

        // If Programs tab is active on first load (optional)
        document.addEventListener('DOMContentLoaded', () => {
          const active = document.querySelector('.nav-link.active')?.getAttribute('data-bs-target');
          if (active === '#programs') loadProgramTable();
        });
    </script>

    <script>
        // ADD PROGRAM modal -> POST as FormData to /admin/programs/create
        (function () {
          const form  = document.getElementById('addProgramForm');
          const errEl = document.getElementById('addProgramError');
          const btn   = document.getElementById('btnAddProgram');
          const showErr = msg => { errEl.textContent = msg || ''; errEl.style.display = msg ? 'block' : 'none'; };

          if (!form) return;

          form.addEventListener('submit', async (ev) => {
            ev.preventDefault();
            showErr('');
            form.classList.remove('was-validated');

            if (!form.checkValidity()) {
              form.classList.add('was-validated');
              return;
            }

            btn.disabled = true;
            btn.innerHTML = '<span class="spinner-border spinner-border-sm me-2"></span>Saving...';

            try {
              const fd = new FormData();
              fd.append('code', (form.querySelector('[name="Code"]').value || '').trim());
              fd.append('name', (form.querySelector('[name="Name"]').value || '').trim());
              fd.append('notes', ''); // backend accepts it even if DB ignores it

              const res = await fetch('/admin/programs/create', { method: 'POST', body: fd });
              if (!res.ok) throw new Error(`Server returned ${res.status}`);

              const data = await res.json();
              if (data.ok) {
                bootstrap.Modal.getInstance(document.getElementById('addProgramModal')).hide();
                form.reset();

                // If Programs tab is visible, refresh it
                const isProgramsActive = document.querySelector('.nav-link.active')?.getAttribute('data-bs-target') === '#programs';
                if (isProgramsActive) loadProgramTable();
              } else {
                showErr(data.message || 'Failed to add program.');
              }
            } catch (err) {
              console.error(err);
              showErr('An unexpected error occurred. Please try again.');
            } finally {
              btn.disabled = false;
              btn.innerHTML = '<i class="bi bi-plus-lg me-1"></i> Add Program';
            }
          });
        })();
    </script>

    <!-- Your existing course modal script remains below (unchanged) -->
}
