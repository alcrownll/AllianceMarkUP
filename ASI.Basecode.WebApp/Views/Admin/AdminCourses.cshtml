@model List<ASI.Basecode.Data.Models.Course>

@{
    ViewData["Title"] = "Program & Courses";
    Layout = "~/Views/Shared/Layouts/_MainLayout.cshtml";
    ViewData["PageHeader"] = "Program & Courses";
}

@section Styles {
    <link rel="stylesheet" href="~/css/admin-courses.css" />
}

<div class="admin-courses-container">
    <div class="card admin-courses-card">
        <div class="card-header bg-white border-0 pt-3 pb-0">
            <div class="d-flex justify-content-between align-items-end gap-3 flex-wrap">
                <!-- Tabs -->
                <ul class="nav nav-tabs" role="tablist">
                    <li class="nav-item">
                        <a class="nav-link" data-bs-toggle="tab" data-bs-target="#programs" role="tab">Programs</a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link active" data-bs-toggle="tab" data-bs-target="#courses" role="tab">Courses</a>
                    </li>
                </ul>

                <!-- Actions -->
                <div class="d-flex ms-auto" style="gap:.5rem;">
                    <div class="input-group input-group-sm" style="width:260px;">
                        <button class="btn btn-outline-secondary" type="button">Filter</button>
                        <input class="form-control" type="search" name="q" placeholder="Search..." value="@(Context?.Request?.Query["q"])" />
                    </div>
                </div>
            </div>
        </div>

        <div class="card-body">
            <div class="tab-content" id="catalogTabsContent">

                <!-- PROGRAMS TAB -->
                <div class="tab-pane fade" id="programs" role="tabpanel">
                    <div class="mt-3 d-flex justify-content-end">
                        <button class="btn btn-primary rounded-pill px-4"
                                data-bs-toggle="modal" data-bs-target="#addProgramModal">
                            <span class="me-2">+</span> Add Program
                        </button>
                        @* --- ADD PROGRAM MODAL (from partial) --- *@
                        @await Html.PartialAsync("~/Views/Admin/Partials/_ProgramFormModal.cshtml")
                        @await Html.PartialAsync("~/Views/Admin/Partials/_ProgramProspectusModal.cshtml")
                    </div>

                    <!-- Placeholder list (UI only) -->
                    <div class="mt-3">
                        <div class="table-responsive">
                            <table class="table align-middle">
                                <thead class="table-light">
                                    <tr>
                                        <th style="width:140px;">Code</th>
                                        <th>Name</th>
                                        <th style="width:160px;">Effective SY</th>
                                        <th style="width:110px;" class="text-center">Status</th>
                                        <th style="width:150px;" class="text-end">Actions</th>
                                    </tr>
                                </thead>
                                <tbody id="programsTableBody">
                                    <tr class="text-muted">
                                        <td colspan="5" class="text-center py-4">No programs yet. Click “Add Program”.</td>
                                    </tr>
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>

                <!-- COURSES TAB -->
                <div class="tab-pane fade show active" id="courses" role="tabpanel">
                    <div class="table-responsive">
                        <div class="mt-3 d-flex justify-content-end">
                            <button class="btn btn-primary rounded-pill px-4"
                                    data-bs-toggle="modal" data-bs-target="#addCourseModal">
                                <span class="me-2">+</span> Add Course
                            </button>
                            @* --- ADD/EDIT COURSE MODAL --- *@
                            @await Html.PartialAsync("~/Views/Admin/Partials/_CourseFormModal.cshtml")
                        </div>

                        @if (Model == null || !Model.Any())
                        {
                            <div class="text-center text-muted py-5">No courses found.</div>
                        }
                        else
                        {
                            @await Html.PartialAsync("~/Views/Admin/Partials/_CoursesTable.cshtml", Model)
                        }
                    </div>
                </div>

            </div>
        </div>
    </div>
</div>









@section Scripts {
    <script>
        (function () {
          const modalEl = document.getElementById('addCourseModal');
          const form = document.getElementById('courseForm');
          const titleEl = modalEl.querySelector('.modal-title');
          const submitBtn = document.getElementById('courseSubmitBtn');

          const idEl   = document.getElementById('CourseId');
          const codeEl = document.getElementById('CourseCode');
          const descEl = document.getElementById('CourseDescription');
          const lecEl  = document.getElementById('LecUnits');
          const labEl  = document.getElementById('LabUnits');

          // Detect Add vs Edit every time the modal opens
          modalEl.addEventListener('show.bs.modal', function (evt) {
            const btn = evt.relatedTarget;               // opener button
            const isEdit = btn?.dataset.edit === 'true';

            // Clear fields first
            idEl.value = '';
            codeEl.value = '';
            descEl.value = '';
            lecEl.value = '';
            labEl.value = '';

            if (isEdit) {
              // Prefill from data-* attributes on Edit button
              idEl.value   = btn.dataset.id || '';
              codeEl.value = btn.dataset.code || '';
              descEl.value = btn.dataset.desc || '';
              lecEl.value  = btn.dataset.lec || '';
              labEl.value  = btn.dataset.lab || '';

              form.setAttribute('action', '@Url.Action("Edit", "AdminCourses")');
              if (titleEl) titleEl.textContent = 'Edit Course';
              if (submitBtn) submitBtn.textContent = 'Update';
            } else {
              form.setAttribute('action', '@Url.Action("Create", "AdminCourses")');
              if (titleEl) titleEl.textContent = 'Add Course';
              if (submitBtn) submitBtn.textContent = 'Save';
            }
          });

          // Optional: reset on hide so Add opens clean after an Edit
          modalEl.addEventListener('hidden.bs.modal', function () {
            form.reset();
            idEl.value = '';
          });
        })();
    </script>
    <script>
        // --- UI-only modal flow: Step 1 -> Step 2 ---
        document.addEventListener('DOMContentLoaded', () => {
            const btnNext = document.getElementById('btnNextProgram');
            const modalStep1 = document.getElementById('addProgramModal');
            const modalStep2 = document.getElementById('programProspectusModal');

            if (!btnNext || !modalStep1 || !modalStep2) return;

            btnNext.addEventListener('click', () => {
                // Hide Step 1
                const step1Instance = bootstrap.Modal.getOrCreateInstance(modalStep1);
                step1Instance.hide();

                // Show Step 2 after a short delay for smooth transition
                setTimeout(() => {
                    const step2Instance = bootstrap.Modal.getOrCreateInstance(modalStep2);
                    step2Instance.show();
                }, 300);
            });

            // Optional: Back button to return to Step 1
            const btnBack = document.getElementById('btnBackToProgram');
            if (btnBack) {
                btnBack.addEventListener('click', () => {
                    const step2Instance = bootstrap.Modal.getOrCreateInstance(modalStep2);
                    step2Instance.hide();
                    setTimeout(() => {
                        const step1Instance = bootstrap.Modal.getOrCreateInstance(modalStep1);
                        step1Instance.show();
                    }, 300);
                });
            }
        });
    </script>
}
