@model ASI.Basecode.WebApp.Models.AdminReportsViewModel
@using System.Text.Json
@{
    ViewData["Title"] = "Reports";
    Layout = "~/Views/Shared/Layouts/_MainLayout.cshtml";
    ViewData["PageHeader"] = "Admin Reports";

    var dashboard = Model?.Dashboard ?? new ASI.Basecode.Services.ServiceModels.ReportsDashboardModel();
    var selectedTermKey = Model?.SelectedTermKey ?? dashboard.TermKey ?? string.Empty;
    var schoolYears = Model?.SchoolYears ?? dashboard.AvailableSchoolYears ?? new List<string>();
    var termOptions = dashboard.TermOptions ?? new List<ASI.Basecode.Services.ServiceModels.ReportTermOptionModel>();
    var selectedSchoolYear = Model?.SelectedSchoolYear ?? dashboard.SchoolYear ?? schoolYears.LastOrDefault() ?? string.Empty;
    var serializedDashboard = JsonSerializer.Serialize(dashboard);
}

<link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.css" rel="stylesheet">

<div class="reports-page" id="reports-page">
    <!-- Centered Segmented Tabs -->
    <nav class="reports-tabs" role="tablist">
        <button class="reports-tab active" data-tab="student" type="button">
            <i class="bi-person"></i> Student
        </button>
        <button class="reports-tab" data-tab="teacher" type="button">
            <i class="bi-person-workspace"></i> Teacher
        </button>
    </nav>

    <!-- STUDENT TAB -->
    <section class="tab-panel active" data-panel="student" role="tabpanel">
        <header class="student-controls glass">
            <div class="inline-field">
                <label for="studentSelector" class="form-label m-0">Student</label>
                <select id="studentSelector" class="form-select" data-selector="student">
                    <option value="">Select Student</option>
                    @if (dashboard?.Student?.Students?.Any() == true)
                    {
                        foreach (var option in dashboard.Student.Students)
                        {
                            var selected = Model?.SelectedStudentId == option.StudentId
                            || (Model?.SelectedStudentId == null && dashboard.Student.SelectedStudentId == option.StudentId);
                            <option value="@option.StudentId" selected="@(selected)">@option.Name</option>
                        }
                    }
                </select>
            </div>
        </header>

        <div class="student-grid">
            <article class="panel glass span-2">
                <header class="panel-header">
                    <div>
                        <h2>Grades by Subject</h2>
                        <span>Performance per subject for the selected student.</span>
                    </div>
                </header>
                <div class="panel-body">
                    <canvas id="studentCourseChart" height="220"></canvas>
                </div>
            </article>

            <article class="panel glass span-1">
                <header class="panel-header">
                    <div>
                        <h2>Pass vs Fail</h2>
                        <span>GPA-based distribution of final grades.</span>
                    </div>
                </header>
                <div class="panel-body">
                    <canvas id="studentStatusChart" height="180"></canvas>
                </div>
            </article>

            <article class="panel glass span-1">
                <header class="panel-header">
                    <div>
                        <h2>Simple Comparative Analysis</h2>
                        <span>Highlights peak performance per course.</span>
                    </div>
                </header>
                <div class="panel-body">
                    <div class="analysis-list" data-list="student-comparative">
                        <p class="text-muted mb-0">Select a student.</p>
                    </div>
                </div>
            </article>

            <article class="panel glass span-2 student-grade-breakdown">
                <header class="panel-header">
                    <div>
                        <h2>Student Grade Breakdown</h2>
                        <span>Detailed term grades across all components.</span>
                    </div>
                </header>
                <div class="panel-body">
                    <div class="table-responsive">
                        <table class="table table-sm align-middle" data-table="student-grades">
                            <thead>
                                <tr>
                                    <th>EDP Code</th>
                                    <th>Subject</th>
                                    <th>Prelim</th>
                                    <th>Midterm</th>
                                    <th>Prefinal</th>
                                    <th>Final</th>
                                    <th>Final Grade</th>
                                    <th>Status</th>
                                </tr>
                            </thead>
                            <tbody>
                                <tr data-empty="true">
                                    <td colspan="8" class="text-center">Select a student.</td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                </div>
            </article>
        </div>
    </section>

    <!-- TEACHER TAB (refactored into panels/containers) -->
    <section class="tab-panel" data-panel="teacher" role="tabpanel">
        <!-- Selector -->
        <header class="teacher-controls glass">
            <div class="inline-field">
                <label for="teacherSelector" class="form-label m-0">Teacher</label>
                <select id="teacherSelector" class="form-select" data-selector="teacher">
                    <option value="">Select Teacher</option>
                    @if (dashboard?.Teacher?.Directory?.Any() == true)
                    {
                        foreach (var option in dashboard.Teacher.Directory)
                        {
                            var selected = Model?.SelectedTeacherId == option.TeacherId
                            || (Model?.SelectedTeacherId == null && dashboard.Teacher.SelectedTeacher?.TeacherId == option.TeacherId);
                            <option value="@option.TeacherId" selected="@(selected)">@option.Name (@option.Department)</option>
                        }
                    }
                </select>
            </div>
        </header>

        <!-- Top row: teacher info (left) | submission status (right) -->
        <div class="teacher-layout">
            <!-- Left: Teacher header + mini KPIs -->
            <section class="panel glass teacher-info">
                <header class="detail-header">
                    <div>
                        <h2 class="teacher-name" data-field="teacher-name">Select a teacher</h2>
                        <span class="teacher-meta" data-field="teacher-meta">--</span>
                    </div>
                </header>

                <div class="metric-row">
                    <article class="metric-chip">
                        <span class="metric-label">Subjects</span>
                        <strong class="metric-value" data-field="teacher-load">0</strong>
                    </article>
                    <article class="metric-chip">
                        <span class="metric-label">Pass Rate</span>
                        <strong class="metric-value" data-field="teacher-pass">0%</strong>
                    </article>
                </div>
            </section>

            <!-- Right: Submission Status -->
            <section class="panel glass teacher-submissions">
                <header><h3>Submission Status</h3></header>
                <ul class="status-list" data-list="teacher-submissions">
                    <li data-empty="true" class="pending">Select a teacher to load submission statuses.</li>
                </ul>
            </section>

            <!-- Full width: Subject Pass Rates -->
            <section class="panel glass teacher-passrates span-2">
                <header><h3>Subject Pass Rates</h3></header>
                <div class="panel-body">
                    <canvas id="teacherPassChart" height="200"></canvas>
                </div>
            </section>

            <!-- Full width: Teaching Assignments -->
            <section class="panel glass teacher-assignments span-2">
                <header><h3>Teaching Assignments</h3></header>
                <div class="table-responsive">
                    <table class="table table-sm" data-table="teacher-assignments">
                        <thead>
                            <tr>
                                <th>Subject</th>
                                <th>Schedule</th>
                                <th>Units</th>
                                <th>Final</th>
                                <th>Status</th>
                            </tr>
                        </thead>
                        <tbody>
                            <tr data-empty="true">
                                <td colspan="5" class="text-center">Select a teacher to load assignments.</td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </section>
        </div>
    </section>
</div>

@section Styles {
    <link rel="stylesheet" href="~/css/admin-reports.css" asp-append-version="true" />
}

@section Scripts {
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.5/dist/chart.umd.min.js"></script>
    <script>
        window.AdminReportsInitial = @Html.Raw(serializedDashboard);

        document.addEventListener('DOMContentLoaded', function () {
            const tabs = document.querySelectorAll('.reports-tab');
            const panels = document.querySelectorAll('.tab-panel');
            tabs.forEach(btn => {
                btn.addEventListener('click', () => {
                    const tab = btn.dataset.tab;
                    tabs.forEach(b => b.classList.remove('active'));
                    panels.forEach(p => p.classList.remove('active'));
                    btn.classList.add('active');
                    document.querySelector(`.tab-panel[data-panel="${tab}"]`)?.classList.add('active');
                });
            });
        });
    </script>
    <script src="~/js/admin-reports.js" asp-append-version="true"></script>
}
