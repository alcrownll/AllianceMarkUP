@model ASI.Basecode.WebApp.Models.AdminReportsViewModel
@using System.Text.Json
@using ASI.Basecode.Services.ServiceModels
@using System.Linq
@{
    ViewData["Title"] = "Reports";
    Layout = "~/Views/Shared/Layouts/_MainLayout.cshtml";

    var dashboard = Model?.Dashboard ?? new ReportsDashboardModel();
    var studentOptions = dashboard?.Student?.Students ?? new List<StudentOptionModel>();
    var selectedStudentId = Model?.SelectedStudentId ?? dashboard?.Student?.SelectedStudentId;
    var teacherDirectory = dashboard?.Teacher?.Directory ?? new List<TeacherDirectoryItemModel>();
    var selectedTeacherId = Model?.SelectedTeacherId ?? dashboard?.Teacher?.SelectedTeacher?.TeacherId;
    var serializedDashboard = JsonSerializer.Serialize(dashboard);
}

<div class="reports-page" id="reports-page">
    <header class="reports-header glass">
        <div class="header-left">
            <h1>Reports Dashboard</h1>
            <p>Monitor academic performance and faculty workloads with up-to-date student and teacher insights.</p>
        </div>
    </header>

    <nav class="reports-tabs" role="tablist">
        <button class="reports-tab active" data-tab="student" type="button" aria-controls="student-panel">Student</button>
        <button class="reports-tab" data-tab="teacher" type="button" aria-controls="teacher-panel">Teacher</button>
    </nav>

    <section class="tab-panel active" id="student-panel" data-panel="student" role="tabpanel" aria-label="Student reports">
        <header class="student-controls glass">
            <div class="control-group">
                <label for="studentSelector" class="form-label">Student</label>
                <select id="studentSelector" class="form-select" data-selector="student">
                    <option value="">Select Student</option>
                    @if (studentOptions.Any())
                    {
                        foreach (var option in studentOptions)
                        {
                            var isSelected = selectedStudentId == option.StudentId;
                            <option value="@option.StudentId" selected="@(isSelected)">@option.Name (@option.Program)</option>
                        }
                    }
                </select>
            </div>
            <div class="control-group actions">
                <button class="btn btn-outline-primary" type="button" data-action="download-student-report">Download Grade Report (PDF)</button>
            </div>
        </header>

        <div class="student-grid">
            <article class="panel glass span-2">
                <header class="panel-header">
                    <div>
                        <h2>Average Grade by Course</h2>
                        <span>Compare course performance for the selected student.</span>
                    </div>
                </header>
                <div class="panel-body">
                    <canvas id="studentCourseChart" height="260"></canvas>
                </div>
            </article>

            <article class="panel glass span-1">
                <header class="panel-header">
                    <div>
                        <h2>Workload vs Performance</h2>
                        <span>Target high-unit courses with low grades for intervention.</span>
                    </div>
                </header>
                <div class="panel-body">
                    <canvas id="studentWorkloadMatrix" height="220"></canvas>
                    <p class="chart-footnote">Focus on the highlighted quadrant: heavy units with lower grades.</p>
                </div>
            </article>

            <article class="panel glass span-1">
                <header class="panel-header">
                    <div>
                        <h2>Units Completed vs Remaining</h2>
                        <span>Track progress toward program completion.</span>
                    </div>
                </header>
                <div class="panel-body units-progress" data-section="units-progress">
                    <div class="progress-summary">
                        <strong class="mini-value" data-field="units-percent">0%</strong>
                        <span class="mini-label">Completion rate</span>
                    </div>
                    <div class="progress">
                        <div class="progress-bar" role="progressbar" style="width: 0%;" data-field="units-fill"></div>
                    </div>
                    <ul class="list-unstyled progress-stats">
                        <li><strong data-field="units-earned">0</strong> units earned</li>
                        <li><span data-field="units-remaining">0 units remaining</span></li>
                        <li><span>Total requirement: <span data-field="units-required">0</span> units</span></li>
                    </ul>
                </div>
            </article>

            <article class="panel glass span-2 student-grade-breakdown">
                <header class="panel-header">
                    <div>
                        <h2>Student Grade Breakdown</h2>
                        <span>Detailed term grades across all components.</span>
                    </div>
                </header>
                <div class="panel-body">
                    <div class="table-responsive">
                        <table class="table table-sm align-middle" data-table="student-grades">
                            <thead>
                                <tr>
                                    <th>EDP Code</th>
                                    <th>Subject</th>
                                    <th>Prelim</th>
                                    <th>Midterm</th>
                                    <th>Prefinal</th>
                                    <th>Final</th>
                                    <th>Final Grade</th>
                                    <th>Status</th>
                                </tr>
                            </thead>
                            <tbody>
                                <tr data-empty="true">
                                    <td colspan="8" class="text-center">Select a student.</td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                </div>
            </article>
        </div>
    </section>

    <section class="tab-panel" id="teacher-panel" data-panel="teacher" role="tabpanel" aria-label="Teacher reports">
        <header class="student-controls glass teacher-controls">
            <div class="control-group">
                <label for="teacherSelector" class="form-label">Teacher</label>
                <select id="teacherSelector" class="form-select" data-selector="teacher">
                    <option value="">Select Teacher</option>
                    @if (teacherDirectory.Any())
                    {
                        foreach (var item in teacherDirectory)
                        {
                            var isSelected = selectedTeacherId == item.TeacherId;
                            <option value="@item.TeacherId" selected="@(isSelected)">@item.Name (@item.Department)</option>
                        }
                    }
                </select>
            </div>
            <div class="control-group actions">
                <button class="btn btn-outline-primary" type="button" data-action="export-teacher">Export Teaching Load (CSV)</button>
            </div>
        </header>

        <div class="student-grid teacher-grid">
            <article class="panel glass span-2">
                <header class="panel-header">
                    <div>
                        <h2>Teacher Overview</h2>
                        <span>Snapshot of teaching load for the selected faculty member.</span>
                    </div>
                    <div class="panel-actions">
                        <button class="btn btn-outline-primary btn-sm" type="button" data-action="print-teacher">Print Assignments</button>
                    </div>
                </header>
                <div class="panel-body">
                    <div class="teacher-summary">
                        <h3 data-field="teacher-name">Select a teacher</h3>
                        <p data-field="teacher-meta">--</p>
                    </div>
                    <div class="mini-cards">
                        <article class="mini-card">
                            <span class="mini-label">Teaching Load</span>
                            <strong class="mini-value" data-field="teacher-load">0 units</strong>
                        </article>
                        <article class="mini-card">
                            <span class="mini-label">Sections</span>
                            <strong class="mini-value" data-field="teacher-sections">0</strong>
                        </article>
                        <article class="mini-card">
                            <span class="mini-label">Pass Rate</span>
                            <strong class="mini-value" data-field="teacher-pass">0%</strong>
                        </article>
                        <article class="mini-card">
                            <span class="mini-label">Submissions Finalized</span>
                            <strong class="mini-value" data-field="teacher-submissions">0%</strong>
                        </article>
                    </div>
                </div>
            </article>

            <article class="panel glass span-1">
                <header class="panel-header">
                    <div>
                        <h2>Course Pass Rates</h2>
                        <span>Performance across handled sections.</span>
                    </div>
                </header>
                <div class="panel-body">
                    <canvas id="teacherCourseChart" height="220"></canvas>
                </div>
            </article>

            <article class="panel glass span-1">
                <header class="panel-header">
                    <div>
                        <h2>Submission Progress</h2>
                        <span>Completion of grade submissions.</span>
                    </div>
                </header>
                <div class="panel-body">
                    <canvas id="teacherSubmissionChart" height="220"></canvas>
                </div>
            </article>

            <article class="panel glass span-2">
                <header class="panel-header">
                    <div>
                        <h2>Teaching Assignments</h2>
                        <span>Classes handled by the selected faculty member.</span>
                    </div>
                </header>
                <div class="panel-body">
                    <div class="table-responsive">
                        <table class="table table-sm" data-table="teacher-assignments">
                            <thead>
                                <tr>
                                    <th>Course</th>
                                    <th>Section</th>
                                    <th>Schedule</th>
                                    <th>Units</th>
                                    <th>Enrolled</th>
                                </tr>
                            </thead>
                            <tbody>
                                <tr data-empty="true">
                                    <td colspan="5" class="text-center">Select a teacher to see assignments.</td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                </div>
            </article>

            <article class="panel glass span-2">
                <header class="panel-header">
                    <div>
                        <h2>Submission Status</h2>
                        <span>Track outstanding grade submissions.</span>
                    </div>
                </header>
                <div class="panel-body">
                    <ul class="status-list" data-list="teacher-submissions">
                        <li data-empty="true" class="pending">Select a teacher to load submission statuses.</li>
                    </ul>
                </div>
            </article>
        </div>
    </section>
</div>

@section Styles {
    <link rel="stylesheet" href="~/css/admin-reports.css" asp-append-version="true" />
}
@section Scripts {
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.5/dist/chart.umd.min.js" integrity="sha384-MY7MzGt1eo8yEmzMhq5OA4nmpW53GMFFJkybLBGnp9KKnz4YKarSqrHpEe+Th9qH" crossorigin="anonymous"></script>
    <script>
        window.AdminReportsInitial = @Html.Raw(serializedDashboard);
    </script>
    <script src="~/js/admin-reports-student.js" asp-append-version="true"></script>
    <script src="~/js/admin-reports-teacher.js" asp-append-version="true"></script>
    <script>
        (function () {
            const page = document.getElementById('reports-page');
            if (!page) {
                return;
            }

            const tabs = Array.from(page.querySelectorAll('.reports-tab'));
            const panels = Array.from(page.querySelectorAll('.tab-panel'));
            const toggles = Array.from(document.querySelectorAll('[data-action="go-student"], [data-action="go-teacher"]'));

            function activate(targetName) {
                const target = (targetName || 'student').toLowerCase();

                tabs.forEach(tab => {
                    const isMatch = (tab.dataset.tab || '').toLowerCase() === target;
                    tab.classList.toggle('active', isMatch);
                    tab.setAttribute('aria-selected', isMatch ? 'true' : 'false');
                    tab.tabIndex = isMatch ? 0 : -1;
                });

                panels.forEach(panel => {
                    const isMatch = (panel.dataset.panel || '').toLowerCase() === target;
                    panel.classList.toggle('active', isMatch);
                    panel.hidden = !isMatch;
                    panel.setAttribute('aria-hidden', isMatch ? 'false' : 'true');
                });

                page.dataset.activePanel = target;
            }

            tabs.forEach(tab => {
                tab.addEventListener('click', () => activate(tab.dataset.tab));
            });

            toggles.forEach(button => {
                button.addEventListener('click', () => {
                    const target = button.dataset.action === 'go-teacher' ? 'teacher' : 'student';
                    activate(target);
                });
            });

            const initial = page.dataset.activePanel
                || tabs.find(t => t.classList.contains('active'))?.dataset.tab
                || 'student';

            activate(initial);

            window.AdminReportsTabs = { activate };
        })();
    </script>
}
