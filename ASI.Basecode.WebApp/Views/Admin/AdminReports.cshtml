@model ASI.Basecode.WebApp.Models.AdminReportsViewModel
@using System.Text.Json
@{
    ViewData["Title"] = "Reports";
    Layout = "~/Views/Shared/Layouts/_MainLayout.cshtml";

    var dashboard = Model?.Dashboard ?? new ASI.Basecode.Services.ServiceModels.ReportsDashboardModel();
    var selectedTermKey = Model?.SelectedTermKey ?? dashboard.TermKey ?? string.Empty;
    var schoolYears = Model?.SchoolYears ?? dashboard.AvailableSchoolYears ?? new List<string>();
    var termOptions = dashboard.TermOptions ?? new List<ASI.Basecode.Services.ServiceModels.ReportTermOptionModel>();
    var selectedSchoolYear = Model?.SelectedSchoolYear ?? dashboard.SchoolYear ?? schoolYears.LastOrDefault() ?? string.Empty;
    var serializedDashboard = JsonSerializer.Serialize(dashboard);
}

<div class="reports-page" id="reports-page">
    <header class="reports-header glass">
        <h1>Reports Dashboard</h1>
    </header>

    <nav class="reports-tabs" role="tablist">
        <button class="reports-tab active" data-tab="student" type="button">Student</button>
        <button class="reports-tab" data-tab="teacher" type="button">Teacher</button>
    </nav>

    <section class="tab-panel active" data-panel="student" role="tabpanel">
        <header class="student-controls glass">
            <div class="control-group">
                <label for="studentSelector" class="form-label">Student</label>
                <select id="studentSelector" class="form-select" data-selector="student">
                    <option value="">Select Student</option>
                    @if (dashboard?.Student?.Students?.Any() == true)
                    {
                        foreach (var option in dashboard.Student.Students)
                        {
                            var selected = Model?.SelectedStudentId == option.StudentId || (Model?.SelectedStudentId == null && dashboard.Student.SelectedStudentId == option.StudentId);
                            <option value="@option.StudentId" selected="@(selected)">@option.Name</option>
                        }
                    }
                </select>
            </div>
        </header>

        <div class="student-grid">
            <article class="panel glass span-2">
                <header class="panel-header">
                    <div>
                        <h2>Grades by Subject</h2>
                        <span>Performance per subject for the selected student.</span>
                    </div>
                </header>
                <div class="panel-body">
                    <canvas id="studentCourseChart" height="260"></canvas>
                </div>
            </article>

            <article class="panel glass span-1">
                <header class="panel-header">
                    <div>
                        <h2>Pass vs Fail</h2>
                        <span>GPA-based distribution of final grades.</span>
                    </div>
                </header>
                <div class="panel-body">
                    <canvas id="studentStatusChart" height="220"></canvas>
                </div>
            </article>

            <article class="panel glass span-2">
                <header class="panel-header">
                    <div>
                        <h2>Simple Comparative Analysis</h2>
                        <span>Highlights peak performance per course.</span>
                    </div>
                </header>
                <div class="panel-body">
                    <div class="analysis-list" data-list="student-comparative">
                        <p class="text-muted mb-0">Select a student.</p>
                    </div>
                </div>
            </article>
            <article class="panel glass span-2 student-grade-breakdown">
                <header class="panel-header">
                    <div>
                        <h2>Student Grade Breakdown</h2>
                        <span>Detailed term grades across all components.</span>
                    </div>
                </header>
                <div class="panel-body">
                    <div class="table-responsive">
                        <table class="table table-sm align-middle" data-table="student-grades">
                            <thead>
                                <tr>
                                    <th>EDP Code</th>
                                    <th>Subject</th>
                                    <th>Prelim</th>
                                    <th>Midterm</th>
                                    <th>Prefinal</th>
                                    <th>Final</th>
                                    <th>Final Grade</th>
                                    <th>Status</th>
                                </tr>
                            </thead>
                            <tbody>
                                <tr data-empty="true">
                                    <td colspan="8" class="text-center">Select a student.</td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                </div>
            </article>
        </div>
    </section>


    <section class="tab-panel" data-panel="overall" role="tabpanel">
        <div class="kpi-row">
            <article class="kpi-card glass">
                <span class="kpi-label">Total Enrolled</span>
                <h2 class="kpi-value" data-field="overall-total">0</h2>
                <span class="kpi-meta">Current selection</span>
            </article>
            <article class="kpi-card glass">
                <span class="kpi-label">Growth</span>
                <h2 class="kpi-value" data-field="overall-growth">0%</h2>
                <span class="kpi-meta">vs last term</span>
            </article>
            <article class="kpi-card glass">
                <span class="kpi-label">Average GWA</span>
                <h2 class="kpi-value" data-field="overall-gwa">0.00</h2>
                <span class="kpi-meta">Institution-wide</span>
            </article>
            <article class="kpi-card glass">
                <span class="kpi-label">Pass Rate</span>
                <h2 class="kpi-value" data-field="overall-pass">0%</h2>
                <span class="kpi-meta">Current term</span>
            </article>
            <article class="kpi-card glass">
                <span class="kpi-label">Retention</span>
                <h2 class="kpi-value" data-field="overall-retention">0%</h2>
                <span class="kpi-meta">Returning vs new</span>
            </article>
        </div>

        <div class="reports-grid">
            <article class="panel glass span-2">
                <header class="panel-header">
                    <div>
                        <h2>Enrollment Trend</h2>
                        <span>Track enrollment movement by period and facet.</span>
                    </div>
                    <div class="panel-controls">
                        <button class="btn btn-link btn-sm" type="button" data-action="export-trend">Export CSV</button>
                    </div>
                </header>
                <div class="panel-body">
                    <canvas id="overallTrendChart" height="320"></canvas>
                </div>
            </article>

            <article class="panel glass span-1">
                <header class="panel-header">
                    <div>
                        <h2>Program Leaderboard</h2>
                        <span>Enrollment volume and growth rates.</span>
                    </div>
                    <button class="btn btn-link btn-sm" type="button" data-action="export-programs">Export Excel</button>
                </header>
                <div class="panel-body leaderboard" data-list="program-leaderboard">
                    <ul>
                        <li data-empty="true"><span>--</span><strong>0</strong><small>0%</small></li>
                    </ul>
                </div>
            </article>

            <article class="panel glass span-1">
                <header class="panel-header">
                    <div>
                        <h2>Demographic Breakdown</h2>
                        <span>Understand diversity and status mix.</span>
                    </div>
                    <button class="btn btn-link btn-sm" type="button" data-action="export-demographics">Export CSV</button>
                </header>
                <div class="panel-body demo-grid">
                    <div class="demo-card">
                        <p class="text-muted mb-0">No demographic data.</p>
                    </div>
                </div>
            </article>
        </div>
    </section>

    <section class="tab-panel" data-panel="teacher" role="tabpanel">
        <header class="teacher-controls glass">
            <div class="control-group">
                <label for="teacherSelector" class="form-label">Teacher</label>
                <select id="teacherSelector" class="form-select" data-selector="teacher">
                    <option value="">Select Teacher</option>
                    @if (dashboard?.Teacher?.Directory?.Any() == true)
                    {
                        foreach (var option in dashboard.Teacher.Directory)
                        {
                            var selected = Model?.SelectedTeacherId == option.TeacherId || (Model?.SelectedTeacherId == null && dashboard.Teacher.SelectedTeacher?.TeacherId == option.TeacherId);
                            <option value="@option.TeacherId" selected="@(selected)">@option.Name (@option.Department)</option>
                        }
                    }
                </select>
            </div>
        </header>

        <section class="teacher-detail glass">
            <header class="detail-header">
                <div>
                    <h2 data-field="teacher-name">Select a teacher</h2>
                    <span data-field="teacher-meta">--</span>
                </div>
            </header>

            <div class="detail-kpis justify-content-center text-center gap-3">
                <article class="mini-card text-center">
                    <span class="mini-label">Teaching Load</span>
                    <strong class="mini-value" data-field="teacher-load">0 courses</strong>
                </article>
                <article class="mini-card text-center">
                    <span class="mini-label">Pass Rate</span>
                    <strong class="mini-value" data-field="teacher-pass">0%</strong>
                </article>
            </div>

            <div class="detail-body">
                <article class="panel">
                    <header><h3>Course Pass Rates</h3></header>
                    <div class="panel-body">
                        <canvas id="teacherPassChart" height="220"></canvas>
                    </div>
                </article>

                <article class="panel">
                    <header><h3>Teaching Assignments</h3></header>
                    <div class="table-responsive">
                        <table class="table table-sm" data-table="teacher-assignments">
                            <thead>
                                <tr>
                                    <th>Subject</th>
                                    <th>Schedule</th>
                                    <th>Units</th>
                                    <th>Enrolled</th>
                                    <th>Final</th>
                                    <th>Status</th>
                                </tr>
                            </thead>
                            <tbody>
                                <tr data-empty="true">
                                    <td colspan="6" class="text-center">Select a teacher to load assignments.</td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                </article>

                <article class="panel">
                    <header><h3>Submission Status</h3></header>
                    <ul class="status-list" data-list="teacher-submissions">
                        <li data-empty="true" class="pending">Select a teacher to load submission statuses.</li>
                    </ul>
                </article>
            </div>
        </section>
    </section>
</div>

@section Styles {
    <link rel="stylesheet" href="~/css/admin-reports.css" asp-append-version="true" />
}

@section Scripts {
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.5/dist/chart.umd.min.js"></script>
    <script>
        window.AdminReportsInitial = @Html.Raw(serializedDashboard);
    </script>
    <script src="~/js/admin-reports.js" asp-append-version="true"></script>
}
