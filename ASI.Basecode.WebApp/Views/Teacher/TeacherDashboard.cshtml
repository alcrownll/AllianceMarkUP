@using System.Text.Json
@model ASI.Basecode.Services.ServiceModels.TeacherDashboardViewModel

@{
    Layout = "~/Views/Shared/Layouts/_MainLayout.cshtml";
    ViewData["Title"] = "Teacher Dashboard";
    ViewData["PageHeader"] = "Teacher Dashboard";

    var clientData = new
    {
        IT = (Model.IT?.Courses ?? new List<ASI.Basecode.Services.ServiceModels.CourseItem>())
                .Select(c => new { code = c.Code, title = c.Title, students = c.Students }),
        CS = (Model.CS?.Courses ?? new List<ASI.Basecode.Services.ServiceModels.CourseItem>())
                .Select(c => new { code = c.Code, title = c.Title, students = c.Students }),
        itStudents = Model.Summary?.IT_Students ?? 0,
        csStudents = Model.Summary?.CS_Students ?? 0,
        itCourses = Model.Summary?.IT_Courses ?? 0,
        csCourses = Model.Summary?.CS_Courses ?? 0,
        gradedPct = Model.GradedPct
    };
    var json = JsonSerializer.Serialize(clientData);
}

@section Styles {
    <link rel="stylesheet" href="~/css/teacher-dashboard.css" />
}

<div class="dash-wrap grid teacher-dashboard">
    <!-- KPI row -->
    <div class="grid kpis">
        <div class="card kpi" aria-label="Courses Handled">
            <div class="kpi-body">
                <h4>Courses Handled</h4>
                <div class="value" id="kpiSubjectsValue">@Model.TotalCourses</div>
                <div class="meta" id="kpiSubjectsMeta">Across programs</div>
            </div>
            <div class="icon" aria-hidden="true">📘</div>
        </div>

        <div class="card kpi" aria-label="Total Students">
            <div class="kpi-body">
                <h4>Total Students</h4>
                <div class="value" id="kpiStudentsValue">@Model.TotalStudents</div>
                <div class="meta" id="kpiStudentsMeta">Across selected program</div>
            </div>
            <div class="icon" aria-hidden="true">👥</div>
        </div>
    </div>

    <!-- Courses Handled: BSCS / BSIT toggle + list -->
    <div class="card p24">
        <div class="panel-title-row">
            <div class="panel-title">Courses Handled</div>
            <div class="seg" role="tablist" aria-label="Program">
                <!-- BSCS FIRST and ACTIVE by default -->
                <button class="seg-btn active" id="segCS" aria-pressed="true" role="tab" aria-selected="true">BSCS</button>
                <button class="seg-btn" id="segIT" aria-pressed="false" role="tab" aria-selected="false">BSIT</button>
            </div>
        </div>

        <div class="list" id="coursesList"><!-- populated by script --></div>
    </div>

    <!-- Teaching Highlights -->
    <div class="card p24 grid hi">
        <div>
            <div class="hi-title">Teaching Highlights</div>
            <div class="hi-inner">
                <div class="ring-wrap">
                    <canvas id="gradingRing" class="ring-canvas" role="img" aria-label="Grading progress ring"></canvas>
                    <div class="ring-legend">
                        <div>Graded: <span id="gradedPctLabel">0%</span></div>
                        <div>Remaining: <span id="remainingPctLabel">0%</span></div>
                    </div>
                </div>

                <div class="chart-col">
                    <div class="chart-title">Students vs Courses per Program</div>
                    <div class="chart-area">
                        <canvas id="byProgramBar" role="img" aria-label="Students and courses by program"></canvas>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

@section Scripts {
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script>
        // ======= Data from server =======
        const server = @Html.Raw(json);
        const programData = { IT: server.IT, CS: server.CS };
        const gradedPct = Number(server.gradedPct || 0);

        // Elements
        const segIT = document.getElementById('segIT');
        const segCS = document.getElementById('segCS');
        const coursesList = document.getElementById('coursesList');
        const kpiSubjectsValue = document.getElementById('kpiSubjectsValue');
        const kpiSubjectsMeta  = document.getElementById('kpiSubjectsMeta');
        const kpiStudentsValue = document.getElementById('kpiStudentsValue');
        const kpiStudentsMeta  = document.getElementById('kpiStudentsMeta');

        // Display text mapping (UI shows BSCS/BSIT)
        const displayName = (key) => key === 'CS' ? 'BSCS' : 'BSIT';

        function renderCourses(programKey) {
          const list = programData[programKey] || [];
          coursesList.innerHTML = "";
          let studentsTotal = 0;

          list.forEach(c => {
            studentsTotal += (Number(c.students) || 0);

            const item  = document.createElement('div');
            item.className = 'item';

            const dot   = document.createElement('div');
            dot.className = 'dot';
            dot.textContent = '📄';

            const main  = document.createElement('div');
            const title = document.createElement('div');
            title.className = 'i-title';
            title.textContent = `${c.code} • ${c.title}`;

            const sub   = document.createElement('div');
            sub.className = 'i-sub';
            sub.textContent = `${c.students} students`;

            main.appendChild(title);
            main.appendChild(sub);
            item.appendChild(dot);
            item.appendChild(main);
            coursesList.appendChild(item);
          });

          // ✅ KPIs per selected tab (0 when empty)
          const subjectsCount = list.length;
          kpiSubjectsValue.textContent = subjectsCount;
          kpiStudentsValue.textContent = studentsTotal;
          kpiSubjectsMeta.textContent  = `${displayName(programKey)} • ${subjectsCount} ${subjectsCount === 1 ? 'course' : 'courses'}`;
          kpiStudentsMeta.textContent  = `${displayName(programKey)} • total students`;

          // Toggle states
          const on = (btn) => { btn.classList.add('active'); btn.setAttribute('aria-pressed','true'); btn.setAttribute('aria-selected','true'); };
          const off = (btn) => { btn.classList.remove('active'); btn.setAttribute('aria-pressed','false'); btn.setAttribute('aria-selected','false'); };
          if (programKey === 'CS') { on(segCS); off(segIT); } else { on(segIT); off(segCS); }
        }

        segCS.addEventListener('click', () => renderCourses('CS'));
        segIT.addEventListener('click', () => renderCourses('IT'));
        segCS.addEventListener('keydown', e => { if (['ArrowRight','Enter',' '].includes(e.key)) renderCourses('IT'); });
        segIT.addEventListener('keydown', e => { if (['ArrowLeft','Enter',' '].includes(e.key)) renderCourses('CS'); });

        // ✅ Initial: BSCS first & active
        renderCourses('CS');

        // ======= Donut (unchanged) =======
        new Chart(document.getElementById('gradingRing'), {
          type: 'doughnut',
          data: { datasets: [{ data: [gradedPct, 1 - gradedPct], borderWidth: 0, backgroundColor: ['#22c55e', '#e8eef7'], cutout: '78%' }] },
          options: { responsive: true, maintainAspectRatio: true, aspectRatio: 1, plugins: { legend: { display: false }, tooltip: { enabled: false } } },
          plugins: [{
            id: 'centerTextTeacher',
            afterDraw(chart) {
              const { ctx, chartArea } = chart; if (!chartArea) return;
              const cx = (chartArea.left + chartArea.right) / 2;
              const cy = (chartArea.top + chartArea.bottom) / 2;
              ctx.save();
              ctx.font = '700 44px Inter, system-ui, -apple-system, Segoe UI, Roboto';
              ctx.fillStyle = '#22c55e';
              ctx.textAlign = 'center';
              ctx.textBaseline = 'middle';
              ctx.fillText(Math.round(gradedPct * 100) + '%', cx, cy - 12);
              ctx.font = '12px Inter, system-ui, -apple-system, Segoe UI, Roboto';
              ctx.fillStyle = '#6b7280';
              ctx.fillText('Grading Progress', cx, cy + 18);
              ctx.restore();
            }
          }]
        });

        document.getElementById('gradedPctLabel').textContent = Math.round(gradedPct * 100) + '%';
        document.getElementById('remainingPctLabel').textContent = (100 - Math.round(gradedPct * 100)) + '%';

        // ======= Bar (unchanged) =======
        const itCourses = Number(server.itCourses || 0);
        const csCourses = Number(server.csCourses || 0);
        const itStudents = Number(server.itStudents || 0);
        const csStudents = Number(server.csStudents || 0);

        new Chart(document.getElementById('byProgramBar'), {
          type: 'bar',
          data: {
            labels: ['IT', 'CS'],
            datasets: [
              { label: 'Students', data: [itStudents, csStudents], borderWidth: 0, backgroundColor: '#2563eb' },
              { label: 'Courses',  data: [itCourses,  csCourses],  borderWidth: 0, backgroundColor: '#22c55e' }
            ]
          },
          options: {
            responsive: true, maintainAspectRatio: false,
            scales: {
              y: { beginAtZero: true, grid: { color: '#eef2f7' }, ticks: { color: '#64748b', font: { size: 11 } } },
              x: { grid: { display: false }, ticks: { color: '#64748b', font: { size: 11 } } }
            },
            plugins: { legend: { display: true } }
          }
        });
    </script>
}
