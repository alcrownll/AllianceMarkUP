@using System.Text.Json
@model ASI.Basecode.Services.ServiceModels.TeacherDashboardViewModel

@{
    Layout = "~/Views/Shared/Layouts/_MainLayout.cshtml";
    ViewData["Title"] = "Teacher Dashboard";
    ViewData["PageHeader"] = "Teacher Dashboard";

    var programs = Model.Programs ?? new List<ASI.Basecode.Services.ServiceModels.ProgramData>();
    var programsData = programs.ToDictionary(
        p => p.ProgramCode,
        p => new
        {
            courses = p.Courses.Select(c => new { code = c.Code, title = c.Title, students = c.Students }),
            uniqueStudents = p.StudentsTotal
        }
    );
    var summaryData = (Model.Summary ?? new List<ASI.Basecode.Services.ServiceModels.ProgramSummaryItem>())
        .ToDictionary(s => s.ProgramCode, s => new { students = s.Students, courses = s.Courses });

    var clientData = new
    {
        programs = programsData,
        summary = summaryData,
        gradedPct = Model.GradedPct
    };
    var json = JsonSerializer.Serialize(clientData);
}

@section Styles {
    <!-- Bootstrap Icons (if not in your layout) -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.min.css" />
    <link rel="stylesheet" href="~/css/teacher-dashboard.css" />
}

<div class="dash-wrap grid teacher-dashboard">
    <!-- KPI row -->
    <div class="grid kpis">
        <!-- Courses Handled -->
        <div class="card kpi kpi-courses">
            <div class="kpi-body">
                <h4>Courses Handled</h4>
                <div class="value" id="kpiSubjectsValue">@Model.TotalCourses</div>
                <div class="meta" id="kpiSubjectsMeta">Across programs</div>
            </div>
            <div class="icon"><i class="bi bi-journal-bookmark-fill"></i></div>
        </div>

        <!-- Total Students -->
        <div class="card kpi kpi-students">
            <div class="kpi-body">
                <h4>Total Students</h4>
                <div class="value" id="kpiStudentsValue">@Model.TotalStudents</div>
                <div class="meta" id="kpiStudentsMeta">Across selected program</div>
            </div>
            <div class="icon"><i class="bi bi-people-fill"></i></div>
        </div>

        <!-- Program (toggle beside title) -->
        <div class="card kpi kpi-program">
            <div class="kpi-body">
                <div class="kpi-head">
                    <h4>Program</h4>
                    <div class="seg kpi-seg" role="tablist" aria-label="Program Switcher">
                        @if (programs.Any())
                        {
                            @for (int i = 0; i < programs.Count; i++)
                            {
                                var program = programs[i];
                                var isFirst = i == 0;
                                <button class="seg-btn @(isFirst ? "active" : "")"
                                        id="seg@(program.ProgramCode)"
                                        aria-pressed="@(isFirst ? "true" : "false")"
                                        role="tab"
                                        aria-selected="@(isFirst ? "true" : "false")">
                                    @program.ProgramCode
                                </button>
                            }
                        }
                        else
                        {
                            <button class="seg-btn active" id="segNoPrograms" aria-pressed="true" role="tab" aria-selected="true">
                                No Programs
                            </button>
                        }
                    </div>
                </div>

                <div class="value" id="kpiProgramValue">@(programs.Any() ? programs.First().ProgramCode : "—")</div>
                <div class="meta">Tap a code to switch</div>
            </div>
            <div class="icon"><i class="bi bi-diagram-3-fill"></i></div>
        </div>
    </div>

    <!-- Courses Handled -->
    <div class="card p24">
        <div class="panel-title-row">
            <div class="panel-title">Courses Handled</div>
            <div class="current-program-hint">
                Current: <span id="currentProgramHint">@(programs.Any() ? programs.First().ProgramCode : "—")</span>
            </div>
        </div>
        <div class="list" id="coursesList"></div>
    </div>

    <!-- Teaching Highlights -->
    <div class="card p24 grid hi">
        <div>
            <div class="hi-title">Teaching Highlights</div>
            <div class="hi-inner">
                <div class="ring-wrap">
                    <canvas id="gradingRing" class="ring-canvas"></canvas>
                    <div class="ring-legend">
                        <div>Graded: <span id="gradedPctLabel">0%</span></div>
                        <div>Remaining: <span id="remainingPctLabel">0%</span></div>
                    </div>
                </div>

                <div class="chart-col">
                    <div class="chart-title">Students vs Courses per Program</div>
                    <div class="chart-area">
                        <canvas id="byProgramBar"></canvas>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

@section Scripts {
    <!-- Data for external JS -->
    <script>
        window.__TDATA = @Html.Raw(json);
    </script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="~/js/teacher-dashboard.js"></script>
}
