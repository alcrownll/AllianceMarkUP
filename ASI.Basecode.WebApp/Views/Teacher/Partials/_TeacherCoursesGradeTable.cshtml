@using Microsoft.AspNetCore.Html
@{
    var filteredStudents = ViewBag.FilteredStudents as List<ASI.Basecode.Services.ServiceModels.StudentGradeViewModel> ?? new List<ASI.Basecode.Services.ServiceModels.StudentGradeViewModel>();

    string GetGradeBadgeClass(decimal? gradeValue)
    {
        if (!gradeValue.HasValue) return "";
        return gradeValue <= 3.0m ? "bg-success" : gradeValue <= 4.0m ? "bg-warning" : "bg-danger";
    }

    IHtmlContent RenderGradeCell(decimal? gradeValue)
    {
        if (gradeValue.HasValue)
        {
            return Html.Raw($"<span class=\"badge {GetGradeBadgeClass(gradeValue)}\">{gradeValue.Value.ToString("F1")}</span>");
        }
        else
        {
            return Html.Raw("<span class=\"text-muted\">-</span>");
        }
    }

    string CalculateRemarks(decimal? finalGrade)
    {
        if (!finalGrade.HasValue)
        {
            return "INCOMPLETE";
        }
        return finalGrade <= 3.0m ? "PASSED" : "FAILED";
    }
}

<div class="card shadow-sm teacher-grades-card">
    <div class="card-body">
        <div class="d-flex justify-content-between align-items-center mb-3">
            <h4 class="mb-0">Students and Grades</h4>
            @if (ViewBag.HasFilters == true && filteredStudents.Any())
            {
                <span class="badge bg-primary">@filteredStudents.Count student(s) found</span>
            }
        </div>
        <div class="table-responsive">
            <table class="table table-bordered align-middle table-hover teacher-grade-table">
                <thead>
                    <tr>
                        <th>No.</th>
                        <th>ID Number</th>
                        <th>Last Name</th>
                        <th>First Name</th>
                        <th>Course/Year</th>
                        <th class="d-none d-md-table-cell">Gender</th>
                        <th>Prelim</th>
                        <th>Midterm</th>
                        <th>Semi-final</th>
                        <th>Final</th>
                        <th class="d-none d-lg-table-cell">Remarks</th>
                    </tr>
                </thead>
                <tbody>
                    @if (filteredStudents != null && filteredStudents.Any())
                    {
                        @for (int i = 0; i < filteredStudents.Count; i++)
                        {
                            var student = filteredStudents[i];
                            <tr>
                                <td>@(i + 1)</td>
                                <td>@student.IdNumber</td>
                                <td>@student.LastName</td>
                                <td>@student.FirstName</td>
                                <td>@student.CourseYear</td>
                                <td class="d-none d-md-table-cell">@student.Gender</td>
                                <td>@RenderGradeCell(student.Prelims)</td>
                                <td>@RenderGradeCell(student.Midterm)</td>
                                <td>@RenderGradeCell(student.SemiFinal)</td>
                                <td>@RenderGradeCell(student.Final)</td>
                                <td class="d-none d-lg-table-cell">@CalculateRemarks(student.Final)</td>
                            </tr>
                        }
                    }
                    else
                    {
                        <tr>
                            <td colspan="11" class="text-center text-muted py-4">
                                @if (ViewBag.HasFilters == true)
                                {
                                    <i class="bi bi-search mb-2 d-block" style="font-size: 2rem;"></i>
                                    <span>No students found matching the search criteria.</span>
                                    <br>
                                    <small>Try adjusting your search filters or clear them to see all students.</small>
                                }
                                else
                                {
                                    <i class="bi bi-people mb-2 d-block" style="font-size: 2rem;"></i>
                                    <span>No students found in your courses.</span>
                                    <br>
                                    <small>Students will appear here once they are enrolled in your courses and have grade records.</small>
                                }
                            </td>
                        </tr>
                    }
                </tbody>
            </table>
        </div>
        @if (filteredStudents != null && filteredStudents.Any())
        {
            <div class="mt-3">
                <small class="text-muted">Showing @filteredStudents.Count student(s)</small>
            </div>
        }
    </div>
</div>
