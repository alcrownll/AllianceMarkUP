@model ASI.Basecode.WebApp.Models.ResetPasswordViewModel
@{
    Layout = "~/Views/Shared/Layouts/_LayoutLogin.cshtml";
    ViewData["Title"] = "Reset Password";
}

@section styles {
    <link rel="stylesheet" href="~/css/user-login.css" />
    <link rel="stylesheet" href="~/css/reset-password.css" />
}

<div class="auth-wall reset-page">
    <div class="reset-card">
        <div class="reset-head">
            <div class="eyebrow">SECURITY</div>
            <h2 class="portal-title">Reset Password</h2>
            <p class="reset-sub">Create a new password for your account.</p>
        </div>

        <form asp-action="ResetPassword" asp-controller="Login" method="post" class="form-stack" autocomplete="off">
            @Html.AntiForgeryToken()
            <input type="hidden" asp-for="Token" />

            <!-- New Password -->
            <div class="notched-field pw">
                <div class="nf-input with-icon">
                    <input asp-for="NewPassword" id="rpNew" type="password" placeholder=" " required />
                    <label for="rpNew">New Password</label>
                    <button type="button" class="pw-toggle" aria-label="Show password" data-toggle="#rpNew">
                        <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor"
                             stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                            <path d="M1 12s4-7 11-7 11 7 11 7-4 7-11 7-11-7-11-7z" />
                            <circle cx="12" cy="12" r="3" />
                        </svg>
                    </button>
                </div>
                <div class="strength" aria-hidden="true"><i id="pwMeter"></i></div>
                <div class="hint">Use at least 8 characters with a mix of letters, numbers, and symbols.</div>
                <span asp-validation-for="NewPassword" class="text-danger"></span>
            </div>

            <!-- Confirm Password -->
            <div class="notched-field pw">
                <div class="nf-input with-icon">
                    <input asp-for="ConfirmPassword" id="rpConfirm" type="password" placeholder=" " required />
                    <label for="rpConfirm">Confirm New Password</label>
                    <button type="button" class="pw-toggle" aria-label="Show password" data-toggle="#rpConfirm">
                        <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor"
                             stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                            <path d="M1 12s4-7 11-7 11 7 11 7-4 7-11 7-11-7-11-7z" />
                            <circle cx="12" cy="12" r="3" />
                        </svg>
                    </button>
                </div>
                <span asp-validation-for="ConfirmPassword" class="text-danger"></span>
            </div>

            <button type="submit" class="btn-primary">Reset Password</button>

            @if (!ViewData.ModelState.IsValid)
            {
                <div class="error">
                    @foreach (var err in ViewData.ModelState.Values.SelectMany(v => v.Errors))
                    {
                        <div>@err.ErrorMessage</div>
                    }
                </div>
            }
        </form>
    </div>
</div>

@section Scripts {
    <script>
        // show/hide toggles
        document.querySelectorAll('.pw-toggle').forEach(btn => {
          btn.addEventListener('click', () => {
            const inp = document.querySelector(btn.getAttribute('data-toggle'));
            const isPw = inp.type === 'password';
            inp.type = isPw ? 'text' : 'password';
            btn.setAttribute('aria-label', isPw ? 'Hide password' : 'Show password');
          });
        });

        // strength meter + hint color
        const newPw = document.getElementById('rpNew');
        const meter = document.getElementById('pwMeter');
        const hint  = document.querySelector('.hint');

        function evaluate(v){
          const len = v.length >= 8;
          const up  = /[A-Z]/.test(v);
          const low = /[a-z]/.test(v);
          const num = /\d/.test(v);
          const sym = /[^A-Za-z0-9]/.test(v);
          const classes = [up, low, num, sym].filter(Boolean).length;
          const ok = len && classes >= 3;

          let score = 0;
          if (len) score++;
          if (up)  score++;
          if (low) score++;
          if (num || sym) score++;
          return { ok, score };
        }

        function colorFor(score){
          return ['#e11d48','#f97316','#f59e0b','#22c55e','#16a34a'][score];
        }

        newPw?.addEventListener('input', e => {
          const { ok, score } = evaluate(e.target.value);
          const pct = [0,25,50,75,100][score];

          meter.style.width = pct + '%';
          meter.style.backgroundColor = colorFor(score);

          if (hint) hint.classList.toggle('ok', ok);
        });
    </script>
}
