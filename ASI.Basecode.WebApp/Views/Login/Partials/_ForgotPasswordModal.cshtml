@* Forgot Password modal*@
@addTagHelper *, Microsoft.AspNetCore.Mvc.TagHelpers

<div id="fpModal" class="yt-modal" hidden aria-hidden="true">
  <div class="yt-modal__card" role="dialog" aria-modal="true" aria-labelledby="fpTitle">
    <button type="button" class="yt-modal__close" aria-label="Close" data-close>&times;</button>

    <div class="yt-modal__header">
      <h3 id="fpTitle">Reset your password</h3>
      <p>Enter the email to receive a password reset link.</p>
    </div>

    <form id="fpForm" method="post" action="@Url.Action("ForgotPasswordSend", "Login")" novalidate>
      @Html.AntiForgeryToken()

      <div class="yt-field" id="fpEmailField">
        <input id="fpEmail"
               name="Email"
               type="email"
               placeholder=" "
               required
               autocomplete="email"
               aria-describedby="fpEmailErr"
               aria-invalid="false" />
        <label for="fpEmail">Email address</label>
        <span class="yt-field__err" id="fpEmailErr" data-err role="alert"></span>
      </div>

      <button type="submit" class="yt-btn" id="fpSubmit" data-default-text="Send Reset Link" data-success-text="Link Sent">
        <span class="yt-btn__spinner" aria-hidden="true"></span>
        <span class="yt-btn__text">Send Reset Link</span>
      </button>

      <!-- Global (non-field) errors only -->
      <div class="yt-error" id="fpError" role="alert" hidden></div>

      <!-- Success notice -->
      <div class="yt-success" id="fpSuccess" hidden aria-live="polite">
        <div class="yt-success__check">
          <svg viewBox="0 0 24 24"><path d="M20 6L9 17l-5-5" stroke="white" stroke-width="3" fill="none" stroke-linecap="round" stroke-linejoin="round"/></svg>
        </div>
      </div>
    </form>
  </div>
</div>

<script>
(() => {
  // Prevent double-binding if the partial is ever rendered twice
  if (window.__fpModalBound) return; window.__fpModalBound = true;

  const modal    = document.getElementById('fpModal');
  const card     = modal?.querySelector('.yt-modal__card');
  const form     = document.getElementById('fpForm');
  const btn      = document.getElementById('fpSubmit');
  const btnTxt   = btn?.querySelector('.yt-btn__text');
  const spinner  = btn?.querySelector('.yt-btn__spinner');
  const email    = document.getElementById('fpEmail');
  const field    = document.getElementById('fpEmailField');
  const errSpan  = document.getElementById('fpEmailErr');
  const errBox   = document.getElementById('fpError');
  const okBox    = document.getElementById('fpSuccess');

  // ---- Open / Close (no auto-close on submit, backdrop, or Escape) ----
  function openModal() {
    if (!modal) return;
    modal.hidden = false;
    modal.classList.add('is-open');
    modal.setAttribute('aria-hidden', 'false');
    setTimeout(() => email?.focus(), 30);
  }
  function closeModal() {
    if (!modal) return;
    // full reset ONLY on explicit close
    clearAll();
    form?.reset();
    enableForm(true);
    setBtnText(btn?.dataset.defaultText);
    okBox.hidden = true;

    modal.classList.remove('is-open');
    modal.setAttribute('aria-hidden', 'true');
    modal.hidden = true;
  }

  // Wire any [data-open="fpModal"] on the page
  document.addEventListener('click', (e) => {
    const opener = e.target.closest?.('[data-open="fpModal"]');
    if (opener) { e.preventDefault(); openModal(); }
  });

  // Close button only
  modal?.querySelector('[data-close]')?.addEventListener('click', (e) => {
    e.preventDefault();
    closeModal();
  });

  // Backdrop click: keep OPEN
  modal?.addEventListener('click', (e) => {
    if (!card?.contains(e.target)) {
      // do nothing to keep it open
      e.stopPropagation();
    }
  });

  // Escape: keep OPEN
  document.addEventListener('keydown', (e) => {
    if (e.key === 'Escape' && modal && !modal.hidden) {
      e.preventDefault();
      // do nothing (keep open)
    }
  });

  // ---- Validation / UI helpers ----
  function setFieldError(msg) {
    if (!errSpan || !email || !field) return;
    errSpan.textContent = msg || '';
    email.setAttribute('aria-invalid', msg ? 'true' : 'false');
    field.classList.toggle('invalid', !!msg);
  }
  function setGlobalError(msg) {
    if (!errBox) return;
    if (!msg) { errBox.hidden = true; errBox.textContent = ''; return; }
    errBox.textContent = msg;
    errBox.hidden = false;
  }
  function clearAll() {
    setFieldError('');
    setGlobalError('');
  }
  function enableForm(enabled) {
    if (email) email.disabled = !enabled;
    if (btn) btn.disabled = !enabled;
  }
  function setLoading(on) {
    if (!btn || !spinner) return;
    if (on) {
      spinner.classList.add('is-on');
      btn.classList.add('is-loading');
      btn.disabled = true;
    } else {
      spinner.classList.remove('is-on');
      btn.classList.remove('is-loading');
      btn.disabled = false;
    }
  }
  function setBtnText(text) {
    if (btnTxt && text) btnTxt.textContent = text;
  }

  // Live clear of field error as the user types
  email?.addEventListener('input', () => {
    if (email.checkValidity()) setFieldError('');
  });

  // ---- Submit (keeps modal OPEN on success) ----
  form?.addEventListener('submit', async (e) => {
    e.preventDefault();
    clearAll();

    // client validation
    if (!email?.value || !email.checkValidity()) {
      setFieldError('Enter a valid email address.');
      email?.focus();
      return;
    }

    setLoading(true);
    setBtnText('Sending...');

    try {
      const res = await fetch(form.action, {
        method: 'POST',
        body: new FormData(form),
        headers: { 'Accept': 'application/json' } // let server return JSON
      });

      let data;
      const ct = res.headers.get('content-type') || '';
      if (ct.includes('application/json')) data = await res.json();
      else data = { ok: res.ok, message: res.ok ? null : 'Unexpected response.' };

      if (!data?.ok) {
        setFieldError(data?.message || 'Invalid input.');
        setBtnText(btn?.dataset.defaultText || 'Send Reset Link');
        return;
      }

      // SUCCESS: keep open, show success, disable fields, freeze label
      setFieldError('');
      setGlobalError('');
      okBox.hidden = false;
      enableForm(false);
      setBtnText(btn?.dataset.successText || 'Link Sent');
      // no auto-close here
    } catch {
      setGlobalError('Unable to send request. Try again later.');
      setBtnText(btn?.dataset.defaultText || 'Send Reset Link');
    } finally {
      setLoading(false);
    }
  });
})();
</script>
