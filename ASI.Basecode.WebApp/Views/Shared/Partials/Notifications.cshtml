@model ASI.Basecode.Services.ServiceModels.NotificationPageVm
@using ASI.Basecode.Data.Models
@{
    Layout = "~/Views/Shared/Layouts/_MainLayout.cshtml";
    ViewData["Title"] = "Notifications";
}

@functions {
    bool IsUpdates(ASI.Basecode.Services.ServiceModels.NotificationListItemVm x)
        => x != null && x.Kind == NotificationKind.System;

    bool IsActivity(ASI.Basecode.Services.ServiceModels.NotificationListItemVm x)
        => x != null && x.Kind == NotificationKind.Activity;

    string IconFor(string? category)
    {
        var c = (category ?? "").ToLowerInvariant();
        return c switch
        {
            "grades" => "fa-book-open-reader",
            "profile" => "fa-user-pen",
            "schedule" => "fa-calendar-days",
            "events" => "fa-bullhorn",
            _ => "fa-bell"
        };
    }

    string KindClass(NotificationKind kind)
        => (kind == NotificationKind.System) ? "n-kind-updates" : "n-kind-activity";
}

@{
    var items = (Model?.Items ?? new List<ASI.Basecode.Services.ServiceModels.NotificationListItemVm>()).ToList();
    var updates = items.Where(IsUpdates).ToList();
    var activity = items.Where(IsActivity).ToList();

    var allUnreadCount = items.Count(x => !x.IsRead);
    var updatesUnreadCount = updates.Count(x => !x.IsRead);
    var activityUnreadCount = activity.Count(x => !x.IsRead);

    var isAdmin = User.IsInRole("Admin");
}

@section Styles {
    <link rel="stylesheet" href="~/css/notifications.css" />
    <style>
        /* Filter row for Unread/Read */
        .n-filterbar {
            display: flex;
            justify-content: space-between;
            align-items: center;
            gap: 10px;
            flex-wrap: wrap;
            margin-bottom: 10px;
        }
        .n-filterbar .n-filters {
            display: flex;
            gap: 6px;
        }
        .n-markall-btn {
            height: 32px;
            display: inline-flex;
            align-items: center;
        }
    </style>
}

<div class="notifications-page">
    <div class="n-card">

        @* Top bar *@
        <div class="n-topbar d-flex justify-content-between align-items-center flex-wrap gap-2">
            <!-- Main Tabs -->
            <ul class="nav n-tabs mb-0" id="notifTabs" role="tablist">
                <li class="nav-item" role="presentation">
                    <button class="nav-link active" id="tab-all" data-bs-toggle="tab" data-bs-target="#pane-all"
                            type="button" role="tab" aria-controls="pane-all" aria-selected="true">
                        All
                    </button>
                </li>

                @if (!isAdmin)
                {
                    <li class="nav-item" role="presentation">
                        <button class="nav-link" id="tab-updates" data-bs-toggle="tab" data-bs-target="#pane-updates"
                                type="button" role="tab" aria-controls="pane-updates" aria-selected="false">
                            Updates
                        </button>
                    </li>
                }

                <li class="nav-item" role="presentation">
                    <button class="nav-link" id="tab-activity" data-bs-toggle="tab" data-bs-target="#pane-activity"
                            type="button" role="tab" aria-controls="pane-activity" aria-selected="false">
                        My Activity
                    </button>
                </li>
            </ul>
        </div>

        <div class="tab-content mt-3">

            <!-- ========== ALL TAB ========== -->
            <div class="tab-pane fade show active" id="pane-all" role="tabpanel" aria-labelledby="tab-all">

                <!-- Filters + MarkAll aligned row -->
                <div class="n-filterbar">
                    <div class="n-filters" data-scope="all">
                        <button type="button" class="n-filter-btn active" data-filter="unread">Unread</button>
                        <button type="button" class="n-filter-btn" data-filter="read">Read</button>
                    </div>

                    <div class="n-markall-wrap">
                        @if (allUnreadCount > 0)
                        {
                            <form method="post" action="/Notifications/MarkAllRead" class="d-inline">
                                @Html.AntiForgeryToken()
                                <input type="hidden" name="scope" value="all" />
                                <button type="submit" class="btn btn-sm btn-outline-primary n-markall-btn">
                                    <i class="fa-solid fa-check-double me-1"></i>Mark all as read
                                </button>
                            </form>
                        }
                        else
                        {
                            <button type="button" class="btn btn-sm btn-outline-secondary n-markall-btn" disabled>
                                <i class="fa-regular fa-circle-check me-1"></i>All caught up
                            </button>
                        }
                    </div>
                </div>

                <ul class="n-list" data-list="all">
                    @foreach (var item in items)
                    {
                        var icon = IconFor(item.Category);
                        var status = item.IsRead ? "read" : "unread";
                        <li class="n-item @KindClass(item.Kind) @(item.IsRead ? "" : "unread")" data-status="@status">
                            <div class="n-main">
                                <div class="n-icon"><i class="fa-solid @icon"></i></div>
                                <div class="n-content">
                                    <div class="n-row">
                                        <div class="n-title-sm">@item.Title</div>
                                        <div class="n-when">@item.When</div>
                                    </div>
                                    @if (!string.IsNullOrWhiteSpace(item.Message))
                                    {
                                        <div class="n-sub">@item.Message</div>
                                    }
                                </div>
                            </div>
                            @if (!item.IsRead)
                            {
                                <form method="post" action="/Notifications/MarkRead" class="n-action">
                                    @Html.AntiForgeryToken()
                                    <input type="hidden" name="id" value="@item.Id" />
                                    <button type="submit" class="n-btn-small">
                                        <i class="fa-solid fa-circle-check me-1"></i>Mark Read
                                    </button>
                                </form>
                            }
                        </li>
                    }
                </ul>
                <div class="n-empty-scope" data-empty-for="all"></div>
            </div>


            @* ========== UPDATES TAB (System) — hidden for Admins ========== *@
            @if (!isAdmin)
            {
                <div class="tab-pane fade" id="pane-updates" role="tabpanel" aria-labelledby="tab-updates">

                    <!-- Filters + MarkAll aligned row -->
                    <div class="n-filterbar">
                        <div class="n-filters" data-scope="updates">
                            <button type="button" class="n-filter-btn active" data-filter="unread">Unread</button>
                            <button type="button" class="n-filter-btn" data-filter="read">Read</button>
                        </div>

                        <div class="n-markall-wrap">
                            @if (updatesUnreadCount > 0)
                            {
                                <form method="post" action="/Notifications/MarkAllRead" class="d-inline">
                                    @Html.AntiForgeryToken()
                                    <input type="hidden" name="scope" value="updates" />
                                    <button type="submit" class="btn btn-sm btn-outline-primary n-markall-btn">
                                        <i class="fa-solid fa-check-double me-1"></i>Mark all as read
                                    </button>
                                </form>
                            }
                            else
                            {
                                <button type="button" class="btn btn-sm btn-outline-secondary n-markall-btn" disabled>
                                    <i class="fa-regular fa-circle-check me-1"></i>No unread updates
                                </button>
                            }
                        </div>
                    </div>

                    <ul class="n-list" data-list="updates">
                        @foreach (var item in updates)
                        {
                            var icon = IconFor(item.Category);
                            var status = item.IsRead ? "read" : "unread";
                            <li class="n-item n-kind-updates @(item.IsRead ? "" : "unread")" data-status="@status">
                                <div class="n-main">
                                    <div class="n-icon"><i class="fa-solid @icon"></i></div>
                                    <div class="n-content">
                                        <div class="n-row">
                                            <div class="n-title-sm">@item.Title</div>
                                            <div class="n-when">@item.When</div>
                                        </div>
                                        @if (!string.IsNullOrWhiteSpace(item.Message))
                                        {
                                            <div class="n-sub">@item.Message</div>
                                        }
                                    </div>
                                </div>
                                @if (!item.IsRead)
                                {
                                    <form method="post" action="/Notifications/MarkRead" class="n-action">
                                        @Html.AntiForgeryToken()
                                        <input type="hidden" name="id" value="@item.Id" />
                                        <button type="submit" class="n-btn-small">
                                            <i class="fa-solid fa-circle-check me-1"></i>Mark Read
                                        </button>
                                    </form>
                                }
                            </li>
                        }
                    </ul>
                    <div class="n-empty-scope" data-empty-for="updates"></div>
                </div>
            }


            <!-- ========== MY ACTIVITY TAB ========== -->
            <div class="tab-pane fade" id="pane-activity" role="tabpanel" aria-labelledby="tab-activity">

                <!-- Filters + MarkAll aligned row -->
                <div class="n-filterbar">
                    <div class="n-filters" data-scope="activity">
                        <button type="button" class="n-filter-btn active" data-filter="unread">Unread</button>
                        <button type="button" class="n-filter-btn" data-filter="read">Read</button>
                    </div>

                    <div class="n-markall-wrap">
                        @if (activityUnreadCount > 0)
                        {
                            <form method="post" action="/Notifications/MarkAllRead" class="d-inline">
                                @Html.AntiForgeryToken()
                                <input type="hidden" name="scope" value="activity" />
                                <button type="submit" class="btn btn-sm btn-outline-primary n-markall-btn">
                                    <i class="fa-solid fa-check-double me-1"></i>Mark all as read
                                </button>
                            </form>
                        }
                        else
                        {
                            <button type="button" class="btn btn-sm btn-outline-secondary n-markall-btn" disabled>
                                <i class="fa-regular fa-circle-check me-1"></i>No unread activity
                            </button>
                        }
                    </div>
                </div>

                <ul class="n-list" data-list="activity">
                    @foreach (var item in activity)
                    {
                        var icon = IconFor(item.Category);
                        var status = item.IsRead ? "read" : "unread";
                        <li class="n-item n-kind-activity @(item.IsRead ? "" : "unread")" data-status="@status">
                            <div class="n-main">
                                <div class="n-icon"><i class="fa-solid @icon"></i></div>
                                <div class="n-content">
                                    <div class="n-row">
                                        <div class="n-title-sm">@item.Title</div>
                                        <div class="n-when">@item.When</div>
                                    </div>
                                    @if (!string.IsNullOrWhiteSpace(item.Message))
                                    {
                                        <div class="n-sub">@item.Message</div>
                                    }
                                </div>
                            </div>
                            @if (!item.IsRead)
                            {
                                <form method="post" action="/Notifications/MarkRead" class="n-action">
                                    @Html.AntiForgeryToken()
                                    <input type="hidden" name="id" value="@item.Id" />
                                    <button type="submit" class="n-btn-small">
                                        <i class="fa-solid fa-circle-check me-1"></i>Mark Read
                                    </button>
                                </form>
                            }
                        </li>
                    }
                </ul>
                <div class="n-empty-scope" data-empty-for="activity"></div>
            </div>
        </div>
    </div>
</div>

@section Scripts {
    <script>
        (function () {
          const emptyMessages = {
            all:      { unread: "No unread notifications.", read: "No read notifications." },
            updates:  { unread: "No unread updates.",       read: "No read updates." },
            activity: { unread: "No unread activity.",      read: "No read activity." }
          };

          function applyFilter(scope, filter) {
            const list = document.querySelector(`.n-list[data-list="${scope}"]`);
            const emptyBox = document.querySelector(`.n-empty-scope[data-empty-for="${scope}"]`);
            let visible = 0;

            if (list) {
              list.querySelectorAll('.n-item').forEach(li => {
                const status = li.getAttribute('data-status');
                const show = (status === filter);
                li.style.display = show ? "" : "none";
                if (show) visible++;
              });
            }

            if (emptyBox) {
              if (visible === 0) {
                emptyBox.innerHTML = `
                  <div class="n-empty">
                    <i class="fa-regular fa-bell-slash fa-2x mb-2"></i>
                    <p>${emptyMessages[scope][filter]}</p>
                  </div>`;
              } else {
                emptyBox.innerHTML = "";
              }
            }
          }

          function bindFilter(scope) {
            const container = document.querySelector(`.n-filters[data-scope="${scope}"]`);
            if (!container) return;

            container.querySelectorAll('.n-filter-btn').forEach(b => b.classList.remove('active'));
            const def = container.querySelector('.n-filter-btn[data-filter="unread"]');
            if (def) def.classList.add('active');
            applyFilter(scope, 'unread');

            container.querySelectorAll('.n-filter-btn').forEach(btn => {
              btn.addEventListener('click', () => {
                container.querySelectorAll('.n-filter-btn').forEach(b => b.classList.remove('active'));
                btn.classList.add('active');
                applyFilter(scope, btn.getAttribute('data-filter'));
              });
            });

            const pane = container.closest('.tab-pane');
            if (pane) {
              document.querySelectorAll(`[data-bs-target="#${pane.id}"]`).forEach(tabBtn => {
                tabBtn.addEventListener('shown.bs.tab', () => {
                  container.querySelectorAll('.n-filter-btn').forEach(b => b.classList.remove('active'));
                  if (def) def.classList.add('active');
                  applyFilter(scope, 'unread');
                });
              });
            }
          }

          bindFilter('all');
          bindFilter('updates');
          bindFilter('activity');
        })();
    </script>
}
