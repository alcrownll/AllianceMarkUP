@using ASI.Basecode.Services.ServiceModels
@model CalendarViewModel
@{
    Layout = "~/Views/Shared/Layouts/_MainLayout.cshtml";
    ViewData["Title"] = "Calendar";
    var isAdmin = User.IsInRole("Admin");
}

@section Styles {
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/fullcalendar@6.1.10/main.min.css" />
    <link rel="stylesheet" href="~/css/calendar.css" />
}

<div class="calendar-page">
    <div class="calendar-toolbar">
        <div class="left-controls">
            <button id="btnPrev" class="btn btn-light icon-btn" title="Previous">‹</button>
            <button id="btnNext" class="btn btn-light icon-btn" title="Next">›</button>
            <button id="btnToday" class="btn btn-outline-secondary">Today</button>
            <h2 id="calTitle" class="calendar-title">Calendar</h2>
        </div>
        <div class="right-controls">
            <div class="btn-group me-2" role="group">
                <button id="btnMonth" class="btn btn-outline-secondary active">Month</button>
                <button id="btnWeek" class="btn btn-outline-secondary">Week</button>
                <button id="btnDay" class="btn btn-outline-secondary">Day</button>
                <button id="btnList" class="btn btn-outline-secondary">Agenda</button>
            </div>
            <button id="btnAdd" class="btn btn-primary">+ Add event</button>
        </div>
    </div>

    <div id="calendar"
         data-feed-url="/Calendar/Feed"
         data-is-admin="@(isAdmin ? "true" : "false")"></div>
</div>

<!-- Add/Edit/View Modal -->
<div class="modal fade" id="eventModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content rounded-3">
            <div class="modal-header">
                <h5 class="modal-title" id="eventModalTitle">Add Event</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>

            <form id="eventForm" asp-action="Create" asp-controller="Calendar" method="post">
                @Html.AntiForgeryToken()
                <input type="hidden" name="Id" id="eventId" />

                <!-- Hidden UTC fields the server binds to -->
                <input type="hidden" name="StartUtc" id="startUtc" />
                <input type="hidden" name="EndUtc" id="endUtc" />

                <!-- Hidden bools the server binds to -->
                <input type="hidden" name="IsAllDay" id="isAllDayHidden" value="false" />
                @if (isAdmin)
                {
                    <input type="hidden" name="IsGlobal" id="isGlobalHidden" value="false" />
                }

                <div class="modal-body">
                    <div class="mb-3">
                        <label class="form-label">Title</label>
                        <input name="Title" id="title" class="form-control" maxlength="200" required />
                    </div>

                    <!-- TIMED INPUTS -->
                    <div id="timedInputs">
                        <div class="row g-3">
                            <div class="col-6">
                                <label class="form-label">Start</label>
                                <input type="datetime-local" id="startLocal" class="form-control" required />
                            </div>
                            <div class="col-6">
                                <label class="form-label">End</label>
                                <input type="datetime-local" id="endLocal" class="form-control" required />
                            </div>
                        </div>
                    </div>

                    <!-- ALL-DAY INPUTS (NEW) -->
                    <div id="allDayInputs" class="d-none mt-2">
                        <div class="row g-3">
                            <div class="col-6">
                                <label class="form-label">Start Date</label>
                                <!-- IMPORTANT: name matches VM property -->
                                <input type="date" name="LocalStartDate" id="localStartDate" class="form-control" />
                            </div>
                            <div class="col-6">
                                <label class="form-label">End Date</label>
                                <!-- IMPORTANT: name matches VM property -->
                                <input type="date" name="LocalEndDate" id="localEndDate" class="form-control" />
                            </div>
                        </div>
                        <small class="text-muted d-block mt-1">
                            End date is inclusive. If you choose the same date, it's a one-day all-day event.
                        </small>
                    </div>

                    <!-- Display checkboxes WITHOUT name; JS mirrors state into hidden fields -->
                    <div class="form-check mt-3">
                        <input class="form-check-input" type="checkbox" id="allDay" />
                        <label class="form-check-label" for="allDay">All day</label>
                    </div>

                    <div class="mt-3">
                        <label class="form-label">Location</label>
                        <input name="Location" id="location" class="form-control" maxlength="200" />
                    </div>

                    @if (isAdmin)
                    {
                        <div class="form-check mt-3" id="isGlobalGroup">
                            <input class="form-check-input" type="checkbox" id="isGlobal" />
                            <label class="form-check-label" for="isGlobal">Make Global (visible to everyone)</label>
                        </div>
                    }
                </div>

                <div class="modal-footer justify-content-between">
                    <div>
                        <button type="button" id="btnDelete" class="btn btn-outline-danger d-none">Delete</button>
                    </div>
                    <div>
                        <button type="button" class="btn btn-light" data-bs-dismiss="modal">Close</button>
                        <button type="submit" class="btn btn-primary" id="btnSave">Save</button>
                    </div>
                </div>
            </form>
        </div>
    </div>
</div>

<!-- Generic message modal (for validation / simple notices) -->
<div class="modal fade" id="messageModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content rounded-3">
            <div class="modal-header">
                <h5 class="modal-title" id="messageModalTitle">Notice</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body" id="messageModalBody"></div>
            <div class="modal-footer">
                <button type="button" class="btn btn-primary" data-bs-dismiss="modal">OK</button>
            </div>
        </div>
    </div>
</div>

<!-- Confirmation modal (for delete confirmations etc.) -->
<div class="modal fade" id="confirmModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content rounded-3">
            <div class="modal-header">
                <h5 class="modal-title" id="confirmModalTitle">Please confirm</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body" id="confirmModalBody"></div>
            <div class="modal-footer">
                <button type="button" class="btn btn-outline-secondary" data-bs-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-danger" id="confirmModalOk">Yes</button>
            </div>
        </div>
    </div>
</div>

<!-- ===================== TOASTS ===================== -->
<div class="toast-container position-fixed top-0 end-0 p-3" style="z-index: 11000;">
    <div id="appToast" class="toast align-items-center border-0" role="alert" aria-live="assertive" aria-atomic="true">
        <div class="d-flex">
            <div id="appToastBody" class="toast-body"></div>
            <button type="button" class="btn-close btn-close-white me-2 m-auto"
                    data-bs-dismiss="toast" aria-label="Close"></button>
        </div>
    </div>
</div>

@if (TempData["ToastSuccess"] != null)
{
    <div id="toast-success-message" class="d-none">@TempData["ToastSuccess"]</div>
}
@if (TempData["ToastError"] != null)
{
    <div id="toast-error-message" class="d-none">@TempData["ToastError"]</div>
}

@section Scripts {
    <script src="https://cdn.jsdelivr.net/npm/fullcalendar@6.1.10/index.global.min.js"></script>
    <script>
        // Helpers
        function toUtcISOString(localValue) {
            if (!localValue) return "";
            return new Date(localValue).toISOString();
        }

        function toInputValue(date) {
            if (!date) return "";
            const pad = (n) => (n < 10 ? "0" + n : n);
            const yr = date.getFullYear();
            const mo = pad(date.getMonth() + 1);
            const dy = pad(date.getDate());
            const hr = pad(date.getHours());
            const mi = pad(date.getMinutes());
            return `${yr}-${mo}-${dy}T${hr}:${mi}`;
        }

        function toDateInputValue(date) {
            if (!date) return "";
            const pad = (n) => (n < 10 ? "0" + n : n);
            const yr = date.getFullYear();
            const mo = pad(date.getMonth() + 1);
            const dy = pad(date.getDate());
            return `${yr}-${mo}-${dy}`;
        }

        // === Modal helpers ===
        function showMessageModal(title, message) {
            const modalEl = document.getElementById('messageModal');
            if (!modalEl) return;
            document.getElementById('messageModalTitle').textContent = title || 'Notice';
            document.getElementById('messageModalBody').textContent = message || '';
            bootstrap.Modal.getOrCreateInstance(modalEl).show();
        }

        function showConfirmModal(options) {
            const modalEl = document.getElementById('confirmModal');
            if (!modalEl) return Promise.resolve(false);

            const titleEl = document.getElementById('confirmModalTitle');
            const bodyEl = document.getElementById('confirmModalBody');
            const okBtn = document.getElementById('confirmModalOk');

            titleEl.textContent = options.title || 'Please confirm';
            bodyEl.textContent = options.message || '';

            const modal = bootstrap.Modal.getOrCreateInstance(modalEl);

            return new Promise((resolve) => {
                let resolved = false;

                const handleOk = () => { resolved = true; resolve(true); modal.hide(); };
                const handleHidden = () => {
                    if (!resolved) resolve(false);
                    okBtn.removeEventListener('click', handleOk);
                    modalEl.removeEventListener('hidden.bs.modal', handleHidden);
                };

                okBtn.addEventListener('click', handleOk, { once: true });
                modalEl.addEventListener('hidden.bs.modal', handleHidden, { once: true });
                modal.show();
            });
        }

        // Toast helper
        function showToast(message, variant = "success") {
            const toastEl = document.getElementById("appToast");
            const bodyEl = document.getElementById("appToastBody");
            if (!toastEl || !bodyEl) return;

            toastEl.classList.remove("text-bg-success", "text-bg-danger");
            toastEl.classList.add(variant === "danger" ? "text-bg-danger" : "text-bg-success");
            bodyEl.textContent = message;

            bootstrap.Toast.getOrCreateInstance(toastEl, { delay: 2500 }).show();
        }

        document.addEventListener('DOMContentLoaded', () => {
            const calEl = document.getElementById('calendar');
            const feedUrl = calEl.dataset.feedUrl || '/Calendar/Feed';
            const isAdmin = calEl.dataset.isAdmin === 'true';

            // show toast from TempData
            const sucEl = document.getElementById("toast-success-message");
            if (sucEl && sucEl.textContent.trim() !== "") showToast(sucEl.textContent.trim(), "success");
            const errEl = document.getElementById("toast-error-message");
            if (errEl && errEl.textContent.trim() !== "") showToast(errEl.textContent.trim(), "danger");

            // elements
            const form = document.getElementById('eventForm');
            const titleEl = document.getElementById('title');
            const locEl = document.getElementById('location');
            const startLocalEl = document.getElementById('startLocal');
            const endLocalEl = document.getElementById('endLocal');
            const allDayEl = document.getElementById('allDay');
            const localStartDateEl = document.getElementById('localStartDate');
            const localEndDateEl = document.getElementById('localEndDate');
            const timedInputs = document.getElementById('timedInputs');
            const allDayInputs = document.getElementById('allDayInputs');

            const isGlobalEl = document.getElementById('isGlobal');
            const btnSave = document.getElementById('btnSave');
            const btnDelete = document.getElementById('btnDelete');
            const isGlobalGroup = document.getElementById('isGlobalGroup');

            function setReadOnlyMode(ro) {
                titleEl.disabled = ro;
                locEl.disabled = ro;
                startLocalEl.disabled = ro;
                endLocalEl.disabled = ro;
                allDayEl.disabled = ro;
                localStartDateEl.disabled = ro;
                localEndDateEl.disabled = ro;
                if (isGlobalEl) isGlobalEl.disabled = ro;

                if (ro) {
                    btnSave.classList.add('d-none');
                    btnDelete.classList.add('d-none');
                } else {
                    btnSave.classList.remove('d-none');
                }

                if (!isAdmin && isGlobalGroup) isGlobalGroup.classList.add('d-none');
                if (isAdmin && isGlobalGroup) isGlobalGroup.classList.remove('d-none');
            }

            // toggle all-day UI
            function applyAllDayUI(isAllDay) {
                document.getElementById('isAllDayHidden').value = isAllDay ? 'true' : 'false';

                if (isAllDay) {
                    timedInputs.classList.add('d-none');
                    allDayInputs.classList.remove('d-none');

                    // auto-fill floating dates from timed values or "today"
                    const startDt = startLocalEl.value ? new Date(startLocalEl.value) : new Date();
                    const endDt = endLocalEl.value ? new Date(endLocalEl.value) : startDt;

                    localStartDateEl.value = toDateInputValue(startDt);
                    localEndDateEl.value = toDateInputValue(endDt);

                    // remove required on datetime inputs
                    startLocalEl.required = false;
                    endLocalEl.required = false;

                    // require local dates instead
                    localStartDateEl.required = true;
                    localEndDateEl.required = true;
                } else {
                    timedInputs.classList.remove('d-none');
                    allDayInputs.classList.add('d-none');

                    startLocalEl.required = true;
                    endLocalEl.required = true;

                    localStartDateEl.required = false;
                    localEndDateEl.required = false;
                }
            }

            allDayEl.addEventListener('change', () => applyAllDayUI(allDayEl.checked));

            const calendar = new FullCalendar.Calendar(calEl, {
                initialView: 'dayGridMonth',
                height: 'auto',
                timeZone: 'local',
                headerToolbar: false,
                selectable: true,
                dayMaxEvents: true,

                editable: true,
                eventStartEditable: (arg) => (arg.event.extendedProps?.canEdit === true),
                eventDurationEditable: (arg) => (arg.event.extendedProps?.canEdit === true),
                eventAllow: (dropInfo, draggedEvent) => draggedEvent.extendedProps?.canEdit === true,

                eventContent: (arg) => {
                    const ev = arg.event;
                    const x = ev.extendedProps || {};
                    const root = document.createElement('div');
                    root.className = 'evt-card';

                    const rawTitle = ev.title || '(Untitled)';
                    const title = document.createElement('div');
                    title.className = 'evt-title';
                    title.textContent = rawTitle;

                    const row = document.createElement('div');
                    row.className = 'evt-row';

                    const hashKey = (x.category || x.calendarId || x.program || ev.id || rawTitle || '');
                    let h = 0;
                    for (let i = 0; i < hashKey.length; i++) h = (h * 31 + hashKey.charCodeAt(i)) | 0;
                    const idx = Math.abs(h) % 10;

                    const chip = document.createElement('span');
                    chip.className = 'evt-chip';
                    const fmtTime = (d) => d.toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' });

                    let timeLabel = '';
                    if (ev.allDay) {
                        timeLabel = 'All Day';
                    } else if (ev.start) {
                        if (ev.end) timeLabel = `${fmtTime(ev.start)} – ${fmtTime(ev.end)}`;
                        else timeLabel = fmtTime(ev.start);
                    }

                    chip.innerHTML = `<span class="evt-dot evt-dot-${idx}"></span>${timeLabel || ''}`;
                    row.appendChild(chip);

                    if (x.location) {
                        const loc = document.createElement('span');
                        loc.className = 'evt-chip';
                        loc.textContent = x.location;
                        row.appendChild(loc);
                    }

                    if (x.isGlobal) {
                        const pill = document.createElement('span');
                        pill.className = 'evt-pill';
                        pill.textContent = 'GLOBAL';
                        row.appendChild(pill);
                    }

                    root.appendChild(title);
                    root.appendChild(row);
                    return { domNodes: [root] };
                },

                select: (info) => {
                    document.getElementById('eventModalTitle').innerText = 'Add Event';
                    form.setAttribute('action', '/Calendar/Create');
                    document.getElementById('eventId').value = '';

                    titleEl.value = '';
                    locEl.value = '';

                    allDayEl.checked = info.allDay;
                    applyAllDayUI(info.allDay);

                    if (info.allDay) {
                        localStartDateEl.value = toDateInputValue(info.start);
                        // FullCalendar all-day select end is exclusive
                        const endDate = info.end ? new Date(info.end.getTime() - 86400000) : info.start;
                        localEndDateEl.value = toDateInputValue(endDate);
                    } else {
                        startLocalEl.value = toInputValue(info.start);
                        endLocalEl.value = toInputValue(info.end || info.start);
                    }

                    const igHidden = document.getElementById('isGlobalHidden');
                    if (igHidden) igHidden.value = 'false';
                    if (isGlobalEl) isGlobalEl.checked = false;

                    setReadOnlyMode(false);
                    btnDelete.classList.add('d-none');

                    bootstrap.Modal.getOrCreateInstance(document.getElementById('eventModal')).show();
                },

                eventClick: (info) => {
                    const x = info.event.extendedProps || {};
                    document.getElementById('eventModalTitle').innerText = x.canEdit ? 'Edit Event' : 'View Event';

                    form.setAttribute('action', x.canEdit ? '/Calendar/Update' : '#');
                    document.getElementById('eventId').value = info.event.id;

                    titleEl.value = info.event.title || '';
                    locEl.value = x.location || '';

                    allDayEl.checked = info.event.allDay || false;
                    applyAllDayUI(allDayEl.checked);

                    if (allDayEl.checked) {
                        localStartDateEl.value = toDateInputValue(info.event.start);
                        const endDate = info.event.end
                            ? new Date(info.event.end.getTime() - 86400000)
                            : info.event.start;
                        localEndDateEl.value = toDateInputValue(endDate);
                    } else {
                        startLocalEl.value = toInputValue(info.event.start);
                        endLocalEl.value = toInputValue(info.event.end || info.event.start);
                    }

                    const igHidden = document.getElementById('isGlobalHidden');
                    if (igHidden) igHidden.value = x.isGlobal ? 'true' : 'false';
                    if (isGlobalEl) isGlobalEl.checked = !!x.isGlobal;

                    if (x.canEdit) {
                        setReadOnlyMode(false);
                        btnDelete.classList.remove('d-none');
                    } else {
                        setReadOnlyMode(true);
                    }

                    bootstrap.Modal.getOrCreateInstance(document.getElementById('eventModal')).show();
                },

                events: (fetchInfo, success, failure) => {
                    const url = `${feedUrl}?start=${encodeURIComponent(fetchInfo.startStr)}&end=${encodeURIComponent(fetchInfo.endStr)}`;
                    fetch(url, { credentials: 'same-origin' })
                        .then(r => r.json())
                        .then(data => success(data))
                        .catch(err => failure(err));
                },

                eventClassNames: (arg) => {
                    const e = arg.event.extendedProps || {};
                    const key = e.category || e.calendarId || e.program || arg.event.id || arg.event.title || '';
                    let h = 0;
                    for (let i = 0; i < key.length; i++) h = (h * 31 + key.charCodeAt(i)) | 0;
                    const idx = Math.abs(h) % 10;
                    const classes = ['evt-badge', `evt-color-${idx}`];
                    if (e.isGlobal) classes.push('evt-global');
                    return classes;
                },

                eventTimeFormat: { hour: '2-digit', minute: '2-digit', meridiem: true }
            });

            calendar.render();

            function syncTitle() {
                document.getElementById('calTitle').innerText = calendar.view.title;
            }
            syncTitle();

            document.getElementById('btnPrev').addEventListener('click', () => { calendar.prev(); syncTitle(); });
            document.getElementById('btnNext').addEventListener('click', () => { calendar.next(); syncTitle(); });
            document.getElementById('btnToday').addEventListener('click', () => { calendar.today(); syncTitle(); });

            const btnMonth = document.getElementById('btnMonth');
            const btnWeek = document.getElementById('btnWeek');
            const btnDay = document.getElementById('btnDay');
            const btnList = document.getElementById('btnList');

            function setActive(btn) {
                [btnMonth, btnWeek, btnDay, btnList].forEach(b => b.classList.remove('active'));
                btn.classList.add('active');
            }

            btnMonth.addEventListener('click', () => { calendar.changeView('dayGridMonth'); setActive(btnMonth); syncTitle(); });
            btnWeek.addEventListener('click', () => { calendar.changeView('timeGridWeek'); setActive(btnWeek); syncTitle(); });
            btnDay.addEventListener('click', () => { calendar.changeView('timeGridDay'); setActive(btnDay); syncTitle(); });
            btnList.addEventListener('click', () => { calendar.changeView('listWeek'); setActive(btnList); syncTitle(); });

            document.getElementById('btnAdd').addEventListener('click', () => {
                document.getElementById('eventModalTitle').innerText = 'Add Event';
                form.setAttribute('action', '/Calendar/Create');
                document.getElementById('eventId').value = '';

                titleEl.value = '';
                locEl.value = '';

                allDayEl.checked = false;
                applyAllDayUI(false);

                const now = new Date();
                startLocalEl.value = toInputValue(now);
                endLocalEl.value = toInputValue(new Date(now.getTime() + 60 * 60 * 1000));

                const igHidden = document.getElementById('isGlobalHidden');
                if (igHidden) igHidden.value = 'false';
                if (isGlobalEl) isGlobalEl.checked = false;

                setReadOnlyMode(false);
                btnDelete.classList.add('d-none');

                bootstrap.Modal.getOrCreateInstance(document.getElementById('eventModal')).show();
            });

            btnDelete.addEventListener('click', async () => {
                const id = document.getElementById('eventId').value;
                if (!id) return;

                const confirmed = await showConfirmModal({
                    title: 'Delete Event',
                    message: 'Are you sure you want to delete this event? This action cannot be undone.'
                });
                if (!confirmed) return;

                const delForm = document.createElement('form');
                delForm.method = 'post';
                delForm.action = '/Calendar/Delete';
                delForm.innerHTML = `
                    <input name="id" value="${id}" type="hidden" />
                    ${document.querySelector('#eventForm input[name="__RequestVerificationToken"]').outerHTML}
                `;
                document.body.appendChild(delForm);
                delForm.submit();
            });

            form.addEventListener('submit', (e) => {
                if (btnSave.classList.contains('d-none')) {
                    e.preventDefault();
                    return false;
                }

                const isAllDay = allDayEl.checked;

                if (!isAllDay) {
                    // validate timed
                    const startVal = startLocalEl.value;
                    const endVal = endLocalEl.value;

                    if (startVal && endVal) {
                        const start = new Date(startVal);
                        const end = new Date(endVal);
                        if (end < start) {
                            e.preventDefault();
                            showMessageModal('Invalid time range', 'End time must be after Start time.');
                            return false;
                        }
                    }

                    document.getElementById('startUtc').value = toUtcISOString(startLocalEl.value);
                    document.getElementById('endUtc').value = toUtcISOString(endLocalEl.value);
                } else {
                    // validate all-day
                    const sDate = localStartDateEl.value;
                    const eDate = localEndDateEl.value || sDate;

                    if (!sDate) {
                        e.preventDefault();
                        showMessageModal('Missing date', 'Please select a Start Date for the all-day event.');
                        return false;
                    }

                    // build local midnight instants in browser timezone
                    const startLocalMidnight = new Date(`${sDate}T00:00:00`);
                    const endLocalMidnightExclusive = new Date(`${eDate}T00:00:00`);
                    endLocalMidnightExclusive.setDate(endLocalMidnightExclusive.getDate() + 1);

                    document.getElementById('startUtc').value = startLocalMidnight.toISOString();
                    document.getElementById('endUtc').value = endLocalMidnightExclusive.toISOString();
                }

                document.getElementById('isAllDayHidden').value = isAllDay ? 'true' : 'false';

                const igHidden = document.getElementById('isGlobalHidden');
                if (igHidden) igHidden.value = (isGlobalEl && isGlobalEl.checked) ? 'true' : 'false';
            });
        });
    </script>
}
