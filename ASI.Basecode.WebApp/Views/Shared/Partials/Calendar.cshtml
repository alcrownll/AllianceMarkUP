@using ASI.Basecode.Services.ServiceModels
@model CalendarViewModel
@{
    Layout = "~/Views/Shared/Layouts/_MainLayout.cshtml";
    ViewData["Title"] = "Calendar";
    var isAdmin = User.IsInRole("Admin");
}

@section Styles {
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/fullcalendar@6.1.10/main.min.css" />
    <link rel="stylesheet" href="~/css/calendar.css" />
}

<div class="calendar-page">
    <div class="calendar-toolbar">
        <div class="left-controls">
            <button id="btnPrev" class="btn btn-light icon-btn" title="Previous">‹</button>
            <button id="btnNext" class="btn btn-light icon-btn" title="Next">›</button>
            <button id="btnToday" class="btn btn-outline-secondary">Today</button>
            <h2 id="calTitle" class="calendar-title">Calendar</h2>
        </div>
        <div class="right-controls">
            <div class="btn-group me-2" role="group">
                <button id="btnMonth" class="btn btn-outline-secondary active">Month</button>
                <button id="btnWeek" class="btn btn-outline-secondary">Week</button>
                <button id="btnDay" class="btn btn-outline-secondary">Day</button>
                <button id="btnList" class="btn btn-outline-secondary">Agenda</button>
            </div>
            <button id="btnAdd" class="btn btn-primary">+ Add event</button>
        </div>
    </div>

    <div id="calendar"
         data-feed-url="/Calendar/Feed"
         data-is-admin="@(isAdmin ? "true" : "false")"></div>
</div>

<!-- Add/Edit/View Modal -->
<div class="modal fade" id="eventModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content rounded-3">
            <div class="modal-header">
                <h5 class="modal-title" id="eventModalTitle">Add Event</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>

            <form id="eventForm" asp-action="Create" asp-controller="Calendar" method="post">
                @Html.AntiForgeryToken()
                <input type="hidden" name="Id" id="eventId" />

                <!-- Hidden UTC fields the server binds to -->
                <input type="hidden" name="StartUtc" id="startUtc" />
                <input type="hidden" name="EndUtc" id="endUtc" />

                <!-- Hidden bools the server binds to (JS will set these) -->
                <input type="hidden" name="IsAllDay" id="isAllDayHidden" value="false" />
                @if (isAdmin)
                {
                    <input type="hidden" name="IsGlobal" id="isGlobalHidden" value="false" />
                }

                <div class="modal-body">
                    <div class="mb-3">
                        <label class="form-label">Title</label>
                        <input name="Title" id="title" class="form-control" maxlength="200" required />
                    </div>

                    <div class="row g-3">
                        <div class="col-6">
                            <label class="form-label">Start (local)</label>
                            <input type="datetime-local" id="startLocal" class="form-control" required />
                        </div>
                        <div class="col-6">
                            <label class="form-label">End (local)</label>
                            <input type="datetime-local" id="endLocal" class="form-control" required />
                        </div>
                    </div>

                    <!-- Display checkboxes WITHOUT name; JS mirrors state into hidden fields -->
                    <div class="form-check mt-2">
                        <input class="form-check-input" type="checkbox" id="allDay" />
                        <label class="form-check-label" for="allDay">All day</label>
                    </div>

                    <div class="mt-3">
                        <label class="form-label">Location</label>
                        <input name="Location" id="location" class="form-control" maxlength="200" />
                    </div>

                    @if (isAdmin)
                    {
                        <div class="form-check mt-3" id="isGlobalGroup">
                            <input class="form-check-input" type="checkbox" id="isGlobal" />
                            <label class="form-check-label" for="isGlobal">Make Global (visible to everyone)</label>
                        </div>
                    }
                </div>

                <div class="modal-footer justify-content-between">
                    <div>
                        <button type="button" id="btnDelete" class="btn btn-outline-danger d-none">Delete</button>
                    </div>
                    <div>
                        <button type="button" class="btn btn-light" data-bs-dismiss="modal">Close</button>
                        <button type="submit" class="btn btn-primary" id="btnSave">Save</button>
                    </div>
                </div>
            </form>
        </div>
    </div>
</div>

@section Scripts {
    <script src="https://cdn.jsdelivr.net/npm/fullcalendar@6.1.10/index.global.min.js"></script>
    <script>
        // Helpers
        function toUtcISOString(localValue) {
            if (!localValue) return "";
            const d = new Date(localValue);
            return new Date(Date.UTC(
                d.getFullYear(), d.getMonth(), d.getDate(),
                d.getHours(), d.getMinutes(), 0, 0
            )).toISOString();
        }
        function toInputValue(date) {
            if (!date) return "";
            const pad = (n) => (n < 10 ? "0" + n : n);
            const yr = date.getFullYear();
            const mo = pad(date.getMonth() + 1);
            const dy = pad(date.getDate());
            const hr = pad(date.getHours());
            const mi = pad(date.getMinutes());
            return `${yr}-${mo}-${dy}T${hr}:${mi}`;
        }

        document.addEventListener('DOMContentLoaded', () => {
            const calEl = document.getElementById('calendar');
            const feedUrl = calEl.dataset.feedUrl || '/Calendar/Feed';
            const isAdmin = calEl.dataset.isAdmin === 'true';

            // --- read-only toggle for modal ---
            const form = document.getElementById('eventForm');
            const titleEl = document.getElementById('title');
            const locEl = document.getElementById('location');
            const startLocalEl = document.getElementById('startLocal');
            const endLocalEl = document.getElementById('endLocal');
            const allDayEl = document.getElementById('allDay');
            const isGlobalEl = document.getElementById('isGlobal'); // may be null
            const btnSave = document.getElementById('btnSave');
            const btnDelete = document.getElementById('btnDelete');
            const isGlobalGroup = document.getElementById('isGlobalGroup');

            function setReadOnlyMode(ro) {
                // Disable inputs
                titleEl.disabled = ro;
                locEl.disabled = ro;
                startLocalEl.disabled = ro;
                endLocalEl.disabled = ro;
                allDayEl.disabled = ro;
                if (isGlobalEl) isGlobalEl.disabled = ro;

                // Hide/Show actions
                if (ro) {
                    btnSave.classList.add('d-none');
                    btnDelete.classList.add('d-none');
                } else {
                    btnSave.classList.remove('d-none');
                    // Delete shown only if server says canEdit in click handler
                }

                // For non-admin viewers, never show Global checkbox UI
                if (!isAdmin && isGlobalGroup) isGlobalGroup.classList.add('d-none');
                if (isAdmin && isGlobalGroup) isGlobalGroup.classList.remove('d-none');
            }

            const calendar = new FullCalendar.Calendar(calEl, {
                initialView: 'dayGridMonth',
                height: 'auto',
                timeZone: 'local',
                headerToolbar: false,
                selectable: true,
                dayMaxEvents: true,

                // Prevent drag/resize of non-editable events
                editable: true,
                eventStartEditable: (arg) => (arg.event.extendedProps?.canEdit === true),
                eventDurationEditable: (arg) => (arg.event.extendedProps?.canEdit === true),
                eventAllow: (dropInfo, draggedEvent) => draggedEvent.extendedProps?.canEdit === true,

                eventContent: (arg) => {
                    const ev = arg.event;
                    const x  = ev.extendedProps || {};
                    const root = document.createElement('div');
                    root.className = 'evt-card';

                    const title = document.createElement('div');
                    title.className = 'evt-title';
                    title.textContent = ev.title || '(Untitled)';

                    const row = document.createElement('div');
                    row.className = 'evt-row';

                    const hashKey = (x.category || x.calendarId || x.program || ev.id || ev.title || '');
                    let h = 0; for (let i = 0; i < hashKey.length; i++) h = (h * 31 + hashKey.charCodeAt(i)) | 0;
                    const idx = Math.abs(h) % 10;

                    const chip = document.createElement('span');
                    chip.className = 'evt-chip';
                    const fmt = (d) => d.toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' });
                    chip.innerHTML = `<span class="evt-dot evt-dot-${idx}"></span>${ev.allDay ? 'All day' : (ev.start ? (ev.end ? (fmt(ev.start) + ' – ' + fmt(ev.end)) : fmt(ev.start)) : '')}`;
                    row.appendChild(chip);

                    if (x.location) {
                        const loc = document.createElement('span');
                        loc.className = 'evt-chip';
                        loc.textContent = x.location;
                        row.appendChild(loc);
                    }

                    if (x.isGlobal) {
                        const pill = document.createElement('span');
                        pill.className = 'evt-pill';
                        pill.textContent = 'GLOBAL';
                        row.appendChild(pill);
                    }

                    root.appendChild(title);
                    root.appendChild(row);
                    return { domNodes: [root] };
                },

                select: (info) => {
                    document.getElementById('eventModalTitle').innerText = 'Add Event';
                    form.setAttribute('action', '/Calendar/Create');
                    document.getElementById('eventId').value = '';
                    titleEl.value = '';
                    locEl.value = '';
                    allDayEl.checked = info.allDay;
                    startLocalEl.value = toInputValue(info.start);
                    endLocalEl.value   = toInputValue(info.end || info.start);

                    // Reset hidden bools
                    document.getElementById('isAllDayHidden').value = allDayEl.checked ? 'true' : 'false';
                    const igHidden = document.getElementById('isGlobalHidden');
                    if (igHidden) igHidden.value = 'false';
                    if (isGlobalEl) isGlobalEl.checked = false;

                    // Add mode is always editable
                    setReadOnlyMode(false);
                    btnDelete.classList.add('d-none');

                    bootstrap.Modal.getOrCreateInstance(document.getElementById('eventModal')).show();
                },

                eventClick: (info) => {
                    const x = info.event.extendedProps || {};
                    document.getElementById('eventModalTitle').innerText = x.canEdit ? 'Edit Event' : 'View Event';
                    form.setAttribute('action', x.canEdit ? '/Calendar/Update' : '#');
                    document.getElementById('eventId').value = info.event.id;
                    titleEl.value = info.event.title || '';
                    locEl.value = x.location || '';
                    allDayEl.checked = info.event.allDay || false;
                    startLocalEl.value = toInputValue(info.event.start);
                    endLocalEl.value   = toInputValue(info.event.end || info.event.start);

                    // Mirror to hiddens now too (so read-only view shows accurate state if submitted accidentally)
                    document.getElementById('isAllDayHidden').value = allDayEl.checked ? 'true' : 'false';
                    const igHidden = document.getElementById('isGlobalHidden');
                    if (igHidden) igHidden.value = x.isGlobal ? 'true' : 'false';
                    if (isGlobalEl) isGlobalEl.checked = !!x.isGlobal;

                    if (x.canEdit) {
                        setReadOnlyMode(false);
                        btnDelete.classList.remove('d-none');
                    } else {
                        setReadOnlyMode(true);     // <- key line: view-only mode
                    }

                    bootstrap.Modal.getOrCreateInstance(document.getElementById('eventModal')).show();
                },

                events: (fetchInfo, success, failure) => {
                    const url = `${feedUrl}?start=${encodeURIComponent(fetchInfo.startStr)}&end=${encodeURIComponent(fetchInfo.endStr)}`;
                    fetch(url, { credentials: 'same-origin' })
                        .then(r => r.json())
                        .then(data => success(data))
                        .catch(err => failure(err));
                },

                eventClassNames: (arg) => {
                    const e = arg.event.extendedProps || {};
                    const key = e.category || e.calendarId || e.program || arg.event.id || arg.event.title || '';
                    let h = 0; for (let i = 0; i < key.length; i++) h = (h * 31 + key.charCodeAt(i)) | 0;
                    const idx = Math.abs(h) % 10;
                    const classes = ['evt-badge', `evt-color-${idx}`];
                    if (e.isGlobal) classes.push('evt-global');
                    return classes;
                },

                eventTimeFormat: { hour: '2-digit', minute: '2-digit', meridiem: true }
            });
            calendar.render();

            // toolbar actions
            document.getElementById('btnPrev').addEventListener('click', () => { calendar.prev(); syncTitle(); });
            document.getElementById('btnNext').addEventListener('click', () => { calendar.next(); syncTitle(); });
            document.getElementById('btnToday').addEventListener('click', () => { calendar.today(); syncTitle(); });
            const btnMonth = document.getElementById('btnMonth');
            const btnWeek  = document.getElementById('btnWeek');
            const btnDay   = document.getElementById('btnDay');
            const btnList  = document.getElementById('btnList');
            function setActive(btn){ [btnMonth, btnWeek, btnDay, btnList].forEach(b => b.classList.remove('active')); btn.classList.add('active'); }
            btnMonth.addEventListener('click', () => { calendar.changeView('dayGridMonth'); setActive(btnMonth); syncTitle(); });
            btnWeek .addEventListener('click', () => { calendar.changeView('timeGridWeek'); setActive(btnWeek ); syncTitle(); });
            btnDay  .addEventListener('click', () => { calendar.changeView('timeGridDay');  setActive(btnDay  ); syncTitle(); });
            btnList .addEventListener('click', () => { calendar.changeView('listWeek');     setActive(btnList ); syncTitle(); });
            function syncTitle(){ document.getElementById('calTitle').innerText = calendar.view.title; }
            syncTitle();

            // Add button
            document.getElementById('btnAdd').addEventListener('click', () => {
                document.getElementById('eventModalTitle').innerText = 'Add Event';
                form.setAttribute('action', '/Calendar/Create');
                document.getElementById('eventId').value = '';
                titleEl.value = '';
                locEl.value = '';
                allDayEl.checked = false;

                const now = new Date();
                startLocalEl.value = toInputValue(now);
                endLocalEl.value   = toInputValue(new Date(now.getTime() + 60*60*1000));

                // reset hiddens
                document.getElementById('isAllDayHidden').value = 'false';
                const igHidden = document.getElementById('isGlobalHidden');
                if (igHidden) igHidden.value = 'false';
                if (isGlobalEl) isGlobalEl.checked = false;

                setReadOnlyMode(false);
                btnDelete.classList.add('d-none');

                bootstrap.Modal.getOrCreateInstance(document.getElementById('eventModal')).show();
            });

            // Delete button (only appears when canEdit)
            btnDelete.addEventListener('click', () => {
                const id = document.getElementById('eventId').value;
                if (!id) return;
                if (!confirm('Delete this event?')) return;
                const delForm = document.createElement('form');
                delForm.method = 'post';
                delForm.action = '/Calendar/Delete';
                delForm.innerHTML = `
                    <input name="id" value="${id}" type="hidden" />
                    ${document.querySelector('#eventForm input[name="__RequestVerificationToken"]').outerHTML}
                `;
                document.body.appendChild(delForm);
                delForm.submit();
            });

            // Before submit: copy local -> UTC, and checkboxes -> hidden fields
            form.addEventListener('submit', (e) => {
                // If we’re in view-only mode (btnSave hidden), block submits
                if (btnSave.classList.contains('d-none')) {
                    e.preventDefault();
                    return false;
                }

                document.getElementById('startUtc').value = toUtcISOString(startLocalEl.value);
                document.getElementById('endUtc').value   = toUtcISOString(endLocalEl.value);

                document.getElementById('isAllDayHidden').value = allDayEl.checked ? 'true' : 'false';
                const igHidden = document.getElementById('isGlobalHidden');
                if (igHidden) igHidden.value = (isGlobalEl && isGlobalEl.checked) ? 'true' : 'false';
            });

            function syncTitle(){ document.getElementById('calTitle').innerText = calendar.view.title; }
        });
    </script>
}
