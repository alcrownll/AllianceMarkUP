@inject Microsoft.AspNetCore.Antiforgery.IAntiforgery Xsrf
@{
    var token = Xsrf.GetAndStoreTokens(Context).RequestToken;
}
<div class="modal fade" id="changePasswordModal" tabindex="-1" aria-labelledby="changePwLabel" aria-hidden="true" data-bs-backdrop="static" data-bs-keyboard="false">
    <div class="modal-dialog modal-dialog-centered modal-md">
        <div class="modal-content pwm">
            <form id="changePwForm" method="post" action="/Account/ChangePasswordAjax" autocomplete="off" novalidate>
                <input name="__RequestVerificationToken" type="hidden" value="@token" />

                <!-- Header -->
                <div class="modal-header border-0 pb-0">
                    <div>
                        <div class="pwm-eyebrow">SECURITY</div>
                        <h3 class="pwm-title" id="changePwLabel">Reset Password</h3>
                        <p class="pwm-sub">Create a new password for your account.</p>
                    </div>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>

                <div class="modal-body pt-2">
                    <div id="pwAlert" class="alert d-none" role="alert"></div>

                    <!-- Old Password -->
                    <div class="pwm-field">
                        <label class="pwm-label" for="oldPassword">Old Password</label>
                        <div class="pwm-inputwrap">
                            <i class="fa-solid fa-lock pwm-leading" aria-hidden="true"></i>
                            <input type="password" id="oldPassword" name="OldPassword" class="pwm-input form-control" required />
                            <button type="button" class="pwm-eye" data-target="oldPassword" aria-label="Show/Hide password">
                                <i class="fa-regular fa-eye"></i>
                            </button>
                        </div>
                        <div class="invalid-feedback d-block pwm-err" data-for="oldPassword"></div>
                    </div>

                    <!-- New Password -->
                    <div class="pwm-field">
                        <label class="pwm-label" for="newPassword">New Password</label>
                        <div class="pwm-inputwrap">
                            <i class="fa-solid fa-lock pwm-leading" aria-hidden="true"></i>
                            <input type="password" id="newPassword" name="NewPassword" class="pwm-input form-control" minlength="8" required />
                            <button type="button" class="pwm-eye" data-target="newPassword" aria-label="Show/Hide password">
                                <i class="fa-regular fa-eye"></i>
                            </button>
                        </div>

                        <!-- strength + helper -->
                        <div class="pwm-helper">
                            <small id="pwHint" class="text-success">Use at least 8 characters with a mix of letters, numbers, and symbols.</small>
                            <div class="pwm-meter">
                                <div id="pwMeterBar" class="pwm-meter-bar"></div>
                            </div>
                        </div>

                        <ul class="pwm-reqs" id="pwReqs" aria-live="polite">
                            <li data-rule="len">≥ 8 characters</li>
                            <li data-rule="mix">letters + numbers</li>
                            <li data-rule="sym">at least 1 symbol</li>
                        </ul>

                        <div class="invalid-feedback d-block pwm-err" data-for="newPassword"></div>
                    </div>

                    <!-- Confirm -->
                    <div class="pwm-field">
                        <label class="pwm-label" for="confirmPassword">Confirm New Password</label>
                        <div class="pwm-inputwrap">
                            <i class="fa-solid fa-lock pwm-leading" aria-hidden="true"></i>
                            <input type="password" id="confirmPassword" name="ConfirmPassword" class="pwm-input form-control" minlength="8" required />
                            <button type="button" class="pwm-eye" data-target="confirmPassword" aria-label="Show/Hide password">
                                <i class="fa-regular fa-eye"></i>
                            </button>
                        </div>
                        <div class="invalid-feedback d-block pwm-err" data-for="confirmPassword"></div>
                    </div>
                </div>

                <div class="modal-footer border-0 pt-0">
                    <button type="button" class="btn btn-outline-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="submit" id="btnSubmitPw" class="btn btn-primary pwm-submit" disabled>Update Password</button>
                </div>
            </form>
        </div>
    </div>
</div>

<script>
    (function(){
      if (window.__changePwBoundV2) return;
      window.__changePwBoundV2 = true;

      const form = document.getElementById('changePwForm');
      const btnSubmit = document.getElementById('btnSubmitPw');
      const alertBox = document.getElementById('pwAlert');
      const modalEl  = document.getElementById('changePasswordModal');

      const newPw    = document.getElementById('newPassword');
      const oldPw    = document.getElementById('oldPassword');
      const cfmPw    = document.getElementById('confirmPassword');

      const reqsList = document.getElementById('pwReqs');
      const meterBar = document.getElementById('pwMeterBar');
      const hint     = document.getElementById('pwHint');

      // Toggle eyes
      document.querySelectorAll('.pwm-eye').forEach(btn => {
        btn.addEventListener('click', () => {
          const id = btn.getAttribute('data-target');
          const input = document.getElementById(id);
          if (!input) return;
          input.type = input.type === 'password' ? 'text' : 'password';
          const icon = btn.querySelector('i');
          icon.classList.toggle('fa-eye');
          icon.classList.toggle('fa-eye-slash');
        });
      });

      function setMsg(forName, msg) {
        const el = document.querySelector('.pwm-err[data-for="'+forName+'"]');
        if (!el) return;
        el.textContent = msg || '';
      }

      function checkStrength(pw) {
        const hasLen = pw.length >= 8;
        const hasMix = /[A-Za-z]/.test(pw) && /\d/.test(pw);
        const hasSym = /[^A-Za-z0-9]/.test(pw);
        const score = (hasLen?1:0) + (hasMix?1:0) + (hasSym?1:0);

        // update checklist
        reqsList.querySelector('[data-rule="len"]')?.classList.toggle('ok', hasLen);
        reqsList.querySelector('[data-rule="mix"]')?.classList.toggle('ok', hasMix);
        reqsList.querySelector('[data-rule="sym"]')?.classList.toggle('ok', hasSym);

        // meter
        meterBar.style.width = (score/3*100) + '%';
        meterBar.dataset.level = String(score);

        // hint color/message
        if (score <= 1) {
          hint.classList.remove('text-success');
          hint.classList.add('text-danger');
          hint.textContent = 'Password is weak. Add length, numbers & symbols.';
        } else if (score === 2) {
          hint.classList.remove('text-danger');
          hint.classList.add('text-warning');
          hint.textContent = 'Almost there — add another type for better strength.';
        } else {
          hint.classList.remove('text-danger','text-warning');
          hint.classList.add('text-success');
          hint.textContent = 'Looks good! Strong password.';
        }
        return score === 3;
      }

      function validate() {
        let ok = true;
        // Old
        if (!oldPw.value.trim()) { setMsg('oldPassword','Please enter your current password.'); ok = false; } else setMsg('oldPassword','');

        // New
        const strong = checkStrength(newPw.value.trim());
        if (!newPw.value.trim()) { setMsg('newPassword','Please enter a new password.'); ok = false; }
        else if (!strong) { setMsg('newPassword','Make your password stronger to continue.'); ok = false; }
        else setMsg('newPassword','');

        // Confirm
        if (!cfmPw.value.trim()) { setMsg('confirmPassword','Please confirm your new password.'); ok = false; }
        else if (newPw.value !== cfmPw.value) { setMsg('confirmPassword','Passwords do not match.'); ok = false; }
        else setMsg('confirmPassword','');

        // New must differ from old
        if (oldPw.value && newPw.value && oldPw.value === newPw.value) {
          setMsg('newPassword','New password must be different from the old password.');
          ok = false;
        }

        btnSubmit.disabled = !ok;
        return ok;
      }

      [oldPw,newPw,cfmPw].forEach(i => i.addEventListener('input', validate));

      function showMsg(kind, msg){
        alertBox.className = 'alert alert-' + kind;
        alertBox.textContent = msg;
        alertBox.classList.remove('d-none');
      }
      function clearMsg(){
        alertBox.className = 'alert d-none';
        alertBox.textContent = '';
      }

      // Submit
        form?.addEventListener('submit', async (e) => {
        e.preventDefault();
        clearMsg();
        if (!validate()) return;

        btnSubmit.disabled = true;
        try {
          const fd = new FormData(form);
          const res = await fetch(form.action, { method: 'POST', body: fd, headers: { 'X-Requested-With': 'XMLHttpRequest' } });
          let data = null;
          const ct = res.headers.get('content-type') || '';
          if (ct.includes('application/json')) {
            data = await res.json();
          } else {
            const _ = await res.text();
            data = { ok: false, message: res.ok ? 'Unexpected server response.' : `Server error (${res.status}).` };
          }

          if (!res.ok || !data?.ok) {
            showMsg('danger', data?.message || 'Unable to change password.');
          } else {
            showMsg('success', 'New password is changed successfully.');
            setTimeout(() => {
              form.reset(); checkStrength(''); validate();
              const bsModal = bootstrap.Modal.getOrCreateInstance(modalEl); bsModal.hide();
              const host = document.querySelector('.profile-card') || document.body;
              const div = document.createElement('div'); div.className = 'alert alert-success mb-3'; div.textContent = 'Password updated.'; host.prepend(div);
              setTimeout(()=>div.remove(), 4000);
            }, 900);
          }
        } catch {
          showMsg('danger','Network error while changing password.');
        } finally {
          btnSubmit.disabled = false;
        }
      });

      // Reset state each time modal opens
      modalEl?.addEventListener('show.bs.modal', () => {
        form.reset();
        checkStrength('');
        validate();
        clearMsg();
      });
    })();
</script>
