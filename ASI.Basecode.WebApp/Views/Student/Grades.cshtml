@model ASI.Basecode.Services.ServiceModels.StudentGradesViewModel

@{
    Layout = "~/Views/Shared/Layouts/_MainLayout.cshtml";
    ViewData["Title"] = "Grades";
    ViewData["PageHeader"] = "Grades";
}

@section Styles {
    <link rel="stylesheet" href="~/css/student-grade.css" />
    <link rel="stylesheet" href="~/css/student-grade-print.css" />
}

@section Scripts {
    <script>
        function submitTermFilters() {
            const f = document.getElementById('termFilterForm');
            if (f) f.submit();
        }

        function printGrades() {
            window.print();
        }

        function onTermChanged(selectEl) {
            if (!selectEl) return;
            const val = selectEl.value || '';
            const parts = val.split('|||');

            const syInput = document.getElementById('schoolYearInput');
            const semInput = document.getElementById('semesterInput');

            if (syInput) syInput.value = parts[0] || '';
            if (semInput) semInput.value = parts[1] || '';

            submitTermFilters();
        }

        function applyGradeFilters() {
            const typeSel = document.getElementById('filterType');
            const remarksSel = document.getElementById('filterRemarks');

            const typeVal = typeSel ? typeSel.value.trim().toLowerCase() : '';
            const remarksVal = remarksSel ? remarksSel.value.trim().toUpperCase() : '';

            const rows = document.querySelectorAll('.grades-table tbody tr');

            rows.forEach(row => {
                const rowType = (row.getAttribute('data-type') || '').trim().toLowerCase();
                const rowRemarks = (row.getAttribute('data-remarks') || '').toUpperCase();

                let show = true;

                if (typeVal && rowType !== typeVal) show = false;
                if (remarksVal && !rowRemarks.includes(remarksVal)) show = false;

                row.style.display = show ? '' : 'none';
            });
        }

        document.addEventListener('DOMContentLoaded', function () {
            const typeSel = document.getElementById('filterType');
            const remarksSel = document.getElementById('filterRemarks');

            if (typeSel) typeSel.addEventListener('change', applyGradeFilters);
            if (remarksSel) remarksSel.addEventListener('change', applyGradeFilters);
        });
    </script>
}

<div class="grades-page">

    @if (Model?.Grades == null || !Model.Grades.Any())
    {
        <div class="empty-state">
            <h3>No grades available yet</h3>
            <p>Once grades are uploaded to the system, they will appear here.</p>
        </div>
    }
    else
    {
        <!-- ================= SCREEN VERSION ================= -->
        <div class="grades-card no-print">
            <div class="grades-toolbar">
                <div class="toolbar-left">
                    <span class="toolbar-label">Select School Term</span>
                    <form id="termFilterForm" method="get" class="term-inline">
                        <input type="hidden" id="schoolYearInput" name="schoolYear"
                               value="@(Model.SelectedSchoolYear ?? Model.SchoolYear)" />
                        <input type="hidden" id="semesterInput" name="semester"
                               value="@(Model.SelectedSemester ?? Model.Semester)" />

                        <label class="sr-only" for="selectTerm">School Term</label>
                        <select id="selectTerm" class="term-pill-select" onchange="onTermChanged(this)">
                            @if (Model.AvailableSchoolYears != null && Model.AvailableSemesters != null)
                            {
                                foreach (var sy in Model.AvailableSchoolYears)
                                {
                                    foreach (var sem in Model.AvailableSemesters)
                                    {
                                        var isSelected =
                                        string.Equals(Model.SelectedSchoolYear, sy, StringComparison.OrdinalIgnoreCase) &&
                                        string.Equals(Model.SelectedSemester, sem, StringComparison.OrdinalIgnoreCase);

                                        var value = $"{sy}|||{sem}";
                                        <option value="@value" selected="@(isSelected ? "selected" : null)">
                                            S.Y. @sy - @sem
                                        </option>
                                    }
                                }
                            }
                        </select>

                        <button type="button" class="iconbtn" title="Print Grades" onclick="printGrades()">
                            <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" aria-hidden="true" focusable="false">
                                <path d="M6 9V3h12v6M6 17v4h12v-4M6 9h12m-1 4h2a2 2 0 0 0 2-2v-1a2 2 0 0 0-2-2H5a2 2 0 0 0-2 2v1a2 2 0 0 0 2 2h2"
                                      fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" />
                            </svg>
                            <span class="sr-only">Print</span>
                        </button>
                    </form>
                </div>
            </div>

            <div class="info-grid">
                <div class="info-left">
                    <div class="info-line"><small>Name :</small><b>@Model.StudentName</b></div>
                    <div class="info-line"><small>Program :</small><b>@Model.Program</b></div>
                    <div class="info-line"><small>Year Level :</small><b>@Model.YearLevel</b></div>
                </div>
                <div class="info-right">
                    <div class="info-line"><small>School Year :</small><b>@(string.IsNullOrWhiteSpace(Model.SelectedSchoolYear) ? Model.SchoolYear : Model.SelectedSchoolYear)</b></div>
                    <div class="info-line"><small>Semester :</small><b>@(Model.SelectedSemester ?? Model.Semester)</b></div>
                    <div class="info-line"><small>Section :</small><b>@(Model.Section ?? "—")</b></div>
                </div>
            </div>

            <div class="grades-table-wrapper">
                <table class="grades-table">
                    <thead>
                        <tr>
                            <th>Subject</th>
                            <th>Description</th>
                            <th>Instructor</th>
                            <th>
                                <select id="filterType" class="filter-header-select">
                                    <option value="">TYPE</option>
                                    <option value="lecture">Lecture</option>
                                    <option value="laboratory">Laboratory</option>
                                </select>
                            </th>
                            <th>Units</th>
                            <th>Prelim</th>
                            <th>Midterm</th>
                            <th>Semi-Final</th>
                            <th>Final</th>
                            <th>
                                <select id="filterRemarks" class="filter-header-select">
                                    <option value="">REMARKS</option>
                                    <option value="PASS">Passed</option>
                                    <option value="INCOMPLETE">Incomplete</option>
                                    <option value="FAIL">Failed</option>
                                </select>
                            </th>
                        </tr>
                    </thead>
                    <tbody>
                        @foreach (var item in Model.Grades)
                        {
                            var normalizedRemarks = (item.Remarks ?? "").Trim().ToUpper();
                            var isPassed = normalizedRemarks.Contains("PASS");

                            <tr data-type="@item.Type" data-remarks="@normalizedRemarks">
                                <td>@item.SubjectCode</td>
                                <td>@item.Description</td>
                                <td>@item.Instructor</td>
                                <td>@item.Type</td>
                                <td>@item.Units</td>
                                <td>@(item.Prelims?.ToString("0.0") ?? "—")</td>
                                <td>@(item.Midterm?.ToString("0.0") ?? "—")</td>
                                <td>@(item.SemiFinal?.ToString("0.0") ?? "—")</td>
                                <td>@(item.Final?.ToString("0.0") ?? "—")</td>
                                <td class="@(isPassed ? "remarks-pass" : "remarks-fail")">@normalizedRemarks</td>
                            </tr>
                        }
                    </tbody>
                </table>
            </div>

            @if (Model.Gpa.HasValue)
            {
                <div class="gpa-summary no-print">
                    <span><strong>GPA:</strong> @Model.Gpa.Value.ToString("0.00")</span>
                </div>
            }
        </div>
        <!-- ================= /SCREEN VERSION ================= -->

        <!-- ================= PRINT VERSION ================= -->
        <div id="gradesPrintArea" class="print-sheet only-print">
            <div class="sheet-header">
                <div class="logo-container"><img src="~/img/uc-logo.png" alt="University of Cebu" class="logo-center" /></div>
                <div class="header-text">
                    <div class="u-name">UNIVERSITY OF CEBU LAPU-LAPU AND MANDAUE</div>
                    <div>A.C. Cortes Avenue,<br />Mandaue City, Philippines</div>
                    <div>Website: uclm.edu.ph</div>
                    <div>Email: lm@uc.edu.ph</div>
                </div>
            </div>

            <div class="title">GRADES</div>
            <div class="sub-title">
                @(Model.SelectedSemester ?? Model.Semester),
                S.Y. @(string.IsNullOrWhiteSpace(Model.SelectedSchoolYear) ? Model.SchoolYear : Model.SelectedSchoolYear)
            </div>
            <div class="prog">@Model.Program</div>

            <div class="info-grid">
                <div class="lbl">Name</div><div class="val">: @Model.StudentName</div>
                <div class="lbl">School Year</div><div class="val">: @(string.IsNullOrWhiteSpace(Model.SelectedSchoolYear) ? Model.SchoolYear : Model.SelectedSchoolYear)</div>
                <div class="lbl">Semester</div><div class="val">: @(Model.SelectedSemester ?? Model.Semester)</div>
                <div class="lbl">Year Level</div><div class="val">: @Model.YearLevel</div>
                <div class="lbl">GPA</div><div class="val">: @(Model.Gpa?.ToString("0.00") ?? "—")</div>
            </div>

            <hr class="sep" />

            <table class="grid">
                <colgroup>
                    <col style="width:7%">   
                    <col style="width:20%"> 
                    <col style="width:14%"> 
                    <col style="width:8.5%"> 
                    <col style="width:6%">  
                    <col style="width:7%">  
                    <col style="width:7%">  
                    <col style="width:7%"> 
                    <col style="width:7%">   
                    <col style="width:11%">   
                </colgroup>
                <thead>
                    <tr>
                        <th>Subject</th>
                        <th>Description</th>
                        <th>Instructor</th>
                        <th>Type</th>
                        <th>Units</th>
                        <th>Prelim</th>
                        <th>Midterm</th>
                        <th>Semi</th>
                        <th>Final</th>
                        <th>Remarks</th>
                    </tr>
                </thead>
                <tbody>
                    @if (Model.Grades?.Any() == true)
                    {
                        foreach (var item in Model.Grades)
                        {
                            var isPassed = !string.IsNullOrWhiteSpace(item.Remarks) &&
                            item.Remarks.ToUpper().Contains("PASS");
                            <tr>
                                <td>@item.SubjectCode</td>
                                <td>@item.Description</td>
                                <td>@item.Instructor</td>
                                <td>@item.Type</td>
                                <td>@item.Units</td>
                                <td>@(item.Prelims?.ToString("0.0") ?? "—")</td>
                                <td>@(item.Midterm?.ToString("0.0") ?? "—")</td>
                                <td>@(item.SemiFinal?.ToString("0.0") ?? "—")</td>
                                <td>@(item.Final?.ToString("0.0") ?? "—")</td>
                                <td class="@(isPassed ? "remarks-pass" : "remarks-fail")">@((item.Remarks ?? "").ToUpper())</td>
                            </tr>
                        }
                    }
                    else
                    {
                        <tr><td colspan="10" class="no-rows">No grades found.</td></tr>
                    }
                </tbody>
            </table>

            <div class="footer-row">
                <span><strong>Total Units:</strong> @Model.Grades.Sum(g => g.Units)</span>
            </div>

            <div class="watermark">OFFICIAL</div>
        </div>
        <!-- ================= /PRINT VERSION ================= -->
    }
</div>
