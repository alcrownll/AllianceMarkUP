@model ASI.Basecode.WebApp.Models.StudentDashboardViewModel

@{
    Layout = "~/Views/Shared/Layouts/_MainLayout.cshtml";
    ViewData["Title"] = "Student Dashboard";
    ViewData["PageHeader"] = "Student Dashboard";

    var gwa = Model.CumulativeGwa ?? 0m;      // 1.00–5.00 (1.00 best)
    var gwaMax = Model.GwaScaleMax;           // 5.00
    var gwaBest = Model.GwaBest;              // 1.00
    // Fill percent for donut: 1.00 -> 100% fill, 5.00 -> 0% fill
    var fill = (double)Math.Max(0m, Math.Min(1m, (gwaMax - gwa) / (gwaMax - gwaBest)));
}

@section Styles {
    <link rel="stylesheet" href="~/css/student-dashboard.css" />
}

<div class="dash-wrap grid">
    <!-- KPI row -->
    <div class="grid kpis">
        <!-- Cumulative GWA -->
        <div class="card kpi">
            <div class="kpi-body">
                <h4>Cumulative GWA</h4>
                <div class="value">@((Model.CumulativeGwa?.ToString("0.00")) ?? "—")</div>
                <div class="meta">
                    @if (Model.IsDeanListEligible)
                    {
                        <span>Eligible for <span class="badge">Dean’s List</span></span>
                    }
                    else
                    {
                        <span>Keep pushing! 💪</span>
                    }
                </div>
            </div>
            <div class="icon">🎓</div>
        </div>

        <!-- Year and Program -->
        <div class="card kpi">
            <div class="kpi-body">
                <h4>Year and Program</h4>
                <div class="value">@Model.YearLevel - @Model.Program</div>
                <div class="meta">@Model.CurrentSemesterName @Model.CurrentSchoolYear</div>
            </div>
            <div class="icon">🧩</div>
        </div>

        <!-- Semester Units -->
        <div class="card kpi">
            <div class="kpi-body">
                <h4>Semester Units</h4>
                <div class="value">@Model.CurrentTermUnits</div>
                <div class="meta">
                    @(Model.CurrentTermUnits <= 15 ? "Light Course Load"
                                        : Model.CurrentTermUnits <= 21 ? "Regular Load"
                                        : "Overload")
                </div>
            </div>
            <div class="icon">📄</div>
        </div>
    </div>

    <!-- Academic Highlights -->
    <div class="card p24 grid hi">
        <div>
            <div class="hi-title">Academic Highlights</div>

            <div class="hi-inner">
                <!-- Donut -->
                <div class="ring-wrap">
                    <canvas id="gpaRing" class="ring-canvas"
                            data-gwa="@gwa"
                            data-fill="@fill"></canvas>
                    <div class="ring-legend">
                        <div>Best GWA: 1.00</div>
                        <div>Scale: 1.00–5.00</div>
                    </div>
                </div>

                <!-- Dynamic line -->
                <div class="chart-col">
                    <div class="tabs">
                        <div class="tab active" id="tabSem1">@Model.Sem1Label</div>
                        <div class="tab" id="tabSem2">@Model.Sem2Label</div>
                    </div>
                    <div class="chart-area">
                        <canvas id="termLine"
                                data-sem1='@Newtonsoft.Json.JsonConvert.SerializeObject(Model.Sem1Series ?? new decimal?[] { })'
                                data-sem2='@Newtonsoft.Json.JsonConvert.SerializeObject(Model.Sem2Series ?? new decimal?[] { })'>
                        </canvas>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Removed: Announcements / Student Life panels -->
</div>

@section Scripts {
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script>
        // ---------- Donut: Cumulative GWA (1 is best) ----------
        const ring = document.getElementById('gpaRing');
        const gwa = parseFloat(ring.dataset.gwa || '0');   // 1.00–5.00
        const fill = parseFloat(ring.dataset.fill || '0'); // 0–1 (more fill = better)

        new Chart(ring, {
            type: 'doughnut',
            data: {
                datasets: [{
                    data: [fill, 1 - fill],
                    borderWidth: 0,
                    backgroundColor: ['#2563eb', '#e8eef7'],
                    cutout: '78%'
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: true,
                aspectRatio: 1,
                plugins: { legend: { display: false }, tooltip: { enabled: false } }
            },
            plugins: [{
                id: 'centerText',
                afterDraw(chart) {
                    const { ctx, chartArea } = chart;
                    const cx = (chartArea.left + chartArea.right) / 2;
                    const cy = (chartArea.top + chartArea.bottom) / 2;
                    ctx.save();
                    ctx.font = '700 44px Inter, system-ui';
                    ctx.fillStyle = '#2563eb';
                    ctx.textAlign = 'center';
                    ctx.textBaseline = 'middle';
                    ctx.fillText(isNaN(gwa) || gwa === 0 ? '—' : gwa.toFixed(2), cx, cy - 12);
                    ctx.font = '12px Inter, system-ui';
                    ctx.fillStyle = '#6b7280';
                    ctx.fillText('Cumulative GWA', cx, cy + 18);
                    ctx.restore();
                }
            }]
        });

        // ---------- Line chart (dynamic from server) ----------
        const ctxLine = document.getElementById('termLine');
        let line;
        const sem1 = JSON.parse(ctxLine.dataset.sem1 || '[]');
        const sem2 = JSON.parse(ctxLine.dataset.sem2 || '[]');

        function drawLine(arr) {
            if (line) line.destroy();
            // Fallback to zeros for missing items to keep 4 points
            const data = [...Array(4)].map((_, i) => (arr && arr[i] != null) ? arr[i] : null);

            line = new Chart(ctxLine, {
                type: 'line',
                data: {
                    labels: ['Prelims','Midterms','SemiFinals','Finals'],
                    datasets: [{
                        data,
                        tension:.35,
                        pointRadius:4,
                        pointHoverRadius:5,
                        borderWidth:2,
                        fill:false,
                        borderColor:'#2563eb',
                        backgroundColor:'#2563eb'
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    layout: { padding: { right: 12 } },
                    scales: {
                        y: {
                            min: 1, max: 5, reverse: true,
                            grid: { color: '#eef2f7' },
                            ticks: { stepSize: .5, color: '#64748b', font: { size: 11 } }
                        },
                        x: {
                            grid: { display: false },
                            ticks: { color: '#64748b', font: { size: 11 } }
                        }
                    },
                    plugins: { legend: { display: false } }
                }
            });
        }
        drawLine(sem1);

        const t1 = document.getElementById('tabSem1');
        const t2 = document.getElementById('tabSem2');

        function activate(el, other, data) {
            el.classList.add('active');
            other.classList.remove('active');
            drawLine(data);
        }

        t1.addEventListener('click', () => activate(t1, t2, sem1));
        t2.addEventListener('click', () => activate(t2, t1, sem2));
    </script>
}
